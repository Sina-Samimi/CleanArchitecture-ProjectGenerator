@using LogsDtoCloneTest.WebSite.Areas.Admin.Models
@model BlogAuthorsViewModel
@{
    var authors = Model.Authors?.ToList() ?? new List<BlogAuthorListItemViewModel>();
    var userOptions = Model.UserOptions?.ToList() ?? new List<BlogAuthorUserOptionViewModel>();
    var totalCount = Model.TotalCount;
    var activeCount = Model.ActiveCount;
    var inactiveCount = Model.InactiveCount;

    string FormatDate(DateTimeOffset value) => value.ToPersianDateTimeString();
}

@section Head {
    <link rel="stylesheet" href="~/css/admin/blog.css" asp-append-version="true" />
}

@section Breadcrumb {
    <li class="breadcrumb-item"><a asp-area="Admin" asp-controller="Dashboard" asp-action="Index">داشبورد</a></li>
    <li class="breadcrumb-item"><a asp-area="Admin" asp-controller="Blog" asp-action="Index">وبلاگ</a></li>
    <li class="breadcrumb-item active" aria-current="page">مدیریت نویسندگان</li>
}

@await Html.PartialAsync("_StatusMessage")

<div class="blog-authors-page">
    <div class="blog-authors-page__hero">
        <div>
            <h1 class="blog-authors-page__title">مدیریت نویسندگان وبلاگ</h1>
            <p class="blog-authors-page__subtitle">افزودن، ویرایش و اتصال نویسندگان به کاربران سیستم</p>
        </div>
        <div class="blog-authors-page__actions">
            <a class="btn btn-outline-primary" asp-area="Admin" asp-controller="Blog" asp-action="Categories">
                <i class="bi bi-diagram-3 me-1"></i>
                مدیریت دسته‌بندی‌ها
            </a>
            <button type="button"
                    class="btn btn-primary"
                    data-bs-toggle="modal"
                    data-bs-target="#createAuthorModal">
                <i class="bi bi-plus-lg me-1"></i>
                نویسنده جدید
            </button>
        </div>
    </div>

    <div class="blog-author-overview">
        <div class="blog-author-overview__card blog-author-overview__card--primary">
            <div class="blog-author-overview__icon">
                <span class="badge bg-primary-subtle text-primary"><i class="bi bi-people"></i></span>
            </div>
            <div class="blog-author-overview__content">
                <span class="blog-author-overview__label">کل نویسندگان</span>
                <span class="blog-author-overview__value">@totalCount</span>
                <span class="blog-author-overview__hint">تمام نویسندگان ثبت شده</span>
            </div>
        </div>
        <div class="blog-author-overview__card blog-author-overview__card--success">
            <div class="blog-author-overview__icon">
                <span class="badge bg-success-subtle text-success"><i class="bi bi-check-circle"></i></span>
            </div>
            <div class="blog-author-overview__content">
                <span class="blog-author-overview__label">فعال</span>
                <span class="blog-author-overview__value">@activeCount</span>
                <span class="blog-author-overview__hint">قابل انتخاب در فرم بلاگ</span>
            </div>
        </div>
        <div class="blog-author-overview__card blog-author-overview__card--warning">
            <div class="blog-author-overview__icon">
                <span class="badge bg-warning-subtle text-warning"><i class="bi bi-pause-circle"></i></span>
            </div>
            <div class="blog-author-overview__content">
                <span class="blog-author-overview__label">غیرفعال</span>
                <span class="blog-author-overview__value">@inactiveCount</span>
                <span class="blog-author-overview__hint">در دسترس برای بلاگ نیستند</span>
            </div>
        </div>
    </div>

    <div class="blog-author-table card">
        <div class="card-body">
            <div class="blog-author-table__header">
                <div>
                    <h2 class="blog-author-table__title">لیست نویسندگان</h2>
                    <p class="blog-author-table__subtitle">@totalCount نویسنده در سیستم ثبت شده است.</p>
                </div>
            </div>

            @if (authors.Count == 0)
            {
                <div class="blog-author-table__empty">
                    <i class="bi bi-journal-text"></i>
                    <h3>هنوز نویسنده‌ای ثبت نشده است</h3>
                    <p>برای افزودن نویسنده جدید، دکمه «نویسنده جدید» را فشار دهید و یا یکی از کاربران را انتخاب کنید.</p>
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-hover align-middle blog-author-table__grid">
                        <thead>
                            <tr>
                                <th scope="col">نویسنده</th>
                                <th scope="col">کاربر سیستم</th>
                                <th scope="col">وضعیت</th>
                                <th scope="col">به‌روزرسانی</th>
                                <th scope="col" class="text-center">عملیات</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var author in authors)
                            {
                                var statusClass = author.IsActive
                                    ? "badge bg-success-subtle text-success"
                                    : "badge bg-secondary-subtle text-secondary";
                                <tr>
                                    <td>
                                        <div class="blog-author-table__name">
                                            <strong>@author.DisplayName</strong>
                                            @if (!string.IsNullOrWhiteSpace(author.Bio))
                                            {
                                                <p class="blog-author-table__bio">@author.Bio</p>
                                            }
                                            @if (!string.IsNullOrWhiteSpace(author.AvatarUrl))
                                            {
                                                <a class="blog-author-table__avatar-link" href="@author.AvatarUrl" target="_blank" rel="noopener">
                                                    <i class="bi bi-link-45deg"></i>
                                                    تصویر معرفی
                                                </a>
                                            }
                                        </div>
                                    </td>
                                    <td>
                                        <div class="blog-author-table__user">
                                            @if (!string.IsNullOrWhiteSpace(author.UserFullName))
                                            {
                                                <span class="blog-author-table__user-name">@author.UserFullName</span>
                                                <div class="blog-author-table__user-meta">
                                                    @if (!string.IsNullOrWhiteSpace(author.UserEmail))
                                                    {
                                                        <span><i class="bi bi-envelope"></i>@author.UserEmail</span>
                                                    }
                                                    @if (!string.IsNullOrWhiteSpace(author.UserPhoneNumber))
                                                    {
                                                        <span><i class="bi bi-telephone"></i>@author.UserPhoneNumber</span>
                                                    }
                                                </div>
                                            }
                                            else
                                            {
                                                <span class="text-muted">بدون اتصال</span>
                                            }
                                        </div>
                                    </td>
                                    <td>
                                        <span class="@statusClass">@(author.IsActive ? "فعال" : "غیرفعال")</span>
                                    </td>
                                    <td>
                                        <div class="blog-author-table__timestamps">
                                            <span>ویرایش: @FormatDate(author.UpdatedAt)</span>
                                            <span>ایجاد: @FormatDate(author.CreatedAt)</span>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="blog-author-table__actions">
                                            <button type="button"
                                                    class="btn btn-sm btn-outline-primary"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#editAuthorModal"
                                                    data-author-id="@author.Id"
                                                    data-author-name="@author.DisplayName"
                                                    data-author-bio="@author.Bio"
                                                    data-author-avatar="@author.AvatarUrl"
                                                    data-author-active="@author.IsActive.ToString().ToLowerInvariant()"
                                                    data-author-user-id="@author.UserId"
                                                    data-author-user-name="@author.UserFullName"
                                                    data-author-user-email="@author.UserEmail"
                                                    data-author-user-phone="@author.UserPhoneNumber">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button type="button"
                                                    class="btn btn-sm btn-outline-danger"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#deleteAuthorModal"
                                                    data-author-id="@author.Id"
                                                    data-author-name="@author.DisplayName">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
</div>

<div class="modal fade" id="createAuthorModal" tabindex="-1" aria-labelledby="createAuthorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="post" asp-area="Admin" asp-controller="Blog" asp-action="CreateAuthor">
                @Html.AntiForgeryToken()
                <div class="modal-header">
                    <h5 class="modal-title" id="createAuthorModalLabel">افزودن نویسنده</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="بستن"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label" for="createAuthorUser">انتخاب کاربر</label>
                            <select class="form-select" id="createAuthorUser" name="UserId" data-author-user-select>
                                <option value="">بدون اتصال کاربر</option>
                                @foreach (var option in userOptions)
                                {
                                    var optionText = string.IsNullOrWhiteSpace(option.Email) && string.IsNullOrWhiteSpace(option.PhoneNumber)
                                        ? option.DisplayName
                                        : $"{option.DisplayName} ({string.Join("، ", new[]{option.Email, option.PhoneNumber}.Where(x => !string.IsNullOrWhiteSpace(x)))})";
                                    <option value="@option.UserId"
                                            data-user-name="@option.DisplayName"
                                            data-user-email="@option.Email"
                                            data-user-phone="@option.PhoneNumber"
                                            data-user-assigned="@option.IsAssigned.ToString().ToLowerInvariant()">
                                        @optionText
                                    </option>
                                }
                            </select>
                            <div class="form-text">در صورت انتخاب کاربر، نام و اطلاعات وی به نویسنده متصل می‌شود.</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" for="createAuthorName">نام نمایشی</label>
                            <input type="text" class="form-control" id="createAuthorName" name="DisplayName" maxlength="200" required />
                        </div>
                        <div class="col-12">
                            <label class="form-label" for="createAuthorBio">معرفی کوتاه</label>
                            <textarea class="form-control" id="createAuthorBio" name="Bio" maxlength="1000" rows="3" placeholder="اختیاری"></textarea>
                        </div>
                        <div class="col-md-8">
                            <label class="form-label" for="createAuthorAvatar">آدرس تصویر</label>
                            <input type="url" class="form-control" id="createAuthorAvatar" name="AvatarUrl" maxlength="500" placeholder="اختیاری" />
                            <div class="form-text">آدرس کامل تصویر نویسنده (در صورت موجود بودن).</div>
                        </div>
                        <div class="col-md-4 d-flex align-items-center">
                            <div class="form-check form-switch mt-4">
                                <input class="form-check-input" type="checkbox" id="createAuthorActive" name="IsActive" value="true" checked />
                                <input type="hidden" name="IsActive" value="false" />
                                <label class="form-check-label" for="createAuthorActive">فعال باشد</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">انصراف</button>
                    <button type="submit" class="btn btn-primary">افزودن نویسنده</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="editAuthorModal" tabindex="-1" aria-labelledby="editAuthorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="post" asp-area="Admin" asp-controller="Blog" asp-action="UpdateAuthor">
                @Html.AntiForgeryToken()
                <input type="hidden" name="Id" value="" />
                <div class="modal-header">
                    <h5 class="modal-title" id="editAuthorModalLabel">ویرایش نویسنده</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="بستن"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label" for="editAuthorUser">انتخاب کاربر</label>
                            <select class="form-select" id="editAuthorUser" name="UserId" data-author-user-select>
                                <option value="">بدون اتصال کاربر</option>
                                @foreach (var option in userOptions)
                                {
                                    var optionText = string.IsNullOrWhiteSpace(option.Email) && string.IsNullOrWhiteSpace(option.PhoneNumber)
                                        ? option.DisplayName
                                        : $"{option.DisplayName} ({string.Join("، ", new[]{option.Email, option.PhoneNumber}.Where(x => !string.IsNullOrWhiteSpace(x)))})";
                                    <option value="@option.UserId"
                                            data-user-name="@option.DisplayName"
                                            data-user-email="@option.Email"
                                            data-user-phone="@option.PhoneNumber"
                                            data-user-assigned="@option.IsAssigned.ToString().ToLowerInvariant()">
                                        @optionText
                                    </option>
                                }
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" for="editAuthorName">نام نمایشی</label>
                            <input type="text" class="form-control" id="editAuthorName" name="DisplayName" maxlength="200" required />
                        </div>
                        <div class="col-12">
                            <label class="form-label" for="editAuthorBio">معرفی کوتاه</label>
                            <textarea class="form-control" id="editAuthorBio" name="Bio" maxlength="1000" rows="3" placeholder="اختیاری"></textarea>
                        </div>
                        <div class="col-md-8">
                            <label class="form-label" for="editAuthorAvatar">آدرس تصویر</label>
                            <input type="url" class="form-control" id="editAuthorAvatar" name="AvatarUrl" maxlength="500" placeholder="اختیاری" />
                        </div>
                        <div class="col-md-4 d-flex align-items-center">
                            <div class="form-check form-switch mt-4">
                                <input class="form-check-input" type="checkbox" id="editAuthorActive" name="IsActive" value="true" />
                                <input type="hidden" name="IsActive" value="false" />
                                <label class="form-check-label" for="editAuthorActive">فعال باشد</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">انصراف</button>
                    <button type="submit" class="btn btn-primary">ذخیره تغییرات</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteAuthorModal" tabindex="-1" aria-labelledby="deleteAuthorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteAuthorModalLabel">حذف نویسنده</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="بستن"></button>
            </div>
            <div class="modal-body">
                <p>آیا از حذف نویسنده <strong data-author-delete-name></strong> مطمئن هستید؟</p>
                <p class="text-muted mb-0">در صورت وجود بلاگ مرتبط، ابتدا باید نویسنده‌ی بلاگ را تغییر دهید.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">انصراف</button>
                <form method="post" asp-area="Admin" asp-controller="Blog" asp-action="DeleteAuthor" data-author-delete-form>
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="id" value="" />
                    <button type="submit" class="btn btn-danger">بله، حذف شود</button>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/admin/blog-authors.js" asp-append-version="true"></script>
}
