@using LogsDtoCloneTest.WebSite.Areas.Admin.Models
@using LogsDtoCloneTest.Domain.Enums
@model SeoMetadataFormViewModel
@{
    var isEdit = Model.Id.HasValue;
    var formAction = isEdit ? "Edit" : "Create";
}

@section Head {
    <link rel="stylesheet" href="~/css/admin/blog-form.css" asp-append-version="true" />
}

@await Html.PartialAsync("_StatusMessage")

<form asp-action="@formAction" asp-route-id="@(isEdit ? Model.Id : null)" method="post" enctype="multipart/form-data" class="card" data-seo-form>
    @Html.AntiForgeryToken()
    <div class="card-body">
        <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>
        
        <div class="row g-4">
            <div class="col-lg-8">
                <h5 class="mb-3">اطلاعات پایه</h5>
                <div class="mb-3">
                    <label asp-for="PageType" class="form-label">نوع صفحه</label>
                    <select asp-for="PageType" class="form-select" asp-items="Model.Selections?.PageTypes"></select>
                    <span asp-validation-for="PageType" class="text-danger"></span>
                </div>
                <div class="mb-3">
                    <label asp-for="PageIdentifier" class="form-label">شناسه صفحه (Slug/Id)</label>
                    <input asp-for="PageIdentifier" class="form-control" placeholder="برای صفحات عمومی خالی بگذارید" />
                    <div class="form-text">برای صفحات خاص مثل محصولات، اسلاگ محصول را وارد کنید. برای صفحات عمومی مثل صفحه اصلی، خالی بگذارید.</div>
                    <span asp-validation-for="PageIdentifier" class="text-danger"></span>
                </div>

                <h5 class="mb-3 mt-4">نوع SEO</h5>
                <div class="mb-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" asp-for="UseTemplate" id="useTemplate" />
                        <label class="form-check-label" for="useTemplate">استفاده از Template (داینامیک)</label>
                    </div>
                    <div class="form-text">اگر فعال باشد، از Template استفاده می‌شود و بر اساس متغیرها render می‌شود</div>
                </div>

                <div id="templateSection" style="display: @(Model.UseTemplate ? "block" : "none");">
                    <h5 class="mb-3 mt-4">Template SEO</h5>
                    <div class="mb-3">
                        <label asp-for="TitleTemplate" class="form-label">Template عنوان</label>
                        <textarea asp-for="TitleTemplate" class="form-control" rows="2" placeholder='مثال: "15 تا از بهترین {category} ها در {province} {city} | {siteName} | {month} {year}"'></textarea>
                        <div class="form-text">از متغیرهای {category}, {search}, {siteName}, {month}, {year}, {domain} و ... استفاده کنید</div>
                        <span asp-validation-for="TitleTemplate" class="text-danger"></span>
                    </div>
                    <div class="mb-3">
                        <label asp-for="DescriptionTemplate" class="form-label">Template توضیحات</label>
                        <textarea asp-for="DescriptionTemplate" class="form-control" rows="3" placeholder='مثال: "{category} در {city} {province} | لیست 15 تا از بهترین..."'></textarea>
                        <span asp-validation-for="DescriptionTemplate" class="text-danger"></span>
                    </div>
                    <div class="mb-3">
                        <label asp-for="OgTitleTemplate" class="form-label">Template OG Title</label>
                        <textarea asp-for="OgTitleTemplate" class="form-control" rows="2"></textarea>
                        <span asp-validation-for="OgTitleTemplate" class="text-danger"></span>
                    </div>
                    <div class="mb-3">
                        <label asp-for="OgDescriptionTemplate" class="form-label">Template OG Description</label>
                        <textarea asp-for="OgDescriptionTemplate" class="form-control" rows="3"></textarea>
                        <span asp-validation-for="OgDescriptionTemplate" class="text-danger"></span>
                    </div>
                    <div class="mb-3">
                        <label asp-for="RobotsTemplate" class="form-label">Template Robots</label>
                        <input asp-for="RobotsTemplate" class="form-control" placeholder='مثال: "{isIndex ? 'index,follow' : 'noindex,follow'}"' />
                        <div class="form-text">از متغیرهای boolean مثل {isIndex}, {hasResults} استفاده کنید</div>
                        <span asp-validation-for="RobotsTemplate" class="text-danger"></span>
                    </div>
                </div>

                <div id="staticSection" style="display: @(Model.UseTemplate ? "none" : "block");">
                    <h5 class="mb-3 mt-4">Meta Tags (Static)</h5>
                    <div class="mb-3">
                        <label asp-for="MetaTitle" class="form-label">عنوان SEO</label>
                        <input asp-for="MetaTitle" class="form-control" placeholder="عنوان SEO" />
                        <span asp-validation-for="MetaTitle" class="text-danger"></span>
                    </div>
                <div class="mb-3">
                    <label asp-for="MetaDescription" class="form-label">توضیحات SEO</label>
                    <textarea asp-for="MetaDescription" class="form-control" rows="3" placeholder="توضیحات متا"></textarea>
                    <span asp-validation-for="MetaDescription" class="text-danger"></span>
                </div>
                <div class="mb-3">
                    <label asp-for="MetaKeywords" class="form-label">کلمات کلیدی</label>
                    <input asp-for="MetaKeywords" class="form-control" placeholder="کلمات کلیدی با ویرگول" />
                    <span asp-validation-for="MetaKeywords" class="text-danger"></span>
                </div>
                <div class="mb-3">
                    <label asp-for="MetaRobots" class="form-label">Robots</label>
                    <select asp-for="MetaRobots" class="form-select" asp-items="Model.Selections?.RobotsOptions">
                        <option value="">-- انتخاب کنید --</option>
                    </select>
                    <span asp-validation-for="MetaRobots" class="text-danger"></span>
                </div>
                <div class="mb-3">
                    <label asp-for="CanonicalUrl" class="form-label">Canonical URL</label>
                    <input asp-for="CanonicalUrl" class="form-control" placeholder="https://example.com/page" />
                    <span asp-validation-for="CanonicalUrl" class="text-danger"></span>
                </div>

                <h5 class="mb-3 mt-4">Open Graph</h5>
                <div class="mb-3">
                    <label asp-for="OgTitle" class="form-label">OG Title</label>
                    <input asp-for="OgTitle" class="form-control" placeholder="عنوان Open Graph" />
                    <span asp-validation-for="OgTitle" class="text-danger"></span>
                </div>
                <div class="mb-3">
                    <label asp-for="OgDescription" class="form-label">OG Description</label>
                    <textarea asp-for="OgDescription" class="form-control" rows="3" placeholder="توضیحات Open Graph"></textarea>
                    <span asp-validation-for="OgDescription" class="text-danger"></span>
                </div>
                <div class="mb-3">
                    <label asp-for="OgImage" class="form-label">OG Image</label>
                    <input asp-for="OgImage" class="form-control" placeholder="URL تصویر Open Graph" />
                    <span asp-validation-for="OgImage" class="text-danger"></span>
                </div>
                <div class="mb-3">
                    <label asp-for="OgType" class="form-label">OG Type</label>
                    <select asp-for="OgType" class="form-select" asp-items="Model.Selections?.OgTypes">
                        <option value="">-- انتخاب کنید --</option>
                    </select>
                    <span asp-validation-for="OgType" class="text-danger"></span>
                </div>
                <div class="mb-3">
                    <label asp-for="OgUrl" class="form-label">OG URL</label>
                    <input asp-for="OgUrl" class="form-control" placeholder="URL Open Graph" />
                    <span asp-validation-for="OgUrl" class="text-danger"></span>
                </div>

                <h5 class="mb-3 mt-4">Twitter Card</h5>
                <div class="mb-3">
                    <label asp-for="TwitterCard" class="form-label">Twitter Card Type</label>
                    <select asp-for="TwitterCard" class="form-select" asp-items="Model.Selections?.TwitterCards">
                        <option value="">-- انتخاب کنید --</option>
                    </select>
                    <span asp-validation-for="TwitterCard" class="text-danger"></span>
                </div>
                <div class="mb-3">
                    <label asp-for="TwitterTitle" class="form-label">Twitter Title</label>
                    <input asp-for="TwitterTitle" class="form-control" placeholder="عنوان Twitter" />
                    <span asp-validation-for="TwitterTitle" class="text-danger"></span>
                </div>
                <div class="mb-3">
                    <label asp-for="TwitterDescription" class="form-label">Twitter Description</label>
                    <textarea asp-for="TwitterDescription" class="form-control" rows="3" placeholder="توضیحات Twitter"></textarea>
                    <span asp-validation-for="TwitterDescription" class="text-danger"></span>
                </div>
                <div class="mb-3">
                    <label asp-for="TwitterImage" class="form-label">Twitter Image</label>
                    <input asp-for="TwitterImage" class="form-control" placeholder="URL تصویر Twitter" />
                    <span asp-validation-for="TwitterImage" class="text-danger"></span>
                </div>
            </div>
        </div>
        
        <div class="row g-4 mt-2">
            <div class="col-lg-12">
                <h5 class="mb-3">محتوای صفحه</h5>
                
                <div class="mb-3">
                    <label asp-for="H1Title" class="form-label">عنوان H1 <span class="text-danger">*</span></label>
                    <input asp-for="H1Title" class="form-control" placeholder="عنوان H1 صفحه (فقط یک عدد)" required />
                    <div class="form-text">هر صفحه باید دقیقاً یک عنوان H1 داشته باشد</div>
                    <span asp-validation-for="H1Title" class="text-danger"></span>
                </div>
                
                <div class="mb-3" data-editor-field>
                    <label asp-for="Description" class="form-label">توضیحات صفحه</label>
                    <div id="seoDescriptionEditor"
                         class="blog-editor"
                         data-editor-wrapper
                         data-upload-url="@Url.Action("UploadContentImage", "Seo")"></div>
                    <textarea asp-for="Description"
                              class="form-control d-none"
                              rows="10"
                              placeholder="توضیحات صفحه را اینجا وارد کنید..."
                              data-content-input
                              data-editor-textarea></textarea>
                    <div class="form-text d-none text-warning" data-editor-fallback>
                        در صورت بروز مشکل در بارگذاری ویرایشگر پیشرفته، متن را در این بخش وارد کنید.
                    </div>
                    <span asp-validation-for="Description" class="text-danger"></span>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label asp-for="FeaturedImageUrl" class="form-label">تصویر شاخص (URL یا آپلود)</label>
                            <input asp-for="FeaturedImageUrl" type="url" class="form-control" placeholder="https://example.com/image.jpg" id="featuredImageUrl" />
                            <div class="form-text">می‌توانید URL تصویر را وارد کنید یا از دکمه زیر آپلود کنید</div>
                            <span asp-validation-for="FeaturedImageUrl" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label asp-for="FeaturedImageAlt" class="form-label">Alt تصویر شاخص</label>
                            <input asp-for="FeaturedImageAlt" class="form-control" placeholder="توضیحات تصویر" />
                            <span asp-validation-for="FeaturedImageAlt" class="text-danger"></span>
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="featuredImageUpload" class="form-label">آپلود تصویر شاخص</label>
                    <input type="file" id="featuredImageUpload" accept="image/*" class="form-control" />
                    <div class="form-text">اگر تصویر را آپلود کنید، URL به صورت خودکار پر می‌شود</div>
                </div>
                
                <div class="mb-3">
                    <label asp-for="Tags" class="form-label">برچسب‌ها</label>
                    <input asp-for="Tags" class="form-control" placeholder="برچسب1, برچسب2, برچسب3" />
                    <div class="form-text">برچسب‌ها را با ویرگول از هم جدا کنید</div>
                    <span asp-validation-for="Tags" class="text-danger"></span>
                </div>
            </div>
        </div>
        
        <div class="row g-4 mt-2">
            <div class="col-12">
                <h5 class="mb-3">Schema & Sitemap</h5>
                <div class="row g-3">
                    <div class="col-12">
                        <div class="mb-3">
                            <label asp-for="SchemaJson" class="form-label">Schema JSON-LD</label>
                            <textarea asp-for="SchemaJson" 
                                      class="form-control" 
                                      rows="15" 
                                      data-json-editor
                                      placeholder='{"@@context": "https://schema.org", "@@type": "WebSite", ...}'></textarea>
                            <div class="form-text">JSON-LD برای Schema.org - می‌توانید از دکمه‌های بالا برای فرمت کردن و اعتبارسنجی استفاده کنید</div>
                            <span asp-validation-for="SchemaJson" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="mb-3">
                            <label asp-for="BreadcrumbsJson" class="form-label">Breadcrumbs JSON</label>
                            <textarea asp-for="BreadcrumbsJson" 
                                      class="form-control" 
                                      rows="8" 
                                      data-json-editor
                                      placeholder='[{"name": "خانه", "url": "/"}, {"name": "صفحه فعلی", "url": "/current"}]'></textarea>
                            <div class="form-text">JSON برای Breadcrumbs - می‌توانید از دکمه‌های بالا برای فرمت کردن و اعتبارسنجی استفاده کنید</div>
                            <span asp-validation-for="BreadcrumbsJson" class="text-danger"></span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="mb-3">
                    <label asp-for="SitemapPriority" class="form-label">Sitemap Priority (0.0 - 1.0)</label>
                    <input asp-for="SitemapPriority" type="number" step="0.1" min="0" max="1" class="form-control" placeholder="0.5" />
                    <span asp-validation-for="SitemapPriority" class="text-danger"></span>
                </div>
                <div class="mb-3">
                    <label asp-for="SitemapChangefreq" class="form-label">Sitemap Change Frequency</label>
                    <select asp-for="SitemapChangefreq" class="form-select" asp-items="Model.Selections?.SitemapChangefreqOptions">
                        <option value="">-- انتخاب کنید --</option>
                    </select>
                    <span asp-validation-for="SitemapChangefreq" class="text-danger"></span>
                </div>
            </div>
        </div>
    </div>
    <div class="card-footer d-flex justify-content-between">
        <a class="btn btn-outline-secondary" asp-action="Index">بازگشت</a>
        <button type="submit" class="btn btn-primary">
            @if (isEdit)
            {
                <span><i class="bi bi-save me-1"></i>ذخیره تغییرات</span>
            }
            else
            {
                <span><i class="bi bi-check2-circle me-1"></i>ایجاد تنظیمات SEO</span>
            }
        </button>
    </div>
</form>

@section Scripts {
    @{ await Html.RenderPartialAsync("_ValidationScriptsPartial"); }
    <script src="~/js/admin/rich-editor.js" asp-append-version="true"></script>
    <script src="~/js/admin/json-editor.js" asp-append-version="true"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const useTemplateCheckbox = document.getElementById('useTemplate');
            const templateSection = document.getElementById('templateSection');
            const staticSection = document.getElementById('staticSection');

            if (useTemplateCheckbox) {
                useTemplateCheckbox.addEventListener('change', function() {
                    if (this.checked) {
                        templateSection.style.display = 'block';
                        staticSection.style.display = 'none';
                    } else {
                        templateSection.style.display = 'none';
                        staticSection.style.display = 'block';
                    }
                });
            }

            // راه‌اندازی Rich Editor برای توضیحات
            const form = document.querySelector('[data-seo-form]');
            if (form && window.AdminRichEditor && typeof window.AdminRichEditor.init === 'function') {
                window.AdminRichEditor.init(form);
            }

            // راه‌اندازی JSON Editor برای Schema و Breadcrumbs
            if (form && window.JsonEditor && typeof window.JsonEditor.init === 'function') {
                window.JsonEditor.init(form);
            }

            // آپلود تصویر شاخص
            const featuredImageUpload = document.getElementById('featuredImageUpload');
            const featuredImageUrl = document.getElementById('featuredImageUrl');
            const featuredImagePreview = document.createElement('div');
            featuredImagePreview.className = 'mt-2';
            featuredImagePreview.style.display = 'none';
            if (featuredImageUrl && featuredImageUrl.value) {
                featuredImagePreview.innerHTML = '<img src="' + featuredImageUrl.value + '" alt="Preview" style="max-width: 300px; max-height: 200px; border: 1px solid #ddd; border-radius: 4px;" />';
                featuredImagePreview.style.display = 'block';
            }
            featuredImageUrl?.parentElement?.appendChild(featuredImagePreview);

            if (featuredImageUpload && featuredImageUrl) {
                featuredImageUpload.addEventListener('change', function(e) {
                    const file = e.target.files?.[0];
                    if (!file) return;

                    const formData = new FormData();
                    formData.append('file', file);

                    fetch('@Url.Action("UploadFeaturedImage", "Seo")', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.url) {
                            featuredImageUrl.value = data.url;
                            featuredImagePreview.innerHTML = '<img src="' + data.url + '" alt="Preview" style="max-width: 300px; max-height: 200px; border: 1px solid #ddd; border-radius: 4px;" />';
                            featuredImagePreview.style.display = 'block';
                        } else {
                            alert(data.error || 'خطا در آپلود تصویر');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('خطا در آپلود تصویر');
                    });
                });
            }

            // نمایش پیش‌نمایش تصویر هنگام تغییر URL
            if (featuredImageUrl) {
                featuredImageUrl.addEventListener('blur', function() {
                    if (this.value) {
                        featuredImagePreview.innerHTML = '<img src="' + this.value + '" alt="Preview" style="max-width: 300px; max-height: 200px; border: 1px solid #ddd; border-radius: 4px;" onerror="this.style.display=\'none\'" />';
                        featuredImagePreview.style.display = 'block';
                    } else {
                        featuredImagePreview.style.display = 'none';
                    }
                });
            }
        });
    </script>
}

