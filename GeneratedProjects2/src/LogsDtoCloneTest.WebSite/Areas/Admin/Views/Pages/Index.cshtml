@using LogsDtoCloneTest.WebSite.Areas.Admin.Models
@model PagesIndexViewModel
@{
    var pages = Model.Pages?.ToList() ?? new List<PageListItemViewModel>();
    string FormatDate(DateTimeOffset? date) => date is null ? "-" : date.Value.ToPersianDateTimeString();
    string StatusBadgeClass(bool isPublished) => isPublished
        ? "badge bg-success-subtle text-success-emphasis"
        : "badge bg-warning-subtle text-warning-emphasis";
    string StatusLabel(bool isPublished) => isPublished ? "منتشر شده" : "پیش‌نویس";
}

@section Breadcrumb {
    <li class="breadcrumb-item"><a asp-area="Admin" asp-controller="Dashboard" asp-action="Index">داشبورد</a></li>
    <li class="breadcrumb-item active" aria-current="page">@ViewData["Title"]</li>
}

@await Html.PartialAsync("_StatusMessage")

@if (Model.Statistics is not null)
{
    var stats = Model.Statistics;
    <div class="row g-3 mb-4">
        <div class="col-6 col-md-4 col-lg-2">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="fs-2 fw-bold text-primary">@stats.TotalPages</div>
                    <div class="text-muted small">کل صفحات</div>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-4 col-lg-2">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="fs-2 fw-bold text-success">@stats.PublishedPages</div>
                    <div class="text-muted small">منتشر شده</div>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-4 col-lg-2">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="fs-2 fw-bold text-warning">@stats.DraftPages</div>
                    <div class="text-muted small">پیش‌نویس</div>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-4 col-lg-2">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="fs-2 fw-bold text-info">@stats.TotalViews.ToString("N0")</div>
                    <div class="text-muted small">کل بازدیدها</div>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-4 col-lg-2">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="fs-2 fw-bold text-secondary">@stats.FooterPages</div>
                    <div class="text-muted small">در فوتر</div>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-4 col-lg-2">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="fs-2 fw-bold text-dark">@stats.QuickAccessPages</div>
                    <div class="text-muted small">دسترسی سریع</div>
                </div>
            </div>
        </div>
    </div>
}

<div class="card shadow-sm border-0 mb-4">
    <div class="card-body d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3">
        <div>
            <h1 class="h3 mb-1">لیست صفحات</h1>
            <p class="text-muted mb-0">مدیریت صفحات داینامیک سایت</p>
        </div>
        <a class="btn btn-primary" asp-action="Create">
            <i class="bi bi-plus-lg me-1"></i>
            صفحه جدید
        </a>
    </div>
</div>

<div class="card shadow-sm border-0">
    <div class="card-header bg-white">
        <div class="d-flex flex-wrap gap-2 align-items-center justify-content-between">
            <div class="d-flex flex-wrap gap-2 align-items-center">
                @if (Model.PublishedFilter is null)
                {
                    <span class="badge bg-primary">همه (@Model.TotalCount)</span>
                }
                else if (Model.PublishedFilter == true)
                {
                    <span class="badge bg-success">منتشر شده</span>
                }
                else
                {
                    <span class="badge bg-warning">پیش‌نویس</span>
                }
            </div>
            <button type="button"
                    class="btn btn-sm btn-outline-primary"
                    data-bs-toggle="modal"
                    data-bs-target="#pagesFilterModal">
                <i class="bi bi-funnel me-1"></i>
                فیلتر
            </button>
        </div>
    </div>
    <div class="card-body">
        @if (pages.Count == 0)
        {
            <div class="text-center py-5">
                <i class="bi bi-file-text fs-1 text-muted"></i>
                <p class="text-muted mt-3">هیچ صفحه‌ای یافت نشد</p>
                <a class="btn btn-primary" asp-action="Create">ایجاد صفحه جدید</a>
            </div>
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>عنوان</th>
                            <th>آدرس</th>
                            <th>وضعیت</th>
                            <th>بازدید</th>
                            <th>تاریخ انتشار</th>
                            <th>تاریخ ایجاد</th>
                            <th>عملیات</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var pageItem in pages)
                        {
                            <tr>
                                <td>
                                    <strong>@pageItem.Title</strong>
                                </td>
                                <td>
                                    <code class="text-muted">/@pageItem.Slug</code>
                                </td>
                                <td>
                                    <span class="@StatusBadgeClass(pageItem.IsPublished)">@StatusLabel(pageItem.IsPublished)</span>
                                </td>
                                <td>@pageItem.ViewCount</td>
                                <td>@FormatDate(pageItem.PublishedAt)</td>
                                <td>@FormatDate(pageItem.CreateDate)</td>
                                <td>
                                    <div class="btn-group">
                                        <a class="btn btn-sm btn-outline-primary" asp-action="Edit" asp-route-id="@pageItem.Id">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        <form asp-action="Delete" asp-route-id="@pageItem.Id" method="post" class="d-inline"
                                              onsubmit="return confirm('آیا از حذف این صفحه اطمینان دارید؟');">
                                            @Html.AntiForgeryToken()
                                            <button type="submit" class="btn btn-sm btn-outline-danger">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>
</div>

<!-- Filter Modal -->
<div class="modal fade" id="pagesFilterModal" tabindex="-1" aria-labelledby="pagesFilterModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content admin-filter-modal">
            <div class="modal-header">
                <div>
                    <h5 class="modal-title" id="pagesFilterModalLabel">فیلتر صفحات</h5>
                    <p class="modal-subtitle">نمایش لیست را با انتخاب معیارهای دلخواه محدود کنید.</p>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="بستن"></button>
            </div>
            <div class="modal-body">
                <form method="get" asp-area="Admin" asp-controller="Pages" asp-action="Index" class="admin-filter-modal__form" id="pagesFilterForm">
                    <div class="admin-filter-modal__notice">
                        <div class="admin-filter-modal__notice-icon">
                            <i class="bi bi-filter-square"></i>
                        </div>
                        <div>
                            <p class="admin-filter-modal__notice-title">راهنمای فیلتر</p>
                            <p class="admin-filter-modal__notice-text">برای رسیدن سریع‌تر به نتایج، از فیلدهای زیر استفاده کنید.</p>
                        </div>
                    </div>

                    <div class="admin-filter-modal__fields row g-3">
                        <div class="col-12">
                            <label class="form-label" for="filterPublished">وضعیت انتشار</label>
                            <select class="form-select admin-select" id="filterPublished" name="published">
                                <option value="">همه صفحات</option>
                                <option value="true" selected="@(Model.PublishedFilter == true ? "selected" : null)">منتشر شده</option>
                                <option value="false" selected="@(Model.PublishedFilter == false ? "selected" : null)">پیش‌نویس</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="submit" form="pagesFilterForm" class="btn btn-primary">
                    <i class="bi bi-funnel-fill me-1"></i>
                    اعمال فیلتر
                </button>
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">انصراف</button>
                <a href="@Url.Action("Index", "Pages", new { area = "Admin" })"
                   class="btn btn-link text-danger ms-auto">
                    <i class="bi bi-x-circle me-1"></i>
                    حذف فیلترها
                </a>
            </div>
        </div>
    </div>
</div>

