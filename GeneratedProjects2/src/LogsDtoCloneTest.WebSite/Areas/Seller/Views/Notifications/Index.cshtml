@model NotificationListViewModel
@using LogsDtoCloneTest.Domain.Enums
@using LogsDtoCloneTest.SharedKernel.Extensions
@{
    ViewData["Title"] = "اعلان‌ها";
    ViewData["Subtitle"] = "لیست اعلان‌های شما";
    var filter = Model.Filter ?? new NotificationFilterViewModel();
    var hasActiveFilters = filter.Type.HasValue
        || filter.Priority.HasValue
        || !string.IsNullOrWhiteSpace(filter.Search)
        || filter.FromDate.HasValue
        || filter.ToDate.HasValue
        || filter.IsRead.HasValue;
    var fromDateValue = filter.FromDate?.ToString("yyyy-MM-dd");
    var toDateValue = filter.ToDate?.ToString("yyyy-MM-dd");
    var fromDateDisplay = fromDateValue?.Replace("-", "/");
    var toDateDisplay = toDateValue?.Replace("-", "/");
}

<div class="notification-list">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-2">اعلان‌ها</h1>
            <p class="text-muted mb-0">لیست تمام اعلان‌های شما</p>
        </div>
        @if (Model.UnreadCount > 0)
        {
            <form asp-action="MarkAllAsRead" method="post" class="d-inline">
                @Html.AntiForgeryToken()
                <button type="submit" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-check-all"></i>
                    علامت‌گذاری همه به عنوان خوانده شده
                </button>
            </form>
        }
    </div>

    <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
        <div class="btn-group" role="group">
            <a asp-action="Index"
               asp-route-page="1"
               asp-route-pageSize="@Model.PageSize"
               asp-route-isRead="@((bool?)null)"
               asp-route-type="@filter.Type"
               asp-route-priority="@filter.Priority"
               asp-route-search="@filter.Search"
               asp-route-fromDate="@fromDateValue"
               asp-route-toDate="@toDateValue"
               class="btn btn-outline-secondary @(Model.IsReadFilter == null ? "active" : "")">
                همه (@Model.TotalCount)
            </a>
            <a asp-action="Index"
               asp-route-page="1"
               asp-route-pageSize="@Model.PageSize"
               asp-route-isRead="false"
               asp-route-type="@filter.Type"
               asp-route-priority="@filter.Priority"
               asp-route-search="@filter.Search"
               asp-route-fromDate="@fromDateValue"
               asp-route-toDate="@toDateValue"
               class="btn btn-outline-danger @(Model.IsReadFilter == false ? "active" : "")">
                خوانده نشده (@Model.UnreadCount)
            </a>
            <a asp-action="Index"
               asp-route-page="1"
               asp-route-pageSize="@Model.PageSize"
               asp-route-isRead="true"
               asp-route-type="@filter.Type"
               asp-route-priority="@filter.Priority"
               asp-route-search="@filter.Search"
               asp-route-fromDate="@fromDateValue"
               asp-route-toDate="@toDateValue"
               class="btn btn-outline-success @(Model.IsReadFilter == true ? "active" : "")">
                خوانده شده (@(Model.TotalCount - Model.UnreadCount))
            </a>
        </div>

        <div class="d-flex align-items-center gap-2">
            <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#notifications-filter-modal">
                <i class="bi bi-funnel"></i>
                فیلتر پیشرفته
            </button>
            @if (hasActiveFilters)
            {
                <a asp-action="Index" class="btn btn-link text-decoration-none">
                    پاک کردن فیلترها
                </a>
            }
        </div>
    </div>

    @if (hasActiveFilters)
    {
        <div class="alert alert-light border d-flex align-items-center flex-wrap gap-2">
            <span class="fw-bold text-muted">فیلترها:</span>
            @if (!string.IsNullOrWhiteSpace(filter.Search))
            {
                <span class="badge bg-light text-dark border">جستجو: @filter.Search</span>
            }
            @if (filter.Type.HasValue)
            {
                <span class="badge bg-light text-dark border">نوع: @filter.Type.Value.GetDisplayName()</span>
            }
            @if (filter.Priority.HasValue)
            {
                <span class="badge bg-light text-dark border">اولویت: @filter.Priority.Value.GetDisplayName()</span>
            }
            @if (filter.IsRead.HasValue)
            {
                <span class="badge bg-light text-dark border">وضعیت: @(filter.IsRead.Value ? "خوانده شده" : "خوانده نشده")</span>
            }
            @if (filter.FromDate.HasValue)
            {
                <span class="badge bg-light text-dark border">از: @filter.FromDate.Value.ToString("yyyy/MM/dd")</span>
            }
            @if (filter.ToDate.HasValue)
            {
                <span class="badge bg-light text-dark border">تا: @filter.ToDate.Value.ToString("yyyy/MM/dd")</span>
            }
        </div>
    }

    @if (Model.Items.Count == 0)
    {
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center py-5">
                <div class="fs-1 mb-3">🔔</div>
                <h3 class="h5 mb-2">هیچ اعلانی یافت نشد</h3>
                <p class="text-muted mb-0">شما هنوز اعلانی ندارید.</p>
            </div>
        </div>
    }
    else
    {
        <div class="notification-items">
            @foreach (var notification in Model.Items)
            {
                var priorityClass = notification.Priority switch
                {
                    NotificationPriority.Low => "bg-secondary",
                    NotificationPriority.Normal => "bg-info",
                    NotificationPriority.High => "bg-warning",
                    NotificationPriority.Urgent => "bg-danger",
                    _ => "bg-secondary"
                };

                var typeIcon = notification.Type switch
                {
                    NotificationType.General => "bi-info-circle",
                    NotificationType.Important => "bi-exclamation-triangle",
                    NotificationType.Warning => "bi-exclamation-circle",
                    NotificationType.Promotion => "bi-tag",
                    NotificationType.System => "bi-gear",
                    _ => "bi-bell"
                };

                <div class="card mb-3 @(notification.IsRead ? "" : "border-primary")" data-notification-id="@notification.Id">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2 gap-2 flex-wrap">
                            <div class="d-flex align-items-center gap-2 flex-grow-1 min-w-0">
                                <i class="bi @typeIcon text-primary flex-shrink-0"></i>
                                <h5 class="card-title mb-0 @(notification.IsRead ? "" : "fw-bold") text-break" style="word-wrap: break-word; overflow-wrap: break-word;">@notification.Title</h5>
                                @if (!notification.IsRead)
                                {
                                    <span class="badge bg-primary rounded-pill flex-shrink-0">جدید</span>
                                }
                            </div>
                            <div class="d-flex align-items-center gap-2 flex-shrink-0">
                                <span class="badge @priorityClass">@notification.Priority.GetDisplayName()</span>
                                @if (notification.ExpiresAt.HasValue && notification.ExpiresAt.Value < DateTimeOffset.UtcNow)
                                {
                                    <span class="badge bg-secondary">منقضی شده</span>
                                }
                            </div>
                        </div>
                        <p class="card-text text-muted mb-3 notification-message" style="word-wrap: break-word; overflow-wrap: break-word; word-break: break-word;">@notification.Message</p>
                        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                            <div class="text-muted small">
                                <i class="bi bi-clock"></i>
                                @notification.SentAt.ToPersianDateTimeString()
                                @if (notification.ExpiresAt.HasValue)
                                {
                                    <span class="ms-2">
                                        <i class="bi bi-calendar-x"></i>
                                        انقضا: @notification.ExpiresAt.Value.ToPersianDateString()
                                    </span>
                                }
                            </div>
                            @if (!notification.IsRead)
                            {
                                <form asp-action="MarkAsRead" method="post" class="d-inline mark-as-read-form">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@notification.Id" />
                                    <button type="submit" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-check"></i>
                                        علامت‌گذاری به عنوان خوانده شده
                                    </button>
                                </form>
                            }
                            else
                            {
                                <span class="text-muted small">
                                    <i class="bi bi-check-circle"></i>
                                    خوانده شده در @(notification.ReadAt?.ToPersianDateTimeString() ?? "")
                                </span>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>

        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3 mt-4">
            <form method="get" class="d-flex align-items-center gap-2">
                <input type="hidden" name="page" value="1" />
                <input type="hidden" name="isRead" value="@(Model.IsReadFilter?.ToString().ToLower())" />
                <input type="hidden" name="type" value="@filter.Type" />
                <input type="hidden" name="priority" value="@filter.Priority" />
                <input type="hidden" name="search" value="@filter.Search" />
                <input type="hidden" name="fromDate" value="@fromDateValue" />
                <input type="hidden" name="toDate" value="@toDateValue" />

                <label class="mb-0 text-muted">تعداد در صفحه</label>
                <select class="form-select form-select-sm" name="pageSize" onchange="this.form.submit()">
                    <option value="5" selected="@(Model.PageSize == 5 ? "selected" : null)">5</option>
                    <option value="10" selected="@(Model.PageSize == 10 ? "selected" : null)">10</option>
                    <option value="20" selected="@(Model.PageSize == 20 ? "selected" : null)">20</option>
                    <option value="50" selected="@(Model.PageSize == 50 ? "selected" : null)">50</option>
                </select>
            </form>

            @if (Model.TotalPages > 1)
            {
                <nav aria-label="صفحه‌بندی اعلان‌ها">
                    <ul class="pagination mb-0">
                        <li class="page-item @(Model.PageNumber <= 1 ? "disabled" : "")">
                            <a class="page-link"
                               asp-action="Index"
                               asp-route-page="@(Model.PageNumber - 1)"
                               asp-route-pageSize="@Model.PageSize"
                               asp-route-isRead="@Model.IsReadFilter"
                               asp-route-type="@filter.Type"
                               asp-route-priority="@filter.Priority"
                               asp-route-search="@filter.Search"
                               asp-route-fromDate="@fromDateValue"
                               asp-route-toDate="@toDateValue"
                               aria-label="قبلی">
                                <i class="bi bi-chevron-right"></i>
                            </a>
                        </li>
                        <li class="page-item active">
                            <span class="page-link">@Model.PageNumber</span>
                        </li>
                        <li class="page-item @(Model.PageNumber >= Model.TotalPages ? "disabled" : "")">
                            <a class="page-link"
                               asp-action="Index"
                               asp-route-page="@(Model.PageNumber + 1)"
                               asp-route-pageSize="@Model.PageSize"
                               asp-route-isRead="@Model.IsReadFilter"
                               asp-route-type="@filter.Type"
                               asp-route-priority="@filter.Priority"
                               asp-route-search="@filter.Search"
                               asp-route-fromDate="@fromDateValue"
                               asp-route-toDate="@toDateValue"
                               aria-label="بعدی">
                                <i class="bi bi-chevron-left"></i>
                            </a>
                        </li>
                    </ul>
                </nav>
            }

            <div class="text-muted small">
                نمایش @((Model.PageNumber - 1) * Model.PageSize + 1) تا @Math.Min(Model.PageNumber * Model.PageSize, Model.TotalCount) از @Model.TotalCount اعلان
            </div>
        </div>
    }
</div>

<div class="modal fade" id="notifications-filter-modal" tabindex="-1" aria-labelledby="notifications-filter-modal-label" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="notifications-filter-modal-label">فیلتر اعلان‌ها</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="بستن"></button>
            </div>
            <form method="get" asp-action="Index">
                <div class="modal-body">
                    <input type="hidden" name="page" value="1" />
                    <input type="hidden" name="pageSize" value="@Model.PageSize" />

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label" for="notification-search">جستجو در عنوان یا متن</label>
                            <input type="text"
                                   id="notification-search"
                                   name="search"
                                   value="@filter.Search"
                                   class="form-control"
                                   placeholder="مثال: پرداخت، تیکت یا سیستم" />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label" for="notification-type">نوع اعلان</label>
                            <select id="notification-type" name="type" class="form-select">
                                <option value="">همه انواع</option>
                                @foreach (NotificationType t in Enum.GetValues(typeof(NotificationType)))
                                {
                                    var selected = filter.Type.HasValue && filter.Type.Value == t;
                                    <option value="@t" selected="@(selected ? "selected" : null)">@t.GetDisplayName()</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label" for="notification-priority">اولویت</label>
                            <select id="notification-priority" name="priority" class="form-select">
                                <option value="">همه اولویت‌ها</option>
                                @foreach (NotificationPriority p in Enum.GetValues(typeof(NotificationPriority)))
                                {
                                    var selected = filter.Priority.HasValue && filter.Priority.Value == p;
                                    <option value="@p" selected="@(selected ? "selected" : null)">@p.GetDisplayName()</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label" for="notification-isRead">وضعیت خواندن</label>
                            <select id="notification-isRead" name="isRead" class="form-select">
                                <option value="" selected="@(filter.IsRead == null ? "selected" : null)">همه</option>
                                <option value="false" selected="@(filter.IsRead == false ? "selected" : null)">خوانده نشده</option>
                                <option value="true" selected="@(filter.IsRead == true ? "selected" : null)">خوانده شده</option>
                            </select>
                        </div>
                        <div class="col-md-3" data-notification-date>
                            <label class="form-label" for="notification-fromDateDisplay">از تاریخ</label>
                            <div class="jalali-picker" data-jalali-picker>
                                <div class="jalali-picker__controls">
                                    <input type="text"
                                           class="form-control"
                                           id="notification-fromDateDisplay"
                                           placeholder="انتخاب تاریخ"
                                           value="@fromDateDisplay"
                                           data-jalali-input
                                           data-jdp
                                           data-jdp-only-date
                                           data-jdp-init-date="@fromDateDisplay"
                                           autocomplete="off"
                                           dir="ltr" />
                                </div>
                                <input type="hidden"
                                       id="notification-fromDate"
                                       name="fromDate"
                                       value="@fromDateValue"
                                       data-jalali-target />
                            </div>
                        </div>
                        <div class="col-md-3" data-notification-date>
                            <label class="form-label" for="notification-toDateDisplay">تا تاریخ</label>
                            <div class="jalali-picker" data-jalali-picker>
                                <div class="jalali-picker__controls">
                                    <input type="text"
                                           class="form-control"
                                           id="notification-toDateDisplay"
                                           placeholder="انتخاب تاریخ"
                                           value="@toDateDisplay"
                                           data-jalali-input
                                           data-jdp
                                           data-jdp-only-date
                                           data-jdp-init-date="@toDateDisplay"
                                           autocomplete="off"
                                           dir="ltr" />
                                </div>
                                <input type="hidden"
                                       id="notification-toDate"
                                       name="toDate"
                                       value="@toDateValue"
                                       data-jalali-target />
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">بستن</button>
                    <button type="submit" class="btn btn-primary">اعمال فیلتر</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Head {
    <link rel="stylesheet" href="~/Plugins/JalaliDatePicker/css/jalalidatepicker.min.css" />
}

@section Scripts {
    <script src="~/Plugins/JalaliDatePicker/js/jalalidatepicker.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            if (window.jalaliDatepicker && typeof jalaliDatepicker.startWatch === 'function') {
                jalaliDatepicker.startWatch();
            }
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Handle mark as read
            document.querySelectorAll('.mark-as-read-form').forEach(function (form) {
                form.addEventListener('submit', function (e) {
                    e.preventDefault();
                    var form = this;
                    var notificationCard = form.closest('[data-notification-id]');
                    var notificationId = form.querySelector('input[name="id"]').value;

                    fetch(form.action, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'RequestVerificationToken': form.querySelector('input[name="__RequestVerificationToken"]').value
                        },
                        body: new URLSearchParams({
                            id: notificationId,
                            __RequestVerificationToken: form.querySelector('input[name="__RequestVerificationToken"]').value
                        })
                    })
                    .then(function (response) {
                        return response.json();
                    })
                    .then(function (data) {
                        if (data.success) {
                            if (notificationCard) {
                                notificationCard.classList.remove('border-primary');
                                var title = notificationCard.querySelector('.card-title');
                                if (title) {
                                    title.classList.remove('fw-bold');
                                }
                                var newBadge = notificationCard.querySelector('.badge.bg-primary');
                                if (newBadge) {
                                    newBadge.remove();
                                }
                                form.outerHTML = '<span class="text-muted small"><i class="bi bi-check-circle"></i> خوانده شده</span>';
                            }
                        } else {
                            alert('خطا در به‌روزرسانی: ' + (data.error || 'خطای نامشخص'));
                        }
                    })
                    .catch(function (error) {
                        console.error('Error:', error);
                        alert('خطا در ارتباط با سرور');
                    });
                });
            });
        });
    </script>
}

