@using TestAttarClone.SharedKernel.Extensions
@model ApplicationLogListViewModel
@{
    ViewData["Title"] = "مانیتور لاگ‌ها";
    ViewData["Subtitle"] = "نمایش و جستجوی لاگ‌های سیستم";
    
    string FormatDateTime(DateTimeOffset value) => value.ToPersianDateTimeString();
    string GetLevelBadgeClass(string level) => level.ToUpperInvariant() switch
    {
        "ERROR" => "bg-danger",
        "WARNING" => "bg-warning text-dark",
        "INFORMATION" => "bg-info",
        "DEBUG" => "bg-secondary",
        _ => "bg-secondary"
    };
    
    var hasActiveFilters = Model.Filter.HasActiveFilters;
}

@section Head {
    <link rel="stylesheet" href="~/plugins/jalalidatepicker/css/jalalidatepicker.min.css" />
}

@section Breadcrumb {
    <li class="breadcrumb-item"><a asp-area="Admin" asp-controller="Dashboard" asp-action="Index">داشبورد</a></li>
    <li class="breadcrumb-item active" aria-current="page">مانیتور لاگ‌ها</li>
}

@await Html.PartialAsync("_StatusMessage")

<div class="row">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="h5 mb-1">مانیتور لاگ‌ها</h2>
                    <p class="text-muted small mb-0">تمام لاگ‌های Error و Warning سیستم</p>
                </div>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#log-filter-modal">
                        <i class="bi bi-funnel"></i>
                        فیلترها
                    </button>
                </div>
            </div>
            <div class="card-body">
                @if (hasActiveFilters)
                {
                    <div class="alert alert-info d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <i class="bi bi-info-circle me-2"></i>
                            <span>فیلترهای فعال:</span>
                            @if (!string.IsNullOrWhiteSpace(Model.Filter.Level))
                            {
                                <span class="badge bg-primary ms-2">سطح: @Model.Filter.Level</span>
                            }
                            @if (!string.IsNullOrWhiteSpace(Model.Filter.FromDatePersian))
                            {
                                <span class="badge bg-primary ms-2">از تاریخ: @Model.Filter.FromDatePersian</span>
                            }
                            @if (!string.IsNullOrWhiteSpace(Model.Filter.ToDatePersian))
                            {
                                <span class="badge bg-primary ms-2">تا تاریخ: @Model.Filter.ToDatePersian</span>
                            }
                            @if (!string.IsNullOrWhiteSpace(Model.Filter.SourceContext))
                            {
                                <span class="badge bg-primary ms-2">Source: @Model.Filter.SourceContext</span>
                            }
                            @if (!string.IsNullOrWhiteSpace(Model.Filter.ApplicationName))
                            {
                                <span class="badge bg-primary ms-2">Application: @Model.Filter.ApplicationName</span>
                            }
                            @if (!string.IsNullOrWhiteSpace(Model.Filter.MachineName))
                            {
                                <span class="badge bg-primary ms-2">Machine: @Model.Filter.MachineName</span>
                            }
                            @if (!string.IsNullOrWhiteSpace(Model.Filter.Environment))
                            {
                                <span class="badge bg-primary ms-2">Environment: @Model.Filter.Environment</span>
                            }
                        </div>
                        <a asp-action="Index" asp-route-page="1" asp-route-pageSize="@Model.PageSize" class="btn btn-sm btn-outline-secondary">
                            <i class="bi bi-x-circle"></i>
                            حذف فیلترها
                        </a>
                    </div>
                }

                @if (Model.Logs.Count == 0)
                {
                    <div class="alert alert-info mb-0" role="alert">
                        <i class="bi bi-info-circle me-2"></i>
                        هیچ لاگی یافت نشد.
                    </div>
                }
                else
                {
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead>
                                <tr>
                                    <th scope="col" style="width: 80px;">سطح</th>
                                    <th scope="col" style="width: 130px;">تاریخ و زمان</th>
                                    <th scope="col" style="width: 260px;">پیام</th>
                                    <th scope="col" style="width: 160px;">Source Context</th>
                                    <th scope="col" style="width: 140px;">Request</th>
                                    <th scope="col" style="width: 110px;">IP</th>
                                    <th scope="col" style="width: 130px;">Application</th>
                                    <th scope="col" style="width: 80px;">عملیات</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var log in Model.Logs)
                                {
                                    <tr>
                                        <td>
                                            <span class="badge @GetLevelBadgeClass(log.Level)">@log.Level</span>
                                        </td>
                                        <td>
                                            <small class="text-muted">@FormatDateTime(log.CreateDate)</small>
                                        </td>
                                        <td>
                                            <div class="text-truncate" style="max-width: 260px;" title="@log.Message">
                                                @log.Message
                                            </div>
                                            @if (!string.IsNullOrWhiteSpace(log.Exception))
                                            {
                                                <button type="button" class="btn btn-sm btn-link p-0 mt-1" data-bs-toggle="modal" data-bs-target="#exception-modal-@log.Id">
                                                    <small>مشاهده Exception</small>
                                                </button>
                                                
                                                <!-- Exception Modal -->
                                                <div class="modal fade" id="exception-modal-@log.Id" tabindex="-1" aria-labelledby="exception-modal-label-@log.Id" aria-hidden="true">
                                                    <div class="modal-dialog modal-lg modal-dialog-scrollable">
                                                        <div class="modal-content">
                                                            <div class="modal-header">
                                                                <h5 class="modal-title" id="exception-modal-label-@log.Id">Exception Details</h5>
                                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="بستن"></button>
                                                            </div>
                                                            <div class="modal-body">
                                                                <pre class="bg-dark text-light p-3 rounded" style="max-height: 500px; overflow-y: auto;"><code>@log.Exception</code></pre>
                                                            </div>
                                                            <div class="modal-footer">
                                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بستن</button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            }
                                        </td>
                                        <td>
                                            @if (!string.IsNullOrWhiteSpace(log.SourceContext))
                                            {
                                                <small class="text-muted">@log.SourceContext</small>
                                            }
                                            else
                                            {
                                                <span class="text-muted">-</span>
                                            }
                                        </td>
                                        <td>
                                            @if (!string.IsNullOrWhiteSpace(log.RequestPath))
                                            {
                                                <div>
                                                    <span class="badge bg-secondary">@log.RequestMethod</span>
                                                    <small class="text-muted d-block mt-1">@log.RequestPath</small>
                                                    @if (log.StatusCode.HasValue)
                                                    {
                                                        <span class="badge @(log.StatusCode >= 400 ? "bg-danger" : log.StatusCode >= 300 ? "bg-warning" : "bg-success") mt-1">@log.StatusCode</span>
                                                    }
                                                    @if (log.ElapsedMs.HasValue)
                                                    {
                                                        <small class="text-muted d-block">@log.ElapsedMs.Value.ToString("F2") ms</small>
                                                    }
                                                </div>
                                            }
                                            else
                                            {
                                                <span class="text-muted">-</span>
                                            }
                                        </td>
                                        <td>
                                            @if (!string.IsNullOrWhiteSpace(log.RemoteIpAddress))
                                            {
                                                <code class="small">@log.RemoteIpAddress</code>
                                            }
                                            else
                                            {
                                                <span class="text-muted">-</span>
                                            }
                                        </td>
                                        <td>
                                            <div>
                                                @if (!string.IsNullOrWhiteSpace(log.ApplicationName))
                                                {
                                                    <strong>@log.ApplicationName</strong>
                                                }
                                                @if (!string.IsNullOrWhiteSpace(log.MachineName))
                                                {
                                                    <br><small class="text-muted">@log.MachineName</small>
                                                }
                                                @if (!string.IsNullOrWhiteSpace(log.Environment))
                                                {
                                                    <br><span class="badge bg-info mt-1">@log.Environment</span>
                                                }
                                            </div>
                                        </td>
                                        <td>
                                            <a asp-action="Details" asp-route-id="@log.Id" class="btn btn-outline-primary btn-sm px-2 py-1" style="font-size: 0.8rem;">
                                                <i class="bi bi-eye"></i>
                                                جزئیات
                                            </a>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    @if (Model.TotalPages > 1)
                    {
                        var previousPage = Math.Max(1, Model.PageNumber - 1);
                        var nextPage = Math.Min(Model.TotalPages, Model.PageNumber + 1);
                        var startPage = Math.Max(1, Model.PageNumber - 2);
                        var endPage = Math.Min(Model.TotalPages, Model.PageNumber + 2);

                        <nav aria-label="صفحه‌بندی لاگ‌ها" class="mt-4">
                            <ul class="pagination justify-content-center">
                                <li class="page-item @(Model.PageNumber == 1 ? "disabled" : string.Empty)">
                                    <a class="page-link" 
                                       asp-action="Index" 
                                       asp-route-page="@previousPage" 
                                       asp-route-pageSize="@Model.PageSize"
                                       asp-route-level="@Model.Filter.Level"
                                       asp-route-fromDatePersian="@Model.Filter.FromDatePersian"
                                       asp-route-toDatePersian="@Model.Filter.ToDatePersian"
                                       asp-route-sourceContext="@Model.Filter.SourceContext"
                                       asp-route-applicationName="@Model.Filter.ApplicationName"
                                       asp-route-machineName="@Model.Filter.MachineName"
                                       asp-route-environment="@Model.Filter.Environment"
                                       aria-label="قبلی">
                                        <span aria-hidden="true">&laquo;</span>
                                    </a>
                                </li>

                                @for (var i = startPage; i <= endPage; i++)
                                {
                                    <li class="page-item @(i == Model.PageNumber ? "active" : string.Empty)">
                                        <a class="page-link" 
                                           asp-action="Index" 
                                           asp-route-page="@i" 
                                           asp-route-pageSize="@Model.PageSize"
                                           asp-route-level="@Model.Filter.Level"
                                           asp-route-fromDatePersian="@Model.Filter.FromDatePersian"
                                           asp-route-toDatePersian="@Model.Filter.ToDatePersian"
                                           asp-route-sourceContext="@Model.Filter.SourceContext"
                                           asp-route-applicationName="@Model.Filter.ApplicationName"
                                           asp-route-machineName="@Model.Filter.MachineName"
                                           asp-route-environment="@Model.Filter.Environment">
                                            @i
                                        </a>
                                    </li>
                                }

                                <li class="page-item @(Model.PageNumber == Model.TotalPages ? "disabled" : string.Empty)">
                                    <a class="page-link" 
                                       asp-action="Index" 
                                       asp-route-page="@nextPage" 
                                       asp-route-pageSize="@Model.PageSize"
                                       asp-route-level="@Model.Filter.Level"
                                       asp-route-fromDatePersian="@Model.Filter.FromDatePersian"
                                       asp-route-toDatePersian="@Model.Filter.ToDatePersian"
                                       asp-route-sourceContext="@Model.Filter.SourceContext"
                                       asp-route-applicationName="@Model.Filter.ApplicationName"
                                       asp-route-machineName="@Model.Filter.MachineName"
                                       asp-route-environment="@Model.Filter.Environment"
                                       aria-label="بعدی">
                                        <span aria-hidden="true">&raquo;</span>
                                    </a>
                                </li>
                            </ul>
                        </nav>

                        <div class="text-center text-muted small mt-2">
                            نمایش @((Model.PageNumber - 1) * Model.PageSize + 1) تا @(Math.Min(Model.PageNumber * Model.PageSize, Model.TotalCount)) از @Model.TotalCount لاگ
                        </div>
                    }
                }
            </div>
        </div>
    </div>
</div>

<!-- Filter Modal -->
<div class="modal fade" id="log-filter-modal" tabindex="-1" aria-labelledby="log-filter-modal-label" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="log-filter-modal-label">فیلتر لاگ‌ها</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="بستن"></button>
            </div>
            <form method="get" asp-action="Index">
                <div class="modal-body">
                    <input type="hidden" name="page" value="1" />
                    <input type="hidden" name="pageSize" value="@Model.PageSize" />

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="level" class="form-label">سطح</label>
                            <select class="form-select" id="level" name="level">
                                <option value="">همه</option>
                                @if (Model.Filter.Level == "Error")
                                {
                                    <option value="Error" selected>Error</option>
                                }
                                else
                                {
                                    <option value="Error">Error</option>
                                }
                                @if (Model.Filter.Level == "Warning")
                                {
                                    <option value="Warning" selected>Warning</option>
                                }
                                else
                                {
                                    <option value="Warning">Warning</option>
                                }
                                @if (Model.Filter.Level == "Information")
                                {
                                    <option value="Information" selected>Information</option>
                                }
                                else
                                {
                                    <option value="Information">Information</option>
                                }
                                @if (Model.Filter.Level == "Debug")
                                {
                                    <option value="Debug" selected>Debug</option>
                                }
                                else
                                {
                                    <option value="Debug">Debug</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="applicationName" class="form-label">نام برنامه</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="applicationName" 
                                   name="applicationName" 
                                   value="@Model.Filter.ApplicationName"
                                   placeholder="مثال: TestAttarClone-WebSite" />
                        </div>
                        <div class="col-md-6">
                            <label for="fromDatePersian" class="form-label">از تاریخ</label>
                            <input type="text" 
                                   class="form-control persian-datepicker" 
                                   id="fromDatePersian" 
                                   name="fromDatePersian" 
                                   value="@Model.Filter.FromDatePersian"
                                   placeholder="مثال: 1404/01/01" 
                                   data-jdp />
                        </div>
                        <div class="col-md-6">
                            <label for="toDatePersian" class="form-label">تا تاریخ</label>
                            <input type="text" 
                                   class="form-control persian-datepicker" 
                                   id="toDatePersian" 
                                   name="toDatePersian" 
                                   value="@Model.Filter.ToDatePersian"
                                   placeholder="مثال: 1404/12/29" 
                                   data-jdp />
                        </div>
                        <div class="col-md-6">
                            <label for="sourceContext" class="form-label">Source Context</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="sourceContext" 
                                   name="sourceContext" 
                                   value="@Model.Filter.SourceContext"
                                   placeholder="مثال: TestAttarClone.WebSite" />
                        </div>
                        <div class="col-md-6">
                            <label for="machineName" class="form-label">نام ماشین</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="machineName" 
                                   name="machineName" 
                                   value="@Model.Filter.MachineName"
                                   placeholder="مثال: DESKTOP-ABC" />
                        </div>
                        <div class="col-md-6">
                            <label for="environment" class="form-label">محیط</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="environment" 
                                   name="environment" 
                                   value="@Model.Filter.Environment"
                                   placeholder="مثال: Development, Production" />
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <a class="btn btn-light" asp-action="Index" asp-route-page="1" asp-route-pageSize="@Model.PageSize">پاکسازی</a>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">انصراف</button>
                    <button type="submit" class="btn btn-primary">اعمال فیلتر</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/plugins/jalalidatepicker/js/jalalidatepicker.min.js"></script>
    <script>
        $(document).ready(function() {
            jalaliDatepicker.startWatch({
                minDate: "attr",
                maxDate: "attr"
            });
        });
    </script>
}

