@model NavigationMenuFormModalViewModel
@{
    var isEdit = Model.Form.Id.HasValue;
}

<form asp-area="Admin" asp-controller="NavigationMenu" asp-action="@(isEdit ? "Edit" : "Create")" method="post" id="menuItemForm" enctype="multipart/form-data">
    @Html.AntiForgeryToken()
    <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>
    
    @if (isEdit)
    {
        <input asp-for="Form.Id" type="hidden" />
    }

    <div class="modal-body">
        <div class="mb-3">
            <label asp-for="Form.Title" class="form-label"></label>
            <input asp-for="Form.Title" class="form-control" />
            <span asp-validation-for="Form.Title" class="text-danger"></span>
        </div>

        <div class="mb-3">
            <label asp-for="Form.Url" class="form-label"></label>
            <input asp-for="Form.Url" class="form-control text-start" dir="ltr" />
            <span class="form-text text-muted">می‌توانید از آدرس داخلی (مانند /courses) یا لینک خارجی استفاده کنید.</span>
            <span asp-validation-for="Form.Url" class="text-danger"></span>
        </div>

        <div class="mb-3">
            <label asp-for="Form.Icon" class="form-label"></label>
            <input asp-for="Form.Icon" class="form-control text-start" dir="ltr" id="iconInput" placeholder="مثال: bi bi-house یا fa fa-home یا &lt;i class=&quot;bi bi-house&quot;&gt;&lt;/i&gt;" />
            <span class="form-text text-muted">
                <strong>راهنما:</strong> می‌توانید از یکی از فرمت‌های زیر استفاده کنید:
                <ul class="mb-0 mt-2">
                    <li><strong>Bootstrap Icons:</strong> <code>bi bi-نام-آیکون</code> (مثال: <code>bi bi-house</code>)</li>
                    <li><strong>Font Awesome:</strong> <code>fa fa-نام-آیکون</code> یا <code>fas fa-نام-آیکون</code> (مثال: <code>fa fa-home</code>)</li>
                    <li><strong>HTML کامل:</strong> <code>&lt;i class="bi bi-house"&gt;&lt;/i&gt;</code></li>
                </ul>
                این فیلد اختیاری است و می‌توانید خالی بگذارید.
            </span>
            <div class="mt-2">
                <small class="text-muted">
                    <i class="bi bi-info-circle"></i> 
                    <a href="https://icons.getbootstrap.com/" target="_blank" rel="noopener">Bootstrap Icons</a> | 
                    <a href="https://fontawesome.com/icons" target="_blank" rel="noopener">Font Awesome</a>
                </small>
            </div>
            <div class="mt-2" id="iconPreviewContainer" style="display: none;">
                <label class="form-label small">پیش‌نمایش آیکون:</label>
                <div class="border rounded p-2 bg-light d-inline-block">
                    <span id="iconPreview"></span>
                </div>
            </div>
            <span asp-validation-for="Form.Icon" class="text-danger"></span>
        </div>

        <div class="mb-3">
            <label asp-for="Form.ImageFile" class="form-label"></label>
            <input asp-for="Form.ImageFile" type="file" class="form-control" accept="image/jpeg,image/jpg,image/png,image/webp,image/gif" />
            <span class="form-text text-muted">حداکثر حجم فایل: 100 کیلوبایت. فرمت‌های مجاز: JPG, PNG, WEBP, GIF</span>
            @if (!string.IsNullOrWhiteSpace(Model.Form.ImageUrl))
            {
                <div class="mt-2">
                    <label class="form-label small">تصویر فعلی:</label>
                    <div>
                        <img src="@Model.Form.ImageUrl" alt="Preview" class="img-thumbnail" style="max-width: 200px; max-height: 200px;" />
                        <div class="form-check mt-2">
                            <input class="form-check-input" type="checkbox" id="removeImage" name="removeImage" value="true">
                            <label class="form-check-label" for="removeImage">
                                حذف تصویر فعلی
                            </label>
                        </div>
                    </div>
                </div>
            }
            <span asp-validation-for="Form.ImageFile" class="text-danger"></span>
        </div>

        <div class="row g-3">
            <div class="col-md-6">
                <label asp-for="Form.DisplayOrder" class="form-label"></label>
                <input asp-for="Form.DisplayOrder" class="form-control" type="number" min="0" />
                <span asp-validation-for="Form.DisplayOrder" class="text-danger"></span>
            </div>
            <div class="col-md-6">
                <label asp-for="Form.ParentId" class="form-label"></label>
                <select asp-for="Form.ParentId" asp-items="Model.ParentOptions" class="form-select">
                    <option value="">(بدون والد)</option>
                </select>
                <span asp-validation-for="Form.ParentId" class="text-danger"></span>
            </div>
        </div>

        <div class="form-check mt-4">
            <input asp-for="Form.IsVisible" class="form-check-input" type="checkbox" />
            <label asp-for="Form.IsVisible" class="form-check-label"></label>
        </div>
        <div class="form-check mt-2">
            <input asp-for="Form.OpenInNewTab" class="form-check-input" type="checkbox" />
            <label asp-for="Form.OpenInNewTab" class="form-check-label"></label>
        </div>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">انصراف</button>
        <button type="submit" class="btn btn-primary">
            <i class="bi bi-save me-1"></i>
            @(isEdit ? "ذخیره تغییرات" : "ایجاد آیتم")
        </button>
    </div>
</form>

<script>
    (function() {
        'use strict';
        const iconInput = document.getElementById('iconInput');
        const imageFileInput = document.querySelector('#menuItemForm input[name="Form.ImageFile"]');
        const iconPreview = document.getElementById('iconPreview');
        const iconPreviewContainer = document.getElementById('iconPreviewContainer');
        
        // Function to normalize icon input to HTML format
        function normalizeIconToHtml(value) {
            if (!value || !value.trim()) return '';
            
            const trimmed = value.trim();
            
            // If it's already HTML (contains <i or <span), return as is
            if (trimmed.includes('<i') || trimmed.includes('<span')) {
                return trimmed;
            }
            
            // If it's just class names, wrap in <i> tag
            return '<i class="' + trimmed + '"></i>';
        }
        
        // Function to update icon preview
        function updateIconPreview() {
            const value = iconInput.value.trim();
            if (!value) {
                iconPreviewContainer.style.display = 'none';
                return;
            }
            
            const html = normalizeIconToHtml(value);
            iconPreview.innerHTML = html;
            iconPreviewContainer.style.display = 'block';
        }
        
        if (iconInput) {
            // Update preview on input
            iconInput.addEventListener('input', updateIconPreview);
            
            // Update preview on page load if there's an initial value
            if (iconInput.value) {
                updateIconPreview();
            }

            const form = document.getElementById('menuItemForm');
            if (form) {
                form.addEventListener('submit', function(e) {
                    const iconValue = iconInput.value.trim();
                    if (iconValue) {
                        iconInput.value = normalizeIconToHtml(iconValue);
                    }
                });
            }
        }

        if (imageFileInput) {
            imageFileInput.addEventListener('change', function() {
                const file = this.files[0];
                if (file) {
                    // Check file size (100KB = 102400 bytes)
                    if (file.size > 102400) {
                        alert('حجم فایل باید کمتر از 100 کیلوبایت باشد.');
                        this.value = '';
                        return;
                    }

                    // Preview image
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const preview = document.querySelector('#menuItemForm .img-thumbnail');
                        if (preview) {
                            preview.src = e.target.result;
                            preview.style.display = 'block';
                        } else {
                            const previewContainer = document.querySelector('#menuItemForm input[name="Form.ImageFile"]').closest('.mb-3');
                            const existingPreview = previewContainer.querySelector('.img-thumbnail');
                            if (existingPreview) {
                                existingPreview.src = e.target.result;
                            } else {
                                const previewDiv = document.createElement('div');
                                previewDiv.className = 'mt-2';
                                previewDiv.innerHTML = '<label class="form-label small">پیش‌نمایش:</label><div><img src="' + e.target.result + '" alt="Preview" class="img-thumbnail" style="max-width: 200px; max-height: 200px;" /></div>';
                                previewContainer.appendChild(previewDiv);
                            }
                        }
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
    })();
</script>
