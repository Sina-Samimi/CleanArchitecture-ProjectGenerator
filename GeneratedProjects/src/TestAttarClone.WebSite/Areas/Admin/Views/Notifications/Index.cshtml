@model NotificationListViewModel
@using TestAttarClone.Domain.Enums
@using TestAttarClone.SharedKernel.Extensions
@{
    ViewData["Title"] ??= "اعلان‌ها";
    ViewData["Subtitle"] ??= "مدیریت اعلان‌های سیستم";
}

@await Html.PartialAsync("_StatusMessage")

<div class="notification-list">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-2">اعلان‌ها</h1>
            <p class="text-muted mb-0">لیست تمام اعلان‌های سیستم</p>
        </div>
        @if (Model.UnreadCount > 0)
        {
            <form asp-action="MarkAllAsRead" method="post" class="d-inline">
                @Html.AntiForgeryToken()
                <button type="submit" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-check-all"></i>
                    علامت‌گذاری همه به عنوان خوانده شده
                </button>
            </form>
        }
    </div>

    <div class="mb-3">
        <div class="btn-group" role="group">
            <a asp-action="Index" asp-route-isRead="@((bool?)null)" class="btn btn-outline-secondary @(Model.IsReadFilter == null ? "active" : "")">
                همه (@Model.TotalCount)
            </a>
            <a asp-action="Index" asp-route-isRead="false" class="btn btn-outline-danger @(Model.IsReadFilter == false ? "active" : "")">
                خوانده نشده (@Model.UnreadCount)
            </a>
            <a asp-action="Index" asp-route-isRead="true" class="btn btn-outline-success @(Model.IsReadFilter == true ? "active" : "")">
                خوانده شده (@(Model.TotalCount - Model.UnreadCount))
            </a>
        </div>
    </div>

    @if (Model.Items.Count == 0)
    {
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center py-5">
                <div class="fs-1 mb-3">🔔</div>
                <h3 class="h5 mb-2">هیچ اعلانی یافت نشد</h3>
                <p class="text-muted mb-0">شما هنوز اعلانی ندارید.</p>
            </div>
        </div>
    }
    else
    {
        <div class="notification-items">
            @foreach (var notification in Model.Items)
            {
                var priorityClass = notification.Priority switch
                {
                    NotificationPriority.Low => "bg-secondary",
                    NotificationPriority.Normal => "bg-info",
                    NotificationPriority.High => "bg-warning",
                    NotificationPriority.Urgent => "bg-danger",
                    _ => "bg-secondary"
                };

                var typeIcon = notification.Type switch
                {
                    NotificationType.General => "bi-info-circle",
                    NotificationType.Important => "bi-exclamation-triangle",
                    NotificationType.Warning => "bi-exclamation-circle",
                    NotificationType.Promotion => "bi-tag",
                    NotificationType.System => "bi-gear",
                    _ => "bi-bell"
                };

                <div class="card mb-3 @(notification.IsRead ? "" : "border-primary")" data-notification-id="@notification.Id">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2 gap-2 flex-wrap">
                            <div class="d-flex align-items-center gap-2 flex-grow-1 min-w-0">
                                <i class="bi @typeIcon text-primary flex-shrink-0"></i>
                                <h5 class="card-title mb-0 @(notification.IsRead ? "" : "fw-bold") text-break" style="word-wrap: break-word; overflow-wrap: break-word;">@notification.Title</h5>
                                @if (!notification.IsRead)
                                {
                                    <span class="badge bg-primary rounded-pill flex-shrink-0">جدید</span>
                                }
                            </div>
                            <div class="d-flex align-items-center gap-2 flex-shrink-0">
                                <span class="badge @priorityClass">@notification.Priority.GetDisplayName()</span>
                                @if (notification.ExpiresAt.HasValue && notification.ExpiresAt.Value < DateTimeOffset.UtcNow)
                                {
                                    <span class="badge bg-secondary">منقضی شده</span>
                                }
                            </div>
                        </div>
                        <p class="card-text text-muted mb-3 notification-message" style="word-wrap: break-word; overflow-wrap: break-word; word-break: break-word;">@notification.Message</p>
                        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                            <div class="text-muted small">
                                <i class="bi bi-clock"></i>
                                @notification.SentAt.ToPersianDateTimeString()
                                @if (notification.ExpiresAt.HasValue)
                                {
                                    <span class="ms-2">
                                        <i class="bi bi-calendar-x"></i>
                                        انقضا: @notification.ExpiresAt.Value.ToPersianDateString()
                                    </span>
                                }
                            </div>
                            @if (!notification.IsRead)
                            {
                                <form asp-action="MarkAsRead" method="post" class="d-inline mark-as-read-form">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@notification.Id" />
                                    <button type="submit" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-check"></i>
                                        علامت‌گذاری به عنوان خوانده شده
                                    </button>
                                </form>
                            }
                            else
                            {
                                <span class="text-muted small">
                                    <i class="bi bi-check-circle"></i>
                                    خوانده شده در @(notification.ReadAt?.ToPersianDateTimeString() ?? "")
                                </span>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Handle mark as read
            document.querySelectorAll('.mark-as-read-form').forEach(function (form) {
                form.addEventListener('submit', function (e) {
                    e.preventDefault();
                    var form = this;
                    var notificationCard = form.closest('[data-notification-id]');
                    var notificationId = form.querySelector('input[name="id"]').value;

                    fetch(form.action, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'RequestVerificationToken': form.querySelector('input[name="__RequestVerificationToken"]').value
                        },
                        body: new URLSearchParams({
                            id: notificationId,
                            __RequestVerificationToken: form.querySelector('input[name="__RequestVerificationToken"]').value
                        })
                    })
                    .then(function (response) {
                        return response.json();
                    })
                    .then(function (data) {
                        if (data.success) {
                            if (notificationCard) {
                                notificationCard.classList.remove('border-primary');
                                var title = notificationCard.querySelector('.card-title');
                                if (title) {
                                    title.classList.remove('fw-bold');
                                }
                                var newBadge = notificationCard.querySelector('.badge.bg-primary');
                                if (newBadge) {
                                    newBadge.remove();
                                }
                                form.outerHTML = '<span class="text-muted small"><i class="bi bi-check-circle"></i> خوانده شده</span>';
                            }
                        } else {
                            alert('خطا در به‌روزرسانی: ' + (data.error || 'خطای نامشخص'));
                        }
                    })
                    .catch(function (error) {
                        console.error('Error:', error);
                        alert('خطا در ارتباط با سرور');
                    });
                });
            });
        });
    </script>
}
