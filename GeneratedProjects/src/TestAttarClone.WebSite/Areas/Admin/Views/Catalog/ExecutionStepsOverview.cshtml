@using System.Globalization
@using System.Linq
@using TestAttarClone.Domain.Enums
@using TestAttarClone.SharedKernel.Extensions
@using TestAttarClone.WebSite.Areas.Admin.Models
@model ProductExecutionStepsOverviewViewModel
@{
    string FormatDate(DateTimeOffset? value) => value is null ? "-" : value.Value.ToPersianDateString();
    string FormatAverage(double value) => value <= 0 ? "0" : value.ToString("0.0", CultureInfo.InvariantCulture);
}

@section Head {
    <link rel="stylesheet" href="~/css/admin/catalog.css" asp-append-version="true" />
}

@section Breadcrumb {
    <li class="breadcrumb-item"><a asp-area="Admin" asp-controller="Dashboard" asp-action="Index">داشبورد</a></li>
    <li class="breadcrumb-item"><a asp-area="Admin" asp-controller="Catalog" asp-action="Index">مدیریت محصولات</a></li>
    <li class="breadcrumb-item active" aria-current="page">گام‌های اجرایی محصولات</li>
}

@await Html.PartialAsync("_StatusMessage")

<div class="product-steps-overview" data-product-steps-overview>
    <div class="product-steps-overview__hero">
        <div>
            <h1 class="product-steps-overview__title">@ViewData["Title"]</h1>
            <p class="product-steps-overview__subtitle">نمای کلی از آماده‌سازی محصولات برای ارائه و اجرای مؤثر</p>
        </div>
        <div class="product-steps-overview__actions">
            <a class="btn btn-outline-secondary" asp-area="Admin" asp-controller="Catalog" asp-action="Index">
                <i class="bi bi-box-seam"></i>
                بازگشت به محصولات
            </a>
            <a class="btn btn-primary" asp-area="Admin" asp-controller="Catalog" asp-action="Create">
                <i class="bi bi-plus-lg"></i>
                افزودن محصول جدید
            </a>
        </div>
    </div>

    <section class="product-steps-overview__metrics" aria-label="شاخص‌های کلیدی">
        <article class="product-steps-overview__metric-card product-steps-overview__metric-card--primary">
            <header>
                <div>
                    <span class="product-steps-overview__metric-label">کل گام‌های ثبت شده</span>
                    <h2 class="product-steps-overview__metric-value">@Model.TotalSteps</h2>
                </div>
                <span class="product-steps-overview__metric-icon"><i class="bi bi-kanban"></i></span>
            </header>
            <p>از @Model.ProductsWithSteps محصول فعال در حال اجرا</p>
        </article>
        <article class="product-steps-overview__metric-card product-steps-overview__metric-card--success">
            <header>
                <div>
                    <span class="product-steps-overview__metric-label">محصولات دارای ساختار</span>
                    <h2 class="product-steps-overview__metric-value">@Model.ProductsWithSteps</h2>
                </div>
                <span class="product-steps-overview__metric-icon"><i class="bi bi-clipboard-check"></i></span>
            </header>
            <p>از مجموع @Model.TotalProducts محصول موجود</p>
        </article>
        <article class="product-steps-overview__metric-card product-steps-overview__metric-card--info">
            <header>
                <div>
                    <span class="product-steps-overview__metric-label">میانگین گام در هر محصول</span>
                    <h2 class="product-steps-overview__metric-value">@FormatAverage(Model.AverageStepsPerProduct)</h2>
                </div>
                <span class="product-steps-overview__metric-icon"><i class="bi bi-graph-up"></i></span>
            </header>
            <p>@Model.ProductsWithoutSteps محصول نیازمند تعریف گام‌های اجرایی است</p>
        </article>
    </section>

    <section class="product-steps-overview__content card">
        <div class="card-body">
            <div class="product-steps-overview__content-header">
                <div>
                    <h2 class="product-steps-overview__content-title">وضعیت محصولات</h2>
                    <p class="product-steps-overview__content-subtitle">نمایش خلاصه‌ای از گام‌های اجرایی هر محصول و آخرین بروزرسانی</p>
                </div>
                <span class="product-steps-overview__content-count">@Model.Items.Count محصول</span>
            </div>

            @if (!Model.Items.Any())
            {
                <div class="product-steps-overview__empty">
                    <div class="product-steps-overview__empty-icon" aria-hidden="true"><i class="bi bi-inboxes"></i></div>
                    <h3>محصولی برای نمایش وجود ندارد</h3>
                    <p>ابتدا محصولی ایجاد کنید یا گام‌های اجرایی آن را ثبت نمایید.</p>
                </div>
            }
            else
            {
                <div class="product-steps-overview__grid" role="list">
                    @foreach (var item in Model.Items)
                    {
                        var statusClass = item.IsPublished ? "status-badge status-badge--published" : "status-badge status-badge--draft";
                        var statusText = item.IsPublished ? "منتشر شده" : "پیش‌نویس";
                        <article class="product-steps-overview__card" role="listitem">
                            <header class="product-steps-overview__card-header">
                                <div>
                                    <h3 class="product-steps-overview__card-title">@item.ProductName</h3>
                                    <span class="product-steps-overview__card-category">@item.CategoryName</span>
                                </div>
                                <span class="@statusClass">@statusText</span>
                            </header>
                            <div class="product-steps-overview__card-body">
                                <div class="product-steps-overview__card-meta">
                                    <span><i class="bi bi-kanban"></i> @item.StepCount گام</span>
                                    <span><i class="bi bi-clock-history"></i> بروزرسانی: @FormatDate(item.UpdatedAt)</span>
                                    <span><i class="bi bi-cpu"></i> نوع: @(item.Type == ProductType.Digital ? "دانلودی" : "فیزیکی")</span>
                                </div>
                                @if (item.StepCount == 0)
                                {
                                    <p class="product-steps-overview__card-alert">برای نمایش بهتر محصول، حداقل یک گام اجرایی تعریف کنید.</p>
                                }
                            </div>
                            <footer class="product-steps-overview__card-footer">
                                <a class="btn btn-outline-primary btn-sm" asp-area="Admin" asp-controller="Catalog" asp-action="ExecutionSteps" asp-route-id="@item.ProductId">
                                    <i class="bi bi-pencil-square"></i>
                                    مدیریت گام‌ها
                                </a>
                                <a class="btn btn-link btn-sm" asp-area="Admin" asp-controller="Catalog" asp-action="Edit" asp-route-id="@item.ProductId">
                                    <i class="bi bi-gear"></i>
                                    تنظیمات محصول
                                </a>
                            </footer>
                        </article>
                    }
                </div>
            }
        </div>
    </section>
</div>

@section Scripts {
    @{ await Html.RenderPartialAsync("_ValidationScriptsPartial"); }
}
