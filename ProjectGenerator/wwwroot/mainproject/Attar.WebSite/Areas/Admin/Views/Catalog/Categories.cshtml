@using System
@using System.Collections.Generic
@using System.Linq
@using Microsoft.AspNetCore.Mvc.Rendering
@model ProductCategoriesViewModel
@{
    var categories = Model.Categories?.ToList() ?? new List<ProductCategoryFlatItemViewModel>();
    var tree = Model.Tree?.ToList() ?? new List<ProductCategoryTreeItemViewModel>();
    var stats = Model.Statistics ?? new ProductCategoryStatisticsViewModel(0, 0, 0, 0, 0);
    var highlightId = Model.HighlightedCategoryId;
    var hasCategories = categories.Count > 0;
    var hasErrors = !ViewData.ModelState.IsValid && ViewData.ModelState.ErrorCount > 0;
    var shouldOpenCreateModal = hasErrors && Model.EditCategory.Id == Guid.Empty;
    var shouldOpenEditModal = hasErrors && Model.EditCategory.Id != Guid.Empty;
}

@section Head {
    <link rel="stylesheet" href="~/css/admin/catalog.css" asp-append-version="true" />
}

@section Breadcrumb {
    <li class="breadcrumb-item"><a asp-area="Admin" asp-controller="Dashboard" asp-action="Index">داشبورد</a></li>
    <li class="breadcrumb-item"><a asp-area="Admin" asp-controller="Catalog" asp-action="Index">محصولات</a></li>
    <li class="breadcrumb-item active" aria-current="page">@ViewData["Title"]</li>
}

@await Html.PartialAsync("_StatusMessage")

<div class="catalog-category-page" data-catalog-categories>
    <div class="catalog-category-page__hero">
        <div>
            <h1 class="catalog-category-page__title">دسته‌بندی‌های محصول</h1>
            <p class="catalog-category-page__subtitle">ساختاردهی سلسله‌مراتبی، مدیریت والدین و بهینه‌سازی سئو</p>
        </div>
        <div class="catalog-category-page__actions">
            <a class="btn btn-outline-primary" asp-area="Admin" asp-controller="Catalog" asp-action="Index" style="margin:auto">
                <i class="bi bi-bag"></i>
                بازگشت به محصولات
            </a>
            <button class="btn btn-primary" type="button" data-bs-toggle="modal" data-bs-target="#createCategoryModal" style="margin:auto">
                <i class="bi bi-plus-lg"></i>
                دسته‌بندی جدید
            </button>
        </div>
    </div>

    <section class="catalog-category-stats">
        <article class="catalog-category-stats__card catalog-category-stats__card--primary">
            <div class="catalog-category-stats__icon"><i class="bi bi-diagram-3"></i></div>
            <div class="catalog-category-stats__body">
                <span class="catalog-category-stats__label">تعداد کل دسته‌ها</span>
                <strong class="catalog-category-stats__value">@stats.Total</strong>
                <small class="catalog-category-stats__hint">تمام سطوح سلسله‌مراتب محصولات</small>
            </div>
        </article>
        <article class="catalog-category-stats__card catalog-category-stats__card--success">
            <div class="catalog-category-stats__icon"><i class="bi bi-diagram-3-fill"></i></div>
            <div class="catalog-category-stats__body">
                <span class="catalog-category-stats__label">دسته‌های سطح اول</span>
                <strong class="catalog-category-stats__value">@stats.RootCount</strong>
                <small class="catalog-category-stats__hint">ریشه‌های اصلی ساختار فروشگاه</small>
            </div>
        </article>
        <article class="catalog-category-stats__card catalog-category-stats__card--info">
            <div class="catalog-category-stats__icon"><i class="bi bi-node-plus"></i></div>
            <div class="catalog-category-stats__body">
                <span class="catalog-category-stats__label">دسته‌های شاخه‌ای</span>
                <strong class="catalog-category-stats__value">@stats.BranchCount</strong>
                <small class="catalog-category-stats__hint">دارای زیرمجموعه فعال</small>
            </div>
        </article>
        <article class="catalog-category-stats__card catalog-category-stats__card--warning">
            <div class="catalog-category-stats__icon"><i class="bi bi-dot"></i></div>
            <div class="catalog-category-stats__body">
                <span class="catalog-category-stats__label">دسته‌های برگ</span>
                <strong class="catalog-category-stats__value">@stats.LeafCount</strong>
                <small class="catalog-category-stats__hint">آخرین سطح درخت محصولات</small>
            </div>
        </article>
    </section>

    <div class="row g-4">
        <div class="col-12">
            @if (hasCategories)
            {
                <div class="catalog-category-table card">
                    <div class="card-body">
                        <div class="catalog-category-table__header">
                            <div>
                                <h2 class="catalog-category-table__title">فهرست دسته‌ها</h2>
                                <p class="catalog-category-table__subtitle">جزئیات هر دسته، والد مربوطه و عملیات مدیریتی</p>
                            </div>
                        </div>
                        <div class="table-responsive" style="min-height:200px;">
                            <table class="table align-middle">
                                <thead>
                                    <tr>
                                        <th scope="col">نام</th>
                                        <th scope="col">Slug</th>
                                        <th scope="col">والد</th>
                                        <th scope="col">سطح</th>
                                        <th scope="col" class="text-end">اقدامات</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @{
                                        async Task RenderCategoryRow(ProductCategoryTreeItemViewModel category, int level = 0)
                                        {
                                            var indent = level * 25;
                                            var hasChildren = category.Children?.Any() ?? false;
                                            var isHighlighted = highlightId is not null && category.Id == highlightId;
                                            <tr class="@(isHighlighted ? "table-primary" : string.Empty) category-row" 
                                                data-category-id="@category.Id" 
                                                data-parent-id="@(category.ParentId?.ToString() ?? "")" 
                                                data-level="@level"
                                                style="display: @(level == 0 ? "table-row" : "none");">
                                                <td style="padding-right: @(indent)px;">
                                                    <div class="d-flex align-items-center gap-2">
                                                        @if (hasChildren)
                                                        {
                                                            <button type="button" class="btn btn-sm btn-link p-0 text-decoration-none" onclick="toggleCategoryChildren('@category.Id')" style="min-width: 20px;">
                                                                <i class="bi bi-chevron-down" id="category-icon-@category.Id"></i>
                                                            </button>
                                                        }
                                                        else
                                                        {
                                                            <span style="min-width: 20px; display: inline-block;"></span>
                                                        }
                                                        <div>
                                                            <strong>@category.Name</strong>
                                                            @if (!string.IsNullOrWhiteSpace(category.Description))
                                                            {
                                                                <div class="text-muted small">@category.Description</div>
                                                            }
                                                        </div>
                                                    </div>
                                                </td>
                                                <td>@(string.IsNullOrWhiteSpace(category.Slug) ? "-" : category.Slug)</td>
                                                <td>@(category.ParentId.HasValue ? (Model.Tree.SelectMany(t => FlattenTree(t)).FirstOrDefault(c => c.Id == category.ParentId.Value)?.Name ?? "-") : "بدون والد")</td>
                                                <td>@category.Depth</td>
                                                <td class="text-end">
                                                    <div class="dropdown">
                                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                                            <i class="bi bi-three-dots-vertical"></i>
                                                        </button>
                                                        <ul class="dropdown-menu">
                                                            <li>
                                                                <button type="button" class="dropdown-item" data-catalog-edit-category data-category-id="@category.Id">
                                                                    <i class="bi bi-pencil me-2"></i>ویرایش
                                                                </button>
                                                            </li>
                                                            @if (hasChildren)
                                                            {
                                                                <li>
                                                                    <a class="dropdown-item" href="#" onclick="toggleCategoryChildren('@category.Id'); return false;">
                                                                        <i class="bi bi-list-nested me-2"></i>زیرمجموعه‌ها
                                                                    </a>
                                                                </li>
                                                            }
                                                            <li><hr class="dropdown-divider"></li>
                                                            <li>
                                                                <form asp-area="Admin" asp-controller="Catalog" asp-action="DeleteCategory" method="post" class="d-inline">
                                                                    @Html.AntiForgeryToken()
                                                                    <input type="hidden" name="id" value="@category.Id" />
                                                                    <button type="submit" class="dropdown-item text-danger" onclick="return confirm('حذف این دسته‌بندی تایید می‌شود؟');">
                                                                        <i class="bi bi-trash me-2"></i>حذف
                                                                    </button>
                                                                </form>
                                                            </li>
                                                        </ul>
                                                    </div>
                                                </td>
                                            </tr>
                                            @if (hasChildren)
                                            {
                                                foreach (var child in category.Children.OrderBy(c => c.Name))
                                                {
                                                    await RenderCategoryRow(child, level + 1);
                                                }
                                            }
                                        }
                                        
                                        List<ProductCategoryTreeItemViewModel> FlattenTree(ProductCategoryTreeItemViewModel node)
                                        {
                                            var result = new List<ProductCategoryTreeItemViewModel> { node };
                                            foreach (var child in node.Children ?? Array.Empty<ProductCategoryTreeItemViewModel>())
                                            {
                                                result.AddRange(FlattenTree(child));
                                            }
                                            return result;
                                        }
                                    }
                                    @foreach (var category in Model.Tree.OrderBy(c => c.Name))
                                    {
                                        await RenderCategoryRow(category, 0);
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            }
            else
            {
                <div class="catalog-category-empty card">
                    <div class="card-body text-center py-5">
                        <div class="catalog-category-empty__icon" aria-hidden="true"><i class="bi bi-diagram-3"></i></div>
                        <h3 class="catalog-category-empty__title">دسته‌بندی‌ای ثبت نشده است</h3>
                        <p class="catalog-category-empty__subtitle">برای شروع ساختار فروشگاه، دسته‌بندی جدیدی ایجاد کنید.</p>
                        <button class="btn btn-primary" type="button" data-bs-toggle="modal" data-bs-target="#createCategoryModal">
                            <i class="bi bi-plus-lg"></i>
                            ساخت دسته‌بندی
                        </button>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<div class="modal fade" id="createCategoryModal" tabindex="-1" aria-labelledby="createCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title fs-5" id="createCategoryModalLabel">ایجاد دسته‌بندی جدید</h2>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="بستن"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-4">نام، مسیر سئو و والد دلخواه را مشخص کنید.</p>
                <form asp-area="Admin" asp-controller="Catalog" asp-action="CreateCategory" method="post" enctype="multipart/form-data" novalidate>
                    @Html.AntiForgeryToken()
                    <div class="mb-3">
                        <label class="form-label" for="createCategoryName">نام دسته‌بندی</label>
                        <input id="createCategoryName" name="Name" class="form-control" value="@Model.CreateCategory.Name" required />
                        @Html.ValidationMessage("Name", new { @class = "text-danger" })
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="createCategorySlug">Slug</label>
                        <input id="createCategorySlug" name="Slug" class="form-control" value="@Model.CreateCategory.Slug" />
                        @Html.ValidationMessage("Slug", new { @class = "text-danger" })
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="createCategoryParent">دسته‌بندی والد</label>
                        <select id="createCategoryParent" name="ParentId" class="form-select" asp-items="Model.CreateParentOptions"></select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="createCategoryImageFile">تصویر</label>
                        <input type="file" id="createCategoryImageFile" name="ImageFile" class="form-control" accept="image/jpeg,image/jpg,image/png,image/webp,image/gif" />
                        <span class="form-text text-muted">حداکثر حجم فایل: 100 کیلوبایت. فرمت‌های مجاز: JPG, PNG, WEBP, GIF</span>
                        @Html.ValidationMessage("ImageFile", new { @class = "text-danger" })
                    </div>
                    <div class="mb-4">
                        <label class="form-label" for="createCategoryDescription">توضیحات</label>
                        <textarea id="createCategoryDescription" name="Description" class="form-control" rows="3">@Model.CreateCategory.Description</textarea>
                    </div>
                    <div class="d-flex gap-2 justify-content-end">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">انصراف</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-plus-lg"></i>
                            ذخیره دسته‌بندی
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editCategoryModal" tabindex="-1" aria-labelledby="editCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title fs-5" id="editCategoryModalLabel">ویرایش دسته‌بندی</h2>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="بستن"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-4">اطلاعات دسته انتخاب‌شده را بروزرسانی کنید.</p>
                <form asp-area="Admin" asp-controller="Catalog" asp-action="UpdateCategory" method="post" id="catalogCategoryEditForm" enctype="multipart/form-data" novalidate>
                    @Html.AntiForgeryToken()
                    <input type="hidden" id="editCategoryId" name="Id" value="@Model.EditCategory.Id" />
                    <div class="mb-3">
                        <label class="form-label" for="editCategoryName">نام دسته‌بندی</label>
                        <input id="editCategoryName" name="Name" class="form-control" value="@Model.EditCategory.Name" required />
                        @Html.ValidationMessage("Name", new { @class = "text-danger" })
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="editCategorySlug">Slug</label>
                        <input id="editCategorySlug" name="Slug" class="form-control" value="@Model.EditCategory.Slug" />
                        @Html.ValidationMessage("Slug", new { @class = "text-danger" })
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="editCategoryParent">دسته‌بندی والد</label>
                        <select id="editCategoryParent" name="ParentId" class="form-select" asp-items="Model.EditParentOptions"></select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="editCategoryImageFile">تصویر</label>
                        <input type="file" id="editCategoryImageFile" name="ImageFile" class="form-control" accept="image/jpeg,image/jpg,image/png,image/webp,image/gif" />
                        <span class="form-text text-muted">حداکثر حجم فایل: 100 کیلوبایت. فرمت‌های مجاز: JPG, PNG, WEBP, GIF</span>
                        @if (!string.IsNullOrWhiteSpace(Model.EditCategory.ImageUrl))
                        {
                            <div class="mt-2">
                                <label class="form-label small">تصویر فعلی:</label>
                                <div>
                                    <img src="@Model.EditCategory.ImageUrl" alt="Preview" class="img-thumbnail" style="max-width: 200px; max-height: 200px;" />
                                    <div class="form-check mt-2">
                                        <input class="form-check-input" type="checkbox" id="removeCategoryImage" name="removeImage" value="true">
                                        <label class="form-check-label" for="removeCategoryImage">
                                            حذف تصویر فعلی
                                        </label>
                                    </div>
                                </div>
                            </div>
                        }
                        @Html.ValidationMessage("ImageFile", new { @class = "text-danger" })
                    </div>
                    <div class="mb-4">
                        <label class="form-label" for="editCategoryDescription">توضیحات</label>
                        <textarea id="editCategoryDescription" name="Description" class="form-control" rows="3">@Model.EditCategory.Description</textarea>
                    </div>
                    <div class="d-flex gap-2 justify-content-end">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" data-catalog-reset-edit>انصراف</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-floppy"></i>
                            ذخیره تغییرات
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function toggleCategoryChildren(categoryId) {
            const currentRow = document.querySelector(`tr[data-category-id="${categoryId}"]`);
            if (!currentRow) return;
            
            const allRows = Array.from(document.querySelectorAll('tbody tr.category-row'));
            const currentIndex = allRows.indexOf(currentRow);
            const currentLevel = parseInt(currentRow.getAttribute('data-level') || '0');
            const icon = document.getElementById(`category-icon-${categoryId}`);
            
            // Find all direct children (rows with parent-id matching this category-id)
            const children = [];
            for (let i = currentIndex + 1; i < allRows.length; i++) {
                const row = allRows[i];
                const rowParentId = row.getAttribute('data-parent-id');
                const rowLevel = parseInt(row.getAttribute('data-level') || '0');
                
                // If we hit a row at same or lower level, it's not a child
                if (rowLevel <= currentLevel && rowParentId !== categoryId) {
                    break;
                }
                
                if (rowParentId === categoryId) {
                    children.push(row);
                }
            }
            
            if (children.length === 0) return;
            
            const isExpanded = children[0].style.display !== 'none';
            
            children.forEach(row => {
                if (isExpanded) {
                    row.style.display = 'none';
                    // Hide all nested children recursively
                    const childId = row.getAttribute('data-category-id');
                    if (childId) {
                        hideCategoryChildrenRecursive(childId);
                    }
                } else {
                    row.style.display = 'table-row';
                }
            });
            
            if (icon) {
                if (isExpanded) {
                    icon.classList.remove('bi-chevron-up');
                    icon.classList.add('bi-chevron-down');
                } else {
                    icon.classList.remove('bi-chevron-down');
                    icon.classList.add('bi-chevron-up');
                }
            }
        }
        
        function hideCategoryChildrenRecursive(categoryId) {
            const allRows = Array.from(document.querySelectorAll('tbody tr.category-row'));
            const currentRow = allRows.find(r => r.getAttribute('data-category-id') === categoryId);
            if (!currentRow) return;
            
            const currentIndex = allRows.indexOf(currentRow);
            const currentLevel = parseInt(currentRow.getAttribute('data-level') || '0');
            
            for (let i = currentIndex + 1; i < allRows.length; i++) {
                const row = allRows[i];
                const rowParentId = row.getAttribute('data-parent-id');
                const rowLevel = parseInt(row.getAttribute('data-level') || '0');
                
                if (rowLevel <= currentLevel && rowParentId !== categoryId) {
                    break;
                }
                
                if (rowParentId === categoryId) {
                    row.style.display = 'none';
                    const icon = document.getElementById(`category-icon-${categoryId}`);
                    if (icon) {
                        icon.classList.remove('bi-chevron-up');
                        icon.classList.add('bi-chevron-down');
                    }
                    const childId = row.getAttribute('data-category-id');
                    if (childId) {
                        hideCategoryChildrenRecursive(childId);
                    }
                }
            }
        }

        (function () {
            const editButtons = document.querySelectorAll('[data-catalog-edit-category]');
            const editForm = document.getElementById('catalogCategoryEditForm');
            const editParentSelect = document.getElementById('editCategoryParent');
            const bootstrapRef = window.bootstrap;
            const createModalElement = document.getElementById('createCategoryModal');
            const editModalElement = document.getElementById('editCategoryModal');
            const createModal = createModalElement && bootstrapRef ? bootstrapRef.Modal.getOrCreateInstance(createModalElement) : null;
            const editModal = editModalElement && bootstrapRef ? bootstrapRef.Modal.getOrCreateInstance(editModalElement) : null;
            const resetButton = editModalElement ? editModalElement.querySelector('[data-catalog-reset-edit]') : null;

            function disableSelfOption(categoryId) {
                if (!editParentSelect) {
                    return;
                }

                Array.from(editParentSelect.options).forEach(option => {
                    option.disabled = false;
                });

                if (!categoryId) {
                    return;
                }

                const selfOption = Array.from(editParentSelect.options).find(option => option.value === categoryId);
                if (selfOption) {
                    selfOption.disabled = true;
                    if (editParentSelect.value === categoryId) {
                        editParentSelect.value = '';
                    }
                }
            }

            function populateEditForm(row) {
                if (!editForm || !row) {
                    return;
                }

                const id = row.dataset.categoryId || '';
                const name = row.dataset.categoryName || '';
                const slug = row.dataset.categorySlug || '';
                const description = row.dataset.categoryDescription || '';
                const parent = row.dataset.categoryParent || '';

                editForm.querySelector('#editCategoryId').value = id;
                editForm.querySelector('#editCategoryName').value = name;
                editForm.querySelector('#editCategorySlug').value = slug;
                editForm.querySelector('#editCategoryDescription').value = description;
                if (editParentSelect) {
                    editParentSelect.value = parent;
                }

                disableSelfOption(id);
                editModal?.show();
            }

            editButtons.forEach(button => {
                button.addEventListener('click', function () {
                    const categoryId = this.getAttribute('data-category-id');
                    const row = categoryId ? document.querySelector(`tr[data-category-id="${categoryId}"]`) : null;
                    if (row) {
                        const name = row.querySelector('strong')?.textContent?.trim() || '';
                        const slug = row.cells[1]?.textContent?.trim() || '';
                        const description = row.querySelector('.text-muted.small')?.textContent?.trim() || '';
                        const parentName = row.cells[2]?.textContent?.trim() || '';
                        
                        // Find parent ID from tree data
                        const parentRow = Array.from(document.querySelectorAll('tr[data-category-id]'))
                            .find(r => r.querySelector('strong')?.textContent?.trim() === parentName && parentName !== 'بدون والد');
                        const parentId = parentRow ? parentRow.getAttribute('data-category-id') : '';
                        
                        editForm.querySelector('#editCategoryId').value = categoryId;
                        editForm.querySelector('#editCategoryName').value = name;
                        editForm.querySelector('#editCategorySlug').value = slug;
                        editForm.querySelector('#editCategoryDescription').value = description;
                        if (editParentSelect) {
                            editParentSelect.value = parentId;
                        }
                        
                        disableSelfOption(categoryId);
                        editModal?.show();
                    }
                });
            });

            resetButton?.addEventListener('click', function () {
                if (!editForm) {
                    return;
                }

                editForm.reset();
                disableSelfOption('');
                editModal?.hide();
            });

            if (editModalElement && bootstrapRef) {
                editModalElement.addEventListener('hidden.bs.modal', function () {
                    if (!editForm) {
                        return;
                    }

                    editForm.reset();
                    disableSelfOption('');
                });
            }

            const showCreateModal = @((shouldOpenCreateModal ? "true" : "false"));
            const showEditModal = @((shouldOpenEditModal ? "true" : "false"));

            if (showCreateModal === 'true' && createModal) {
                createModal.show();
            }

            if (showEditModal === 'true' && editModal && editForm) {
                const currentId = editForm.querySelector('#editCategoryId')?.value ?? '';
                disableSelfOption(currentId);
                editModal.show();
            }
        })();
    </script>
}
