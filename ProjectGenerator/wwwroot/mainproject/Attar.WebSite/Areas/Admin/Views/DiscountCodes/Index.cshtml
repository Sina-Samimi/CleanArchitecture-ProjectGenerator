@using System.Globalization
@model DiscountCodeIndexViewModel
@{
    ViewData["Title"] ??= "کدهای تخفیف";
    ViewData["Subtitle"] ??= "مدیریت کوپن‌های فروشگاه، زمان‌بندی و محدودیت‌های مصرف";

    var summary = Model.Summary ?? new DiscountCodeSummaryViewModel();
    var items = Model.Items?.ToList() ?? new List<DiscountCodeListItemViewModel>();
    var hasItems = items.Count > 0;
    var persianCulture = new CultureInfo("fa-IR");

    string FormatMoney(decimal? value)
    {
        if (value is null)
        {
            return "-";
        }

        return string.Format(persianCulture, "{0:N0} تومان", value.Value);
    }

    string FormatDiscountValue(DiscountCodeListItemViewModel item)
    {
        return item.DiscountType switch
        {
            DiscountType.Percentage => string.Format(persianCulture, "{0:0.##}%", item.DiscountValue),
            _ => string.Format(persianCulture, "{0:N0} تومان", item.DiscountValue)
        };
    }

    string FormatStatusLabel(DiscountCodeListItemViewModel item)
    {
        if (!item.IsActive)
        {
            return "غیرفعال";
        }

        if (item.IsExpired)
        {
            return "منقضی";
        }

        if (item.IsScheduled)
        {
            return "در انتظار شروع";
        }

        return "در حال اجرا";
    }

    string StatusBadgeClass(DiscountCodeListItemViewModel item)
    {
        if (!item.IsActive)
        {
            return "badge bg-secondary-subtle text-secondary-emphasis";
        }

        if (item.IsExpired)
        {
            return "badge bg-danger-subtle text-danger-emphasis";
        }

        if (item.IsScheduled)
        {
            return "badge bg-warning-subtle text-warning-emphasis";
        }

        return "badge bg-success-subtle text-success-emphasis";
    }

    string DiscountTypeBadgeClass(DiscountCodeListItemViewModel item)
    {
        return item.DiscountType switch
        {
            DiscountType.Percentage => "badge bg-primary-subtle text-primary-emphasis",
            DiscountType.FixedAmount => "badge bg-info-subtle text-info-emphasis",
            _ => "badge bg-secondary-subtle text-secondary-emphasis"
        };
    }

    string FormatDate(DateTimeOffset value) => value.ToPersianDateTimeString();
    string? FormatDateNullable(DateTimeOffset? value) => value is null ? null : FormatDate(value.Value);
}

@section Head {
    <link rel="stylesheet" href="~/plugins/jalalidatepicker/css/jalalidatepicker.min.css" />
    <link rel="stylesheet" href="~/css/admin/discount-codes.css" asp-append-version="true" />
}

@section Breadcrumb {
    <li class="breadcrumb-item"><a asp-area="Admin" asp-controller="Dashboard" asp-action="Index">داشبورد</a></li>
    <li class="breadcrumb-item"><a asp-area="Admin" asp-controller="Catalog" asp-action="Index">فروشگاه</a></li>
    <li class="breadcrumb-item active" aria-current="page">@ViewData["Title"]</li>
}

@await Html.PartialAsync("_StatusMessage")

<div class="discount-page" data-discount-index>
    <div class="discount-page__hero">
        <div>
            <h1 class="discount-page__title">@ViewData["Title"]</h1>
            <p class="discount-page__subtitle">@ViewData["Subtitle"]</p>
        </div>
        <div class="discount-page__actions">
            <button type="button"
                    class="btn btn-primary"
                    data-discount-modal-trigger
                    data-modal-url="@Url.Action("Create")">
                <i class="bi bi-plus-lg"></i>
                کد تخفیف جدید
            </button>
        </div>
    </div>

    <div class="discount-metrics">
        <article class="discount-metric-card">
            <div class="discount-metric-card__header">
                <div>
                    <span class="discount-metric-card__label">کل کدها</span>
                    <h2 class="discount-metric-card__value">@summary.TotalCodes</h2>
                </div>
                <span class="discount-metric-card__icon">
                    <i class="bi bi-ticket-perforated"></i>
                </span>
            </div>
            <div class="discount-metric-card__body">
                <span class="discount-chip discount-chip--success">
                    <i class="bi bi-lightning-charge"></i>
                    فعال: @summary.ActiveCodes
                </span>
                <span class="discount-chip discount-chip--warning">
                    <i class="bi bi-clock-history"></i>
                    برنامه‌ریزی‌شده: @summary.ScheduledCodes
                </span>
                <span class="discount-chip discount-chip--muted">
                    <i class="bi bi-x-octagon"></i>
                    منقضی: @summary.ExpiredCodes
                </span>
            </div>
        </article>
        <article class="discount-metric-card">
            <div class="discount-metric-card__header">
                <div>
                    <span class="discount-metric-card__label">نوع تخفیف</span>
                    <h2 class="discount-metric-card__value">@summary.PercentageCodes درصدی</h2>
                </div>
                <span class="discount-metric-card__icon">
                    <i class="bi bi-percent"></i>
                </span>
            </div>
            <div class="discount-metric-card__body">
                <span class="discount-chip discount-chip--primary">
                    <i class="bi bi-cash-stack"></i>
                    مبلغی: @summary.FixedAmountCodes
                </span>
                <span class="discount-chip discount-chip--accent">
                    <i class="bi bi-people"></i>
                    با گروه‌بندی: @summary.GroupRestrictedCodes
                </span>
            </div>
        </article>
        <article class="discount-metric-card">
            <div class="discount-metric-card__header">
                <div>
                    <span class="discount-metric-card__label">کنترل مصرف</span>
                    <h2 class="discount-metric-card__value">@summary.LimitedUsageCodes با سقف</h2>
                </div>
                <span class="discount-metric-card__icon">
                    <i class="bi bi-bar-chart-line"></i>
                </span>
            </div>
            <div class="discount-metric-card__body">
                <span class="discount-chip discount-chip--info">
                    <i class="bi bi-calendar-event"></i>
                    به‌روزرسانی: @Model.GeneratedAt.ToPersianDateTimeString()
                </span>
            </div>
        </article>
    </div>

    @if (!hasItems)
    {
        <div class="discount-empty">
            <div class="discount-empty__icon">
                <i class="bi bi-ticket"></i>
            </div>
            <h3 class="discount-empty__title">هنوز کد تخفیفی ثبت نشده است</h3>
            <p class="discount-empty__description">
                برای جذب کاربران و افزایش فروش، اولین کد تخفیف خود را ایجاد کنید. می‌توانید تخفیف درصدی یا مبلغی، محدودیت زمانی و گروهی تعیین کنید.
            </p>
            <button type="button"
                    class="btn btn-primary"
                    data-discount-modal-trigger
                    data-modal-url="@Url.Action("Create")">
                <i class="bi bi-plus-lg"></i>
                ساخت اولین کد تخفیف
            </button>
        </div>
    }
    else
    {
        <div class="discount-list">
            @foreach (var item in items)
            {
                <article class="discount-card" data-discount-card>
                    <div class="discount-card__header">
                        <div class="discount-card__identity">
                            <span class="discount-card__code">@item.Code</span>
                            <div>
                                <h3 class="discount-card__title">@item.Name</h3>
                                @if (!string.IsNullOrWhiteSpace(item.Description))
                                {
                                    <p class="discount-card__description">@item.Description</p>
                                }
                            </div>
                        </div>
                        <div class="discount-card__status">
                            <span class="@StatusBadgeClass(item)">@FormatStatusLabel(item)</span>
                            <span class="@DiscountTypeBadgeClass(item)">@FormatDiscountValue(item)</span>
                        </div>
                    </div>

                    <div class="discount-card__body">
                        <div class="discount-card__grid">
                            <div class="discount-card__cell">
                                <span class="discount-card__label">زمان‌بندی</span>
                                <span class="discount-card__value">از @FormatDate(item.StartsAt)</span>
                                <span class="discount-card__value">تا @(FormatDateNullable(item.EndsAt) ?? "بدون پایان")</span>
                            </div>
                            <div class="discount-card__cell">
                                <span class="discount-card__label">محدودیت سفارش</span>
                                <span class="discount-card__value">حداقل سفارش: @(item.MinimumOrderAmount is null ? "-" : FormatMoney(item.MinimumOrderAmount))</span>
                                <span class="discount-card__value">سقف تخفیف: @(item.MaxDiscountAmount is null ? "بدون سقف" : FormatMoney(item.MaxDiscountAmount))</span>
                            </div>
                            <div class="discount-card__cell">
                                <span class="discount-card__label">مصرف</span>
                                <span class="discount-card__value">استفاده شده: @item.TotalRedemptions</span>
                                <span class="discount-card__value">
                                    سقف کلی:
                                    @(item.GlobalUsageLimit is null
                                        ? "نامحدود"
                                        : string.Format(persianCulture, "{0} نفر (باقی‌مانده {1})",
                                            item.GlobalUsageLimit,
                                            item.RemainingGlobalUses ?? 0))
                                </span>
                            </div>
                        </div>

                        @if (item.GroupRules.Count > 0)
                        {
                            <div class="discount-card__groups" data-discount-groups>
                                <div class="discount-card__groups-header">
                                    <i class="bi bi-people"></i>
                                    <span>قوانین گروهی</span>
                                    <span class="badge bg-secondary-subtle text-secondary-emphasis">@item.GroupRules.Count گروه</span>
                                </div>
                                <div class="discount-card__groups-body">
                                    @foreach (var group in item.GroupRules)
                                    {
                                        <div class="discount-group-chip">
                                            <div class="discount-group-chip__header">
                                                <span class="discount-group-chip__key">@group.Key</span>
                                                @if (group.UsageLimit is not null)
                                                {
                                                    <span class="discount-group-chip__limit">
                                                        سقف @group.UsageLimit بار
                                                    </span>
                                                }
                                            </div>
                                            <div class="discount-group-chip__details">
                                                <span>
                                                    مصرف شده: @group.UsedCount
                                                    @if (group.RemainingUses is not null)
                                                    {
                                                        <span class="text-muted">(باقی‌مانده @group.RemainingUses)</span>
                                                    }
                                                </span>
                                                <span>
                                                    تخفیف: @(group.DiscountTypeOverride is null
                                                        ? "مطابق تنظیم اصلی"
                                                        : group.DiscountTypeOverride == DiscountType.Percentage
                                                            ? string.Format(persianCulture, "{0:0.##}%", group.DiscountValueOverride)
                                                            : FormatMoney(group.DiscountValueOverride))
                                                </span>
                                                <span>
                                                    سقف گروه: @(group.MaxDiscountAmountOverride is null ? "--" : FormatMoney(group.MaxDiscountAmountOverride))
                                                </span>
                                                <span>
                                                    حداقل سفارش: @(group.MinimumOrderAmountOverride is null ? "--" : FormatMoney(group.MinimumOrderAmountOverride))
                                                </span>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>

                    <div class="discount-card__footer">
                        <button type="button"
                                class="btn btn-light"
                                data-discount-modal-trigger
                                data-modal-url="@Url.Action("Edit", new { id = item.Id })">
                            <i class="bi bi-pencil"></i>
                            ویرایش کد
                        </button>
                        <a class="btn btn-outline-primary"
                           asp-area="Admin"
                           asp-controller="Catalog"
                           asp-action="Index"
                           asp-route-discount="@item.Code">
                            <i class="bi bi-arrow-up-right-square"></i>
                            مشاهده محصولات مرتبط
                        </a>
                    </div>
                </article>
            }
        </div>
    }
</div>

<div class="modal fade" id="discountCodeModal" tabindex="-1" aria-hidden="true" data-discount-modal></div>

@section Scripts {
    <script src="~/plugins/jalalidatepicker/js/jalalidatepicker.min.js"></script>
    <script src="~/js/admin/discount-codes.js" asp-append-version="true"></script>
}
