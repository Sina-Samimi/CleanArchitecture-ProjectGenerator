@model CreateNotificationViewModel
@{
    ViewData["Title"] = "ارسال اعلان";
    var selectedRoles = new HashSet<string>(Model.SelectedRoles ?? new List<string>(), StringComparer.OrdinalIgnoreCase);
    var selectedUserIds = new HashSet<string>(Model.SelectedUserIds ?? new List<string>(), StringComparer.OrdinalIgnoreCase);
}

<h1 class="mb-4">ارسال اعلان جدید</h1>

@if (TempData["Success"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["Success"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<form asp-action="Create" method="post" class="card">
    <div class="card-body">
        <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>

        <div class="mb-3">
            <label asp-for="Title" class="form-label"></label>
            <input asp-for="Title" class="form-control" placeholder="مثلاً: اطلاعیه مهم" />
            <span asp-validation-for="Title" class="text-danger"></span>
        </div>

        <div class="mb-3">
            <label asp-for="Message" class="form-label"></label>
            <textarea asp-for="Message" class="form-control" rows="5" placeholder="متن اعلان را وارد کنید..."></textarea>
            <span asp-validation-for="Message" class="text-danger"></span>
        </div>

        <div class="row">
            <div class="col-md-6 mb-3">
                <label asp-for="Type" class="form-label"></label>
                <select asp-for="Type" class="form-select" asp-items="Model.TypeOptions">
                </select>
                <span asp-validation-for="Type" class="text-danger"></span>
            </div>

            <div class="col-md-6 mb-3">
                <label asp-for="Priority" class="form-label"></label>
                <select asp-for="Priority" class="form-select" asp-items="Model.PriorityOptions">
                </select>
                <span asp-validation-for="Priority" class="text-danger"></span>
            </div>
        </div>

        <div class="mb-3">
            <label asp-for="ExpiresAtPersian" class="form-label"></label>
            <div class="jalali-picker" data-jalali-picker>
                <div class="jalali-picker__controls">
                    <input type="text"
                           class="form-control"
                           placeholder="انتخاب تاریخ انقضا (اختیاری)"
                           value="@(Model.ExpiresAtPersian?.Replace("-", "/") ?? string.Empty)"
                           data-jalali-input
                           data-jdp
                           data-jdp-only-date
                           data-jdp-init-date="@(Model.ExpiresAtPersian?.Replace("-", "/") ?? string.Empty)"
                           autocomplete="off"
                           dir="ltr" />
                </div>
                <input asp-for="ExpiresAtPersian" type="hidden" data-jalali-target />
            </div>
            <span asp-validation-for="ExpiresAtPersian" class="text-danger"></span>
            <small class="form-text text-muted">در صورت خالی بودن، اعلان منقضی نمی‌شود.</small>
        </div>

        <hr class="my-4" />

        <h5 class="mb-3">فیلتر گیرندگان</h5>
        <p class="text-muted small mb-4">می‌توانید اعلان را بر اساس نقش، تاریخ عضویت یا کاربران خاص ارسال کنید.</p>

        <div class="mb-3">
            <label class="form-label">نقش‌ها</label>
            <div class="role-select" data-role-select>
                <div class="role-select__options">
                    @if (Model.AvailableRoles.Count == 0)
                    {
                        <div class="text-muted small">نقشی برای انتخاب موجود نیست.</div>
                    }
                    else
                    {
                        @foreach (var role in Model.AvailableRoles)
                        {
                            var optionId = $"notification-role-{role.Value}";
                            var isSelected = selectedRoles.Contains(role.Value ?? string.Empty);
                            <label class="role-select__option @(isSelected ? "is-selected" : string.Empty)" for="@optionId">
                                <input type="checkbox"
                                       id="@optionId"
                                       name="SelectedRoles"
                                       value="@role.Value"
                                       class="form-check-input"
                                       @(isSelected ? "checked" : null)
                                       data-role-option>
                                <span>@role.Text</span>
                            </label>
                        }
                    }
                </div>
            </div>
            <small class="form-text text-muted">در صورت انتخاب نقش، اعلان به تمام کاربران با آن نقش ارسال می‌شود.</small>
        </div>

        <div class="row">
            <div class="col-md-6 mb-3">
                <label asp-for="RegisteredFromPersian" class="form-label">تاریخ عضویت از</label>
                <div class="jalali-picker" data-jalali-picker>
                    <div class="jalali-picker__controls">
                        <input type="text"
                               class="form-control"
                               placeholder="انتخاب تاریخ"
                               value="@(Model.RegisteredFromPersian?.Replace("-", "/") ?? string.Empty)"
                               data-jalali-input
                               data-jdp
                               data-jdp-only-date
                               data-jdp-init-date="@(Model.RegisteredFromPersian?.Replace("-", "/") ?? string.Empty)"
                               autocomplete="off"
                               dir="ltr" />
                    </div>
                    <input asp-for="RegisteredFromPersian" type="hidden" data-jalali-target />
                </div>
                <span asp-validation-for="RegisteredFromPersian" class="text-danger"></span>
            </div>

            <div class="col-md-6 mb-3">
                <label asp-for="RegisteredToPersian" class="form-label">تاریخ عضویت تا</label>
                <div class="jalali-picker" data-jalali-picker>
                    <div class="jalali-picker__controls">
                        <input type="text"
                               class="form-control"
                               placeholder="انتخاب تاریخ"
                               value="@(Model.RegisteredToPersian?.Replace("-", "/") ?? string.Empty)"
                               data-jalali-input
                               data-jdp
                               data-jdp-only-date
                               data-jdp-init-date="@(Model.RegisteredToPersian?.Replace("-", "/") ?? string.Empty)"
                               autocomplete="off"
                               dir="ltr" />
                    </div>
                    <input asp-for="RegisteredToPersian" type="hidden" data-jalali-target />
                </div>
                <span asp-validation-for="RegisteredToPersian" class="text-danger"></span>
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label">کاربران انتخابی (اختیاری)</label>
            <div class="user-selector" data-user-selector>
                <div class="input-group mb-2">
                    <input type="text" 
                           class="form-control" 
                           id="userSearchInput" 
                           placeholder="جستجو کاربر (نام، ایمیل)..." 
                           autocomplete="off" />
                    <select class="form-select" id="userSelectDropdown" style="max-width: 200px;">
                        <option value="">انتخاب کاربر...</option>
                        @foreach (var user in Model.AvailableUsers)
                        {
                            <option value="@user.Value" data-text="@user.Text">@user.Text</option>
                        }
                    </select>
                    <button type="button" class="btn btn-primary" id="addUserBtn">
                        <i class="bi bi-plus"></i>
                        افزودن
                    </button>
                </div>
                <div id="selectedUsersDisplay" class="selected-users-display">
                    @if (Model.SelectedUserIds != null && Model.SelectedUserIds.Any())
                    {
                        @foreach (var userId in Model.SelectedUserIds)
                        {
                            var user = Model.AvailableUsers.FirstOrDefault(u => u.Value == userId);
                            if (user != null)
                            {
                                <span class="badge bg-primary me-1 mb-1 d-inline-flex align-items-center" data-user-badge="@userId">
                                    @user.Text
                                    <button type="button" class="btn-close btn-close-white ms-1" aria-label="حذف" data-remove-user="@userId"></button>
                                    <input type="hidden" name="SelectedUserIds" value="@userId" />
                                </span>
                            }
                        }
                    }
                </div>
            </div>
            <small class="form-text text-muted">می‌توانید کاربران را جستجو کرده و دونه دونه انتخاب کنید. در صورت انتخاب کاربران، اعلان فقط به آن‌ها ارسال می‌شود.</small>
        </div>
    </div>
    <div class="card-footer d-flex justify-content-between">
        <a class="btn btn-outline-secondary" asp-area="Admin" asp-controller="Dashboard" asp-action="Index">بازگشت</a>
        <button type="submit" class="btn btn-primary">
            <i class="bi bi-send"></i>
            ارسال اعلان
        </button>
    </div>
</form>

@section Head {
    <link rel="stylesheet" href="~/Plugins/JalaliDatePicker/css/jalalidatepicker.min.css" />
}

@section Scripts {
    @{ await Html.RenderPartialAsync("_ValidationScriptsPartial"); }
    <script src="~/plugins/jalalidatepicker/js/jalalidatepicker.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Initialize Jalali date picker
            if (typeof jalaliDatepicker !== 'undefined') {
                jalaliDatepicker.startWatch({
                    minDate: 'attr',
                    maxDate: 'attr',
                    time: false,
                    dateSeparator: '-',
                    autoHide: true
                });

                document.querySelectorAll('[data-jalali-picker]').forEach(function (picker) {
                    var input = picker.querySelector('[data-jalali-input]');
                    var target = picker.querySelector('[data-jalali-target]');
                        if (input && target) {
                            // Do not show picker on page load — open only when user interacts with the input
                            var openPicker = function () {
                                try {
                                    jalaliDatepicker.show(input);
                                } catch (e) {
                                    // ignore
                                }
                            };

                            // Open on focus or click
                            input.addEventListener('focus', openPicker);
                            input.addEventListener('click', openPicker);

                            // Also open when the adjacent control (if any) is clicked
                            var controlButton = picker.querySelector('.jalali-picker__controls button');
                            if (controlButton) {
                                controlButton.addEventListener('click', function (e) {
                                    e.preventDefault();
                                    openPicker();
                                });
                            }
                        }
                });
            }

            // Role selection
            document.querySelectorAll('[data-role-select]').forEach(function (root) {
                var inputs = Array.from(root.querySelectorAll('[data-role-option]'));

                var refresh = function () {
                    inputs.forEach(function (input) {
                        var option = input.closest('.role-select__option');
                        if (option) {
                            option.classList.toggle('is-selected', input.checked);
                        }
                    });
                };

                inputs.forEach(function (input) {
                    input.addEventListener('change', refresh);
                });

                refresh();
            });

            // User selection
            var userSearchInput = document.getElementById('userSearchInput');
            var userSelectDropdown = document.getElementById('userSelectDropdown');
            var addUserBtn = document.getElementById('addUserBtn');
            var selectedUsersDisplay = document.getElementById('selectedUsersDisplay');
            var selectedUserIds = new Set();

            // Initialize selected users from existing hidden inputs
            if (selectedUsersDisplay) {
                var existingInputs = selectedUsersDisplay.querySelectorAll('input[type="hidden"][name="SelectedUserIds"]');
                existingInputs.forEach(function(input) {
                    selectedUserIds.add(input.value);
                });
            }

            // Filter dropdown based on search input
            if (userSearchInput && userSelectDropdown) {
                userSearchInput.addEventListener('input', function() {
                    var searchTerm = this.value.toLowerCase().trim();
                    var options = userSelectDropdown.querySelectorAll('option:not([value=""])');
                    
                    options.forEach(function(option) {
                        var text = option.textContent.toLowerCase();
                        if (text.includes(searchTerm) && !selectedUserIds.has(option.value)) {
                            option.style.display = '';
                        } else {
                            option.style.display = 'none';
                        }
                    });
                });
            }

            // Add user button handler
            if (addUserBtn && userSelectDropdown && selectedUsersDisplay) {
                addUserBtn.addEventListener('click', function() {
                    var selectedOption = userSelectDropdown.options[userSelectDropdown.selectedIndex];
                    if (!selectedOption || !selectedOption.value || selectedUserIds.has(selectedOption.value)) {
                        return;
                    }

                    var userId = selectedOption.value;
                    var userText = selectedOption.getAttribute('data-text') || selectedOption.textContent;

                    // Add to set
                    selectedUserIds.add(userId);

                    // Create badge
                    var badge = document.createElement('span');
                    badge.className = 'badge bg-primary me-1 mb-1 d-inline-flex align-items-center';
                    badge.setAttribute('data-user-badge', userId);
                    badge.innerHTML = userText + 
                        ' <button type="button" class="btn-close btn-close-white ms-1" aria-label="حذف" data-remove-user="' + 
                        userId + '"></button>';

                    // Create hidden input
                    var hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = 'SelectedUserIds';
                    hiddenInput.value = userId;
                    badge.appendChild(hiddenInput);

                    selectedUsersDisplay.appendChild(badge);

                    // Reset dropdown
                    userSelectDropdown.selectedIndex = 0;
                    if (userSearchInput) {
                        userSearchInput.value = '';
                        userSearchInput.dispatchEvent(new Event('input'));
                    }
                });
            }

            // Remove user badge handler
            if (selectedUsersDisplay) {
                selectedUsersDisplay.addEventListener('click', function(e) {
                    var removeBtn = e.target.closest('[data-remove-user]');
                    if (removeBtn) {
                        var userId = removeBtn.getAttribute('data-remove-user');
                        if (userId) {
                            selectedUserIds.delete(userId);
                            var badge = removeBtn.closest('[data-user-badge]');
                            if (badge) {
                                badge.remove();
                            }

                            // Refresh dropdown to show removed user
                            if (userSearchInput) {
                                userSearchInput.dispatchEvent(new Event('input'));
                            }
                        }
                    }
                });
            }
        });
    </script>
}

