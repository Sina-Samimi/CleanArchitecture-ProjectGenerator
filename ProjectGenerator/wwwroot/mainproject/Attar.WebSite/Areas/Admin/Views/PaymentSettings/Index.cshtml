@model PaymentSettingsViewModel
@{
    ViewData["Title"] ??= "تنظیمات درگاه پرداخت";
    ViewData["Subtitle"] ??= "مدیریت تنظیمات درگاه پرداخت زرین‌پال";
}

@section Breadcrumb {
    <li class="breadcrumb-item"><a asp-area="Admin" asp-controller="Dashboard" asp-action="Index">داشبورد</a></li>
    <li class="breadcrumb-item active" aria-current="page">@ViewData["Title"]</li>
}

@await Html.PartialAsync("_StatusMessage")

<div class="row g-4 align-items-stretch">
    <div class="col-12 col-xl-8">
        <form asp-area="Admin" asp-controller="PaymentSettings" asp-action="Index" method="post" class="card h-100" novalidate>
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="card-title h4 mb-1">تنظیمات درگاه پرداخت</h2>
                    <p class="card-subtitle text-muted mb-0">تنظیمات مربوط به درگاه پرداخت زرین‌پال را در این بخش مدیریت کنید.</p>
                </div>
                <span class="badge bg-light text-primary">تنظیمات امنیتی</span>
            </div>
            <div class="card-body">
                @Html.AntiForgeryToken()
                <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>

                <div class="row g-4">
                    <div class="col-12">
                        <div class="alert alert-info" role="alert">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>نکته امنیتی:</strong> Merchant ID شما به صورت امن در دیتابیس ذخیره می‌شود و در فایل‌های تنظیمات قرار نمی‌گیرد.
                        </div>
                    </div>

                    <div class="col-12">
                        <label asp-for="ZarinPalMerchantId" class="form-label"></label>
                        <input asp-for="ZarinPalMerchantId" class="form-control" type="password" autocomplete="off" />
                        <span class="form-text text-muted">Merchant ID دریافتی از پنل زرین‌پال. این فیلد به صورت رمزنگاری شده ذخیره می‌شود.</span>
                        <span asp-validation-for="ZarinPalMerchantId" class="text-danger"></span>
                    </div>

                    <div class="col-12">
                        <div class="form-check form-switch">
                            <input asp-for="ZarinPalIsSandbox" class="form-check-input" type="checkbox" id="sandboxSwitch" />
                            <label class="form-check-label" for="sandboxSwitch">
                                <strong>@Html.DisplayNameFor(m => m.ZarinPalIsSandbox)</strong>
                            </label>
                            <div class="form-text text-muted">در حالت Sandbox، پرداخت‌ها تستی هستند و مبلغی کسر نمی‌شود.</div>
                        </div>
                    </div>

                    <div class="col-12">
                        <div class="form-check form-switch">
                            <input asp-for="IsActive" class="form-check-input" type="checkbox" id="isActiveSwitch" />
                            <label class="form-check-label" for="isActiveSwitch">
                                <strong>@Html.DisplayNameFor(m => m.IsActive)</strong>
                            </label>
                            <div class="form-text text-muted">در صورت غیرفعال بودن، درگاه پرداخت در دسترس نخواهد بود.</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-footer d-flex justify-content-end gap-2">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-save me-2"></i>
                    ذخیره تنظیمات
                </button>
            </div>
        </form>
    </div>
    <div class="col-12 col-xl-4">
        <div class="card h-100">
            <div class="card-header">
                <h3 class="card-title h5 mb-0">راهنمای استفاده</h3>
            </div>
            <div class="card-body">
                <div class="mb-4">
                    <h6 class="fw-bold mb-2">مراحل دریافت Merchant ID:</h6>
                    <ol class="mb-0">
                        <li>وارد پنل زرین‌پال شوید</li>
                        <li>به بخش تنظیمات درگاه بروید</li>
                        <li>Merchant ID خود را کپی کنید</li>
                        <li>در فیلد بالا وارد کنید</li>
                    </ol>
                </div>
                <div class="mb-4">
                    <h6 class="fw-bold mb-2">نکات مهم:</h6>
                    <ul class="mb-0">
                        <li>Merchant ID را به هیچ کس ندهید</li>
                        <li>در صورت افشا شدن، سریعاً آن را تغییر دهید</li>
                        <li>برای تست از حالت Sandbox استفاده کنید</li>
                        <li>پس از تست، حتماً Sandbox را غیرفعال کنید</li>
                    </ul>
                </div>
                <div class="alert alert-warning mb-0" role="alert">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>توجه:</strong> پس از ذخیره تنظیمات، نیاز به راه‌اندازی مجدد برنامه است تا تغییرات اعمال شوند.
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Toggle password visibility for Merchant ID
        document.addEventListener('DOMContentLoaded', function() {
            const merchantIdInput = document.querySelector('input[name="ZarinPalMerchantId"]');
            if (merchantIdInput) {
                // Add a button to toggle visibility
                const wrapper = document.createElement('div');
                wrapper.className = 'input-group';
                merchantIdInput.parentNode.insertBefore(wrapper, merchantIdInput);
                wrapper.appendChild(merchantIdInput);
                
                const toggleBtn = document.createElement('button');
                toggleBtn.className = 'btn btn-outline-secondary';
                toggleBtn.type = 'button';
                toggleBtn.innerHTML = '<i class="bi bi-eye"></i>';
                toggleBtn.onclick = function() {
                    if (merchantIdInput.type === 'password') {
                        merchantIdInput.type = 'text';
                        toggleBtn.innerHTML = '<i class="bi bi-eye-slash"></i>';
                    } else {
                        merchantIdInput.type = 'password';
                        toggleBtn.innerHTML = '<i class="bi bi-eye"></i>';
                    }
                };
                wrapper.appendChild(toggleBtn);
            }
        });
    </script>
}
