@using Attar.WebSite.Areas.User.Models
@model TicketDetailViewModel
@{
    ViewData["Title"] ??= "ثبت تیکت جدید";
    ViewData["Subtitle"] ??= "ارسال درخواست پشتیبانی";
    var selectedDepartment = Model.CreateForm.SelectedDepartment;
    var showForm = !string.IsNullOrWhiteSpace(selectedDepartment);
}

@await Html.PartialAsync("_StatusMessage")

@if (!showForm)
{
    <!-- Department Selection Step -->
    <div class="container-fluid py-5">
        <div class="row justify-content-center">
            <div class="col-12 col-md-10 col-lg-8">
                <div class="text-center mb-5">
                    <h1 class="h3 mb-3">ثبت تیکت جدید</h1>
                    <p class="text-muted">ابتدا واحد مورد نظر را انتخاب کنید</p>
                </div>

                <div class="row g-4">
                    <div class="col-12 col-md-4">
                        <div class="card border-0 shadow-sm h-100 department-card" data-department="مالی و اداری" style="cursor: pointer; transition: transform 0.2s;">
                            <div class="card-body text-center p-4">
                                <div class="mb-3">
                                    <i class="bi bi-file-earmark-text fs-1 text-primary"></i>
                                </div>
                                <h5 class="mb-0">مالی و اداری</h5>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-md-4">
                        <div class="card border-0 shadow-sm h-100 department-card" data-department="پشتیبانی فنی" style="cursor: pointer; transition: transform 0.2s;">
                            <div class="card-body text-center p-4">
                                <div class="mb-3">
                                    <i class="bi bi-tools fs-1 text-primary"></i>
                                </div>
                                <h5 class="mb-0">پشتیبانی فنی</h5>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-md-4">
                        <div class="card border-0 shadow-sm h-100 department-card" data-department="فروش" style="cursor: pointer; transition: transform 0.2s;">
                            <div class="card-body text-center p-4">
                                <div class="mb-3">
                                    <i class="bi bi-bag fs-1 text-primary"></i>
                                </div>
                                <h5 class="mb-0">فروش</h5>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <form id="departmentForm" method="get" asp-action="Create" style="display: none;">
        <input type="hidden" name="department" id="selectedDepartment" />
    </form>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const cards = document.querySelectorAll('.department-card');
            cards.forEach(card => {
                card.addEventListener('click', function() {
                    const department = this.getAttribute('data-department');
                    document.getElementById('selectedDepartment').value = department;
                    document.getElementById('departmentForm').submit();
                });
                card.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-5px)';
                });
                card.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0)';
                });
            });
        });
    </script>
}
else
{
    <!-- Ticket Form Step -->
    <div class="container-fluid py-4">
        <div class="row justify-content-center">
            <div class="col-12 col-lg-10">
                <div class="card border-0 shadow-sm">
                    <div class="card-body p-4">
                        <div class="text-center mb-4">
                            <h2 class="h4 mb-2">ثبت تیکت جدید</h2>
                            <p class="text-muted mb-0">واحد انتخاب شده: <strong>@selectedDepartment</strong></p>
                        </div>

                        <form asp-action="Create" method="post" enctype="multipart/form-data" id="ticketForm">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="department" value="@selectedDepartment" />

                            <!-- Subject -->
                            <div class="mb-4">
                                <label class="form-label text-center w-100 d-block mb-2">موضوع تیکت را وارد نمائید</label>
                                <input type="text" 
                                       name="subject" 
                                       class="form-control form-control-lg rounded-3" 
                                       value="@Model.CreateForm.Subject" 
                                       placeholder="موضوع : * موضوع تیکت خود را اینجا وارد کنید" 
                                       required />
                            </div>

                            <!-- Message -->
                            <div class="mb-4">
                                <textarea name="message" 
                                          class="form-control rounded-3" 
                                          rows="10" 
                                          placeholder="پیام خود را بنویسید ..." 
                                          required>@Model.CreateForm.Message</textarea>
                            </div>

                            <!-- File Attachment -->
                            <div class="mb-4">
                                <input type="file" 
                                       name="attachment" 
                                       id="fileAttachment" 
                                       class="form-control d-none" 
                                       accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.zip,.rar" />
                                <div id="fileDisplay" class="mb-2" style="display: none;">
                                    <div class="alert alert-info d-flex justify-content-between align-items-center">
                                        <span id="fileName"></span>
                                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearFile()">
                                            <i class="bi bi-x"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="d-flex gap-3 justify-content-center flex-wrap">
                                <button type="submit" class="btn btn-primary btn-lg rounded-pill px-5">
                                    <i class="bi bi-envelope me-2"></i> ارسال پیام
                                </button>
                                <button type="button" class="btn btn-outline-primary btn-lg rounded-pill px-5" onclick="document.getElementById('fileAttachment').click()">
                                    <i class="bi bi-paperclip me-2"></i> پیوست فایل
                                </button>
                                <a asp-action="Index" class="btn btn-outline-secondary btn-lg rounded-pill px-5">
                                    <i class="bi bi-x me-2"></i> انصراف
                                </a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('fileAttachment').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('fileDisplay').style.display = 'block';
            }
        });

        function clearFile() {
            document.getElementById('fileAttachment').value = '';
            document.getElementById('fileDisplay').style.display = 'none';
        }
    </script>
}

<style>
    .department-card:hover {
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
    }
</style>
