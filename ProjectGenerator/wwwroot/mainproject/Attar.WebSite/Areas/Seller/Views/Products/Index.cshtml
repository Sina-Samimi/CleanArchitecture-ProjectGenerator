@using System.Globalization
@using Attar.WebSite.Areas.Seller.Models
@model SellerProductIndexViewModel
@{ 
    ViewData["Sidebar:ActiveTab"] = "products";
    var persianCulture = new CultureInfo("fa-IR");

    string FormatDate(DateTimeOffset? value) => value is null ? "-" : value.Value.ToPersianDateTimeString();
    string FormatShortDate(DateTimeOffset? value) => value is null ? "-" : value.Value.ToPersianDateString();
    string FormatPrice(decimal value) => string.Format(persianCulture, "{0:N0}", value);
    string StatusBadgeClass(bool isPublished) => isPublished
        ? "badge bg-success-subtle text-success-emphasis"
        : "badge bg-warning-subtle text-warning-emphasis";
    string StatusLabel(bool isPublished) => isPublished ? "منتشر شده" : "در انتظار تایید";
    string TypeBadgeClass(ProductType type) => type switch
    {
        ProductType.Digital => "badge bg-info-subtle text-info-emphasis",
        ProductType.Physical => "badge bg-primary-subtle text-primary-emphasis",
        _ => "badge bg-secondary-subtle text-secondary-emphasis"
    };
    string TypeLabel(ProductType type) => type switch
    {
        ProductType.Digital => "دانلودی",
        ProductType.Physical => "فیزیکی",
        _ => "نامشخص"
    };
    string StatusFilterLabel(SellerProductStatusFilter status) => status switch
    {
        SellerProductStatusFilter.Published => "منتشر شده",
        SellerProductStatusFilter.Pending => "در انتظار تایید",
        _ => ""
    };
    string StatusFilterBadgeClass(SellerProductStatusFilter status) => status switch
    {
        SellerProductStatusFilter.Published => "badge bg-success-subtle text-success-emphasis",
        SellerProductStatusFilter.Pending => "badge bg-warning-subtle text-warning-emphasis",
        _ => "badge bg-secondary-subtle text-secondary-emphasis"
    };
}

@section Head {
    <link rel="stylesheet" href="~/css/seller/product-index.css" asp-append-version="true" />
}

<div class="row g-4" data-seller-products>
    <div class="col-12">
        <div class="d-flex flex-column flex-lg-row gap-3 align-items-lg-center justify-content-between">
            <div>
                <h1 class="h3 mb-1">محصولات ثبت‌شده</h1>
                <p class="text-muted mb-0">در این بخش وضعیت تایید محصولات و دوره‌های خود را مشاهده می‌کنید.</p>
            </div>
            <div class="d-flex flex-wrap gap-2">
                <button type="button"
                        class="btn btn-outline-primary position-relative"
                        data-bs-toggle="modal"
                        data-bs-target="#teacherProductFilterModal">
                    <i class="bi bi-funnel"></i>
                    فیلتر
                    @if (Model.HasActiveFilters)
                    {
                        <span class="badge bg-primary text-white rounded-pill position-absolute top-0 start-100 translate-middle"
                              aria-hidden="true">
                            •
                        </span>
                    }
                </button>
                <a class="btn btn-primary" asp-area="Seller" asp-controller="Products" asp-action="Create">
                    <i class="bi bi-plus-lg"></i>
                    درخواست محصول جدید
                </a>
                <a class="btn btn-outline-secondary" asp-area="User" asp-controller="Profile" asp-action="Index">
                    <i class="bi bi-person"></i>
                    بازگشت به پروفایل
                </a>
            </div>
        </div>
    </div>

    @if (Model.HasActiveFilters)
    {
        <div class="col-12">
            <div class="alert alert-primary-subtle border-0 shadow-sm d-flex flex-column flex-lg-row gap-3 align-items-lg-center justify-content-between mb-0">
                <div class="d-flex flex-wrap gap-2 align-items-center">
                    <span class="fw-semibold text-primary">فیلترهای فعال:</span>
                    @if (!string.IsNullOrWhiteSpace(Model.Filter.SearchTerm))
                    {
                        <span class="badge bg-secondary-subtle text-secondary-emphasis">
                            جستجو: <span class="fw-semibold">@Model.Filter.SearchTerm</span>
                        </span>
                    }
                    @if (Model.Filter.Type.HasValue)
                    {
                        <span class="badge bg-info-subtle text-info-emphasis">
                            نوع: <span class="fw-semibold">@TypeLabel(Model.Filter.Type!.Value)</span>
                        </span>
                    }
                    @if (Model.Filter.Status.HasValue)
                    {
                        <span class="@StatusFilterBadgeClass(Model.Filter.Status!.Value)">
                            وضعیت: <span class="fw-semibold">@StatusFilterLabel(Model.Filter.Status!.Value)</span>
                        </span>
                    }
                </div>
                <a class="btn btn-sm btn-outline-primary"
                   asp-area="Seller"
                   asp-controller="Products"
                   asp-action="Index">
                    حذف فیلترها
                </a>
            </div>
        </div>
    }

    @if (!string.IsNullOrWhiteSpace(Model.SuccessMessage))
    {
        <div class="col-12">
            <div class="alert alert-success border-0 shadow-sm" role="alert">
                <div class="d-flex align-items-start gap-3">
                    <i class="bi bi-check-circle-fill fs-4" aria-hidden="true"></i>
                    <div>
                        <h2 class="h6 mb-1">درخواست با موفقیت ثبت شد</h2>
                        <p class="mb-0">@Model.SuccessMessage</p>
                    </div>
                </div>
            </div>
        </div>
    }

    @if (!string.IsNullOrWhiteSpace(Model.ErrorMessage))
    {
        <div class="col-12">
            <div class="alert alert-warning border-0 shadow-sm" role="alert">
                <div class="d-flex align-items-start gap-3">
                    <i class="bi bi-exclamation-triangle-fill fs-4" aria-hidden="true"></i>
                    <div>
                        <h2 class="h6 mb-1">خطا در دریافت اطلاعات</h2>
                        <p class="mb-0">@Model.ErrorMessage</p>
                    </div>
                </div>
            </div>
        </div>
    }

    <div class="col-12">
        <div class="row g-3 seller-product-stats">
            <div class="col-12 col-sm-6 col-lg-3">
                <div class="card shadow-sm border-0 h-100 teacher-stat-card">
                    <div class="card-body">
                        <div class="teacher-stat-card__icon bg-primary-subtle text-primary-emphasis">
                            <i class="bi bi-bag"></i>
                        </div>
                        <div>
                            <p class="teacher-stat-card__label">کل محصولات</p>
                            <div class="teacher-stat-card__value">@Model.TotalCount</div>
                            <p class="teacher-stat-card__hint">محصول ثبت‌شده توسط شما</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-sm-6 col-lg-3">
                <div class="card shadow-sm border-0 h-100 teacher-stat-card">
                    <div class="card-body">
                        <div class="teacher-stat-card__icon bg-success-subtle text-success-emphasis">
                            <i class="bi bi-check-circle"></i>
                        </div>
                        <div>
                            <p class="teacher-stat-card__label">منتشر شده</p>
                            <div class="teacher-stat-card__value">@Model.PublishedCount</div>
                            <p class="teacher-stat-card__hint">محصول تایید و منتشر شده</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-sm-6 col-lg-3">
                <div class="card shadow-sm border-0 h-100 teacher-stat-card">
                    <div class="card-body">
                        <div class="teacher-stat-card__icon bg-warning-subtle text-warning-emphasis">
                            <i class="bi bi-hourglass-split"></i>
                        </div>
                        <div>
                            <p class="teacher-stat-card__label">در انتظار تایید</p>
                            <div class="teacher-stat-card__value">@Model.PendingCount</div>
                            <p class="teacher-stat-card__hint">منتظر بررسی توسط مدیریت</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-sm-6 col-lg-3">
                <div class="card shadow-sm border-0 h-100 teacher-stat-card">
                    <div class="card-body">
                        <div class="teacher-stat-card__icon bg-secondary-subtle text-secondary-emphasis">
                            <i class="bi bi-clock-history"></i>
                        </div>
                        <div>
                            <p class="teacher-stat-card__label">آخرین بروزرسانی</p>
                            @if (Model.Products.Count > 0)
                            {
                                var latest = Model.Products.Max(product => product.UpdatedAt);
                                <div class="teacher-stat-card__value teacher-stat-card__value--sm">@FormatShortDate(latest)</div>
                                <p class="teacher-stat-card__hint">@FormatDate(latest)</p>
                            }
                            else
                            {
                                <div class="teacher-stat-card__value teacher-stat-card__value--sm">-</div>
                                <p class="teacher-stat-card__hint">بدون سابقه</p>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-12">
        @if (Model.Products.Count == 0)
        {
            if (Model.HasActiveFilters)
            {
                <div class="card border-0 shadow-sm text-center py-5">
                    <div class="card-body">
                        <div class="display-5 text-muted mb-3"><i class="bi bi-search"></i></div>
                        <h2 class="h4">محصولی با فیلترهای فعلی یافت نشد</h2>
                        <p class="text-muted mb-4">فیلترها را تغییر دهید یا آن‌ها را حذف کنید تا همه محصولات شما نمایش داده شود.</p>
                        <a class="btn btn-outline-primary" asp-area="Seller" asp-controller="Products" asp-action="Index">
                            حذف فیلترها
                        </a>
                    </div>
                </div>
            }
            else
            {
                <div class="card border-0 shadow-sm text-center py-5">
                    <div class="card-body">
                        <div class="display-5 text-muted mb-3"><i class="bi bi-bag"></i></div>
                        <h2 class="h4">هنوز محصولی ثبت نکرده‌اید</h2>
                        <p class="text-muted mb-4">اولین محصول خود را ثبت کنید تا پس از تایید ادمین در سایت نمایش داده شود.</p>
                        <a class="btn btn-primary" asp-area="Seller" asp-controller="Products" asp-action="Create">
                            <i class="bi bi-plus-lg"></i>
                            ثبت اولین محصول
                        </a>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="seller-product-grid">
                @foreach (var product in Model.Products.OrderByDescending(item => item.UpdatedAt))
                {
                    var publishedInfo = product.IsPublished && product.PublishedAt is not null
                        ? $"منتشر شده در {FormatDate(product.PublishedAt)}"
                        : "در انتظار بررسی مدیریت";

                    <article class="card border-0 shadow-sm seller-product-card">
                        <div class="seller-product-card__media">
                            @if (!string.IsNullOrWhiteSpace(product.FeaturedImagePath))
                            {
                                <img src="@product.FeaturedImagePath"
                                     alt="@product.Name"
                                     class="seller-product-card__image" />
                            }
                            else
                            {
                                <div class="seller-product-card__placeholder">
                                    <i class="bi bi-images"></i>
                                    <span>بدون تصویر</span>
                                </div>
                            }

                            <span class="seller-product-card__status @StatusBadgeClass(product.IsPublished)">
                                <i class="bi @(product.IsPublished ? "bi-patch-check" : "bi-hourglass-split")"></i>
                                @StatusLabel(product.IsPublished)
                            </span>
                        </div>
                        <div class="card-body seller-product-card__body">
                            <div class="seller-product-card__title">
                                <h2 class="h5 mb-1">@product.Name</h2>
                                <span class="seller-product-card__type @TypeBadgeClass(product.Type)">
                                    <i class="bi @(product.Type == ProductType.Digital ? "bi-cloud-arrow-down" : "bi-box-seam")"></i>
                                    @TypeLabel(product.Type)
                                </span>
                            </div>
                            <div class="seller-product-card__meta">
                                <span class="seller-product-card__category">
                                    <i class="bi bi-collection"></i>
                                    @product.Category
                                </span>
                                <span class="seller-product-card__price">
                                    <i class="bi bi-cash-stack"></i>
                                    @(product.Price.HasValue ? FormatPrice(product.Price.Value) : "قیمت بر اساس سفارش")
                                    <span class="text-muted">تومان</span>
                                </span>
                            </div>
                            <div class="seller-product-card__tags">
                                @if (product.Tags.Count == 0)
                                {
                                    <span class="seller-product-card__tag seller-product-card__tag--empty">بدون برچسب</span>
                                }
                                else
                                {
                                    foreach (var tag in product.Tags)
                                    {
                                        <span class="seller-product-card__tag">@tag</span>
                                    }
                                }
                            </div>
                        </div>
                        <div class="seller-product-card__footer">
                            <div class="seller-product-card__dates">
                                <div>
                                    <span class="text-muted small d-block">وضعیت انتشار</span>
                                    <span class="seller-product-card__date">@publishedInfo</span>
                                </div>
                                <div>
                                    <span class="text-muted small d-block">آخرین بروزرسانی</span>
                                    <span class="seller-product-card__date">@FormatDate(product.UpdatedAt)</span>
                                </div>
                            </div>
                            <div class="dropdown">
                                <button class="btn btn-outline-secondary btn-icon" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="bi bi-three-dots"></i>
                                    <span class="visually-hidden">گزینه‌های محصول</span>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    @if (product.Type == ProductType.Physical)
                                    {
                                        <li>
                                            <a class="dropdown-item"
                                               asp-area="Seller"
                                               asp-controller="ShipmentTracking"
                                               asp-action="Index"
                                               asp-route-productId="@product.Id">
                                                <i class="bi bi-truck"></i>
                                                پیگیری ارسال
                                            </a>
                                        </li>
                                        <li><hr class="dropdown-divider"></li>
                                    }
                                    <li>
                                        <a class="dropdown-item"
                                           asp-area="Seller"
                                           asp-controller="Products"
                                           asp-action="Details"
                                           asp-route-id="@product.Id">
                                            <i class="bi bi-eye ms-2"></i>
                                            مشاهده جزئیات
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item"
                                           asp-area="Seller"
                                           asp-controller="Products"
                                           asp-action="Edit"
                                           asp-route-id="@product.Id">
                                            <i class="bi bi-pencil-square ms-2"></i>
                                            ویرایش محصول
                                        </a>
                                    </li>
                                    <li><hr class="dropdown-divider" /></li>
                                    <li>
                                        <a class="dropdown-item"
                                           asp-area="Seller"
                                           asp-controller="ProductAttributes"
                                           asp-action="Index"
                                           asp-route-productId="@product.Id">
                                            <i class="bi bi-tags"></i>
                                            ویژگی‌ها
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item"
                                           asp-area="Seller"
                                           asp-controller="ProductVariantAttributes"
                                           asp-action="Index"
                                           asp-route-productId="@product.Id">
                                            <i class="bi bi-list-check"></i>
                                            ویژگی‌های گزینه‌ها
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item"
                                           asp-area="Seller"
                                           asp-controller="ProductVariants"
                                           asp-action="Index"
                                           asp-route-productId="@product.Id">
                                            <i class="bi bi-diagram-3"></i>
                                            گزینه‌ها
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item"
                                           asp-area="Seller"
                                           asp-controller="ProductComments"
                                           asp-action="Index"
                                           asp-route-productId="@product.Id">
                                            <i class="bi bi-chat-dots ms-2"></i>
                                            نظرات محصول
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </article>
                }
            </div>
        }
    </div>
</div>

<div class="modal fade" id="teacherProductFilterModal" tabindex="-1" aria-labelledby="teacherProductFilterModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="teacherProductFilterModalLabel">فیلتر محصولات</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="بستن"></button>
            </div>
            <form method="get" novalidate>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-12">
                            <label for="FilterSearchTerm" class="form-label">جستجو</label>
                            <input type="text"
                                   class="form-control"
                                   id="FilterSearchTerm"
                                   name="SearchTerm"
                                   value="@Model.Filter.SearchTerm"
                                   placeholder="نام محصول یا دسته‌بندی" />
                            <span class="form-text">برای جستجو در نام محصول یا دسته‌بندی آن، عبارت مورد نظر را وارد کنید.</span>
                        </div>
                        <div class="col-12 col-md-6">
                            <label for="FilterType" class="form-label">نوع محصول</label>
                            <select class="form-select" id="FilterType" name="Type">
                                <option value="">همه انواع</option>
                                @foreach (var type in Enum.GetValues<ProductType>())
                                {
                                    var isSelected = Model.Filter.Type.HasValue && Model.Filter.Type.Value == type;
                                    <option value="@((int)type)" selected="@(isSelected ? "selected" : null)">@TypeLabel(type)</option>
                                }
                            </select>
                        </div>
                        <div class="col-12 col-md-6">
                            <label for="FilterStatus" class="form-label">وضعیت انتشار</label>
                            <select class="form-select" id="FilterStatus" name="Status">
                                <option value="">همه وضعیت‌ها</option>
                                @foreach (var status in Enum.GetValues<SellerProductStatusFilter>())
                                {
                                    var isSelected = Model.Filter.Status.HasValue && Model.Filter.Status.Value == status;
                                    <option value="@((int)status)" selected="@(isSelected ? "selected" : null)">@StatusFilterLabel(status)</option>
                                }
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <a class="btn btn-outline-secondary" asp-area="Seller" asp-controller="Products" asp-action="Index">حذف فیلترها</a>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-funnel"></i>
                        اعمال فیلتر
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
