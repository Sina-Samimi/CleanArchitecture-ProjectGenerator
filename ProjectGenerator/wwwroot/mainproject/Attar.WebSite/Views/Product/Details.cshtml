@model ProductDetailViewModel
@{
    Layout = "_HomeTemplateLayout";
    ViewData["Title"] = Model.Product.Name;
    ViewData["MetaDescription"] = Model.Product.ShortDescription;
    var commentSuccess = TempData["ProductCommentSuccess"] as bool?;
}

@Html.AntiForgeryToken()

@section Styles {
    <link rel="stylesheet" href="~/css/product-details.css" asp-append-version="true" />
}

<!-- Product Details Section -->
<section class="product-details-section">
    <div class="container">
        <div class="breadcrumb">
            <a asp-controller="Home" asp-action="Index">Ø®Ø§Ù†Ù‡</a> /
            <a asp-controller="Product" asp-action="Index">Ù…Ø­ØµÙˆÙ„Ø§Øª</a> /
            <span>@Model.Product.Name</span>
        </div>

        <div class="product-details-container">
            <!-- Product Images -->
            <div class="product-images">
                <button type="button" class="violation-report-btn" onclick="openViolationReportModal()">
                    âš ï¸ Ú¯Ø²Ø§Ø±Ø´ ØªØ®Ù„Ù
                </button>
                <div class="main-image">
                    <img id="main-product-image" src="@Model.HeroImageUrl" alt="@Model.Product.Name">
                </div>
                <div class="thumbnail-images">
                    <img class="thumbnail active" src="@Model.HeroImageUrl" alt="ØªØµÙˆÛŒØ± 1" onclick="changeMainImage(this.src)">
                    @if (!string.IsNullOrWhiteSpace(Model.Product.ThumbnailUrl) && Model.Product.ThumbnailUrl != Model.HeroImageUrl)
                    {
                        <img class="thumbnail" src="@Model.Product.ThumbnailUrl" alt="ØªØµÙˆÛŒØ± 2" onclick="changeMainImage(this.src)">
                    }
                    @foreach (var galleryImage in Model.Gallery.OrderBy(g => g.DisplayOrder))
                    {
                        <img class="thumbnail" src="@galleryImage.ImagePath" alt="ØªØµÙˆÛŒØ± Ú¯Ø§Ù„Ø±ÛŒ" onclick="changeMainImage(this.src)">
                    }
                </div>
            </div>

            <!-- Product Info -->
            <div class="product-info">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                    <h1 class="product-title" style="flex: 1; margin: 0;">@Model.Product.Name</h1>
                </div>
                <div class="product-rating">
                    <span class="stars">
                        @for (int i = 0; i < (int)Model.Product.Rating; i++)
                        {
                            <span>â˜…</span>
                        }
                    </span>
                    <span class="rating-text">(@Model.Product.GetRatingLabel() Ø§Ø² Ûµ - @Model.Product.GetReviewCountLabel())</span>
                </div>

                <!-- Product Price -->
                <div class="product-price-section" style="margin-bottom: 15px;">
                    <span class="current-price" id="productPrice">@Model.Product.GetFormattedPrice() ØªÙˆÙ…Ø§Ù†</span>
                    @if (Model.Product.OriginalPrice.HasValue)
                    {
                        <span class="old-price" id="productOriginalPrice">@Model.Product.GetFormattedOriginalPrice() ØªÙˆÙ…Ø§Ù†</span>
                    }
                </div>

                <!-- Ø§Ù†ØªØ®Ø§Ø¨ Ú¯Ø²ÛŒÙ†Ù‡ -->
                @{
                    // Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¢ÛŒØ§ Ù…Ø­ØµÙˆÙ„ variant Ø¯Ø§Ø±Ø¯
                    var hasVariants = Model.VariantAttributes != null && Model.VariantAttributes.Any() && 
                                      Model.Variants != null && Model.Variants.Any();
                }
                @if (hasVariants)
                {
                    <div class="product-variants mb-4" data-product-variants>
                        <div class="alert alert-info mb-3">
                            <i class="bi bi-info-circle"></i>
                            Ù„Ø·ÙØ§Ù‹ Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯
                        </div>
                        @foreach (var attr in Model.VariantAttributes.OrderBy(a => a.DisplayOrder))
                        {
                            <div class="mb-3">
                                <label class="form-label fw-semibold">@attr.Name: <span class="text-danger">*</span></label>
                                <div class="d-flex flex-wrap gap-2" data-variant-attribute="@attr.Id">
                                    @if (attr.Options != null && attr.Options.Any())
                                    {
                                        @foreach (var option in attr.Options)
                                        {
                                            <button type="button" 
                                                    class="btn btn-outline-secondary variant-option-btn" 
                                                    data-attribute-id="@attr.Id"
                                                    data-option-value="@option"
                                                    onclick="selectVariantOption(this, '@attr.Id', '@option')">
                                                @option
                                            </button>
                                        }
                                    }
                                    else
                                    {
                                        @* ÙˆÛŒÚ˜Ú¯ÛŒ Ø¨Ø¯ÙˆÙ† Ú¯Ø²ÛŒÙ†Ù‡ - Ø¯Ú©Ù…Ù‡ Ú©Ù„ÛŒÚ© Ø¨Ø±Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ *@
                                        <button type="button" 
                                                class="btn btn-outline-secondary variant-option-btn" 
                                                data-attribute-id="@attr.Id"
                                                data-option-value=""
                                                onclick="selectVariantAttributeWithoutOption(this, '@attr.Id')">
                                            Ø§Ù†ØªØ®Ø§Ø¨
                                        </button>
                                    }
                                </div>
                            </div>
                        }
                        <div class="mt-2">
                            <small class="text-muted" id="variantStockInfo">Ù„Ø·ÙØ§Ù‹ ØªÙ…Ø§Ù… Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</small>
                            <small class="text-danger" id="variantOutOfStockInfo" style="display: none;">Ø§ÛŒÙ† Ú¯Ø²ÛŒÙ†Ù‡ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ù†Ø¯Ø§Ø±Ø¯</small>
                        </div>
                    </div>
                }

                <div class="product-description">
                    <h3>ØªÙˆØ¶ÛŒØ­Ø§Øª Ù…Ø­ØµÙˆÙ„</h3>
                    <p>@Html.Raw(Model.Description)</p>
                    @if (Model.Highlights.Any())
                    {
                        <ul class="product-features">
                            @foreach (var highlight in Model.Highlights)
                            {
                                <li>âœ… @highlight</li>
                            }
                        </ul>
                    }
                </div>

                <div class="product-actions d-flex flex-wrap gap-2 align-items-center">
                    @if (Model.CanAddToCart)
                    {
                        var hasStock = !Model.TrackInventory || Model.StockQuantity > 0;
                        var isBaseOutOfStock = !hasVariants && !hasStock;
                        var addToCartButtonType = isBaseOutOfStock ? "button" : "submit";
                        // Ú©Ù†ØªØ±Ù„ disabled Ø¨ÙˆØ¯Ù† Ø¯Ú©Ù…Ù‡ Ø¨Ù‡ Ø¹Ù‡Ø¯Ù‡ JavaScript Ø§Ø³Øª
                        // Ø¯Ø± HTML Ø§ÙˆÙ„ÛŒÙ‡ attribute disabled Ø±Ø§ Ø§Ø¶Ø§ÙÙ‡ Ù†Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
                        <form asp-controller="Cart" asp-action="Add" method="post" id="addToCartForm" onsubmit="return validateVariantSelection(event)">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="productId" value="@Model.Product.Id" />
                            <input type="hidden" name="quantity" value="1" />
                            <input type="hidden" name="variantId" id="formVariantId" value="" />
                            @* Hidden inputs Ø¨Ø±Ø§ÛŒ variant attributes Ùˆ options Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡ - Ø¨Ù‡ ØµÙˆØ±Øª dynamic Ø§ÛŒØ¬Ø§Ø¯ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ *@
                            <div id="selectedVariantAttributesContainer"></div>
                            <button type="@addToCartButtonType"
                                    class="btn btn-primary me-2"
                                    id="addToCartBtn"
                                    data-out-of-stock="@(isBaseOutOfStock.ToString().ToLower())"
                                    aria-disabled="@(isBaseOutOfStock.ToString().ToLower())"
                                    style="@(isBaseOutOfStock ? "opacity: .65; cursor: not-allowed;" : string.Empty)">
                                @(isBaseOutOfStock ? "Ù†Ø§Ù…ÙˆØ¬ÙˆØ¯" : "ğŸ›’ Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ù‡ Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯")
                            </button>

                            @* Ø¯Ú©Ù…Ù‡ "Ø®Ø¨Ø±Ù… Ú©Ù†" ÙÙ‚Ø· ÙˆÙ‚ØªÛŒ Ù…Ø­ØµÙˆÙ„ Ù¾Ø§ÛŒÙ‡ Ù†Ø§Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³Øª Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ *@
                            @if (isBaseOutOfStock)
                            {
                                var subscribedText = Model.HasBackInStockSubscription ? "Ù„ØºÙˆ Ø®Ø¨Ø±Ù… Ú©Ù†" : "Ø®Ø¨Ø±Ù… Ú©Ù†";
                                var isSubscribed = Model.HasBackInStockSubscription.ToString().ToLower();
                                <button type="button"
                                        class="btn btn-outline-primary"
                                        id="backInStockNotifyBtn"
                                        data-product-id="@Model.Product.Id"
                                        data-subscribed="@isSubscribed">
                                    @subscribedText
                                </button>
                            }
                            @if (hasVariants)
                            {
                                <div class="mt-2">
                                    <small class="text-danger" id="variantValidationError" style="display: none;">
                                        Ù„Ø·ÙØ§Ù‹ ØªÙ…Ø§Ù… Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯
                                    </small>
                                </div>
                            }
                        </form>
                    }
                    else
                    {
                        <button type="button" class="btn btn-primary" disabled>
                            ğŸ›’ Ø§Ù…Ú©Ø§Ù† Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯
                        </button>
                    }
                    <button type="button" id="wishlist-btn" class="btn btn-secondary ms-auto" onclick="addToWishlist('@Model.Product.Id')">
                        â¤ï¸ Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ù‡ Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§
                    </button>
                </div>
                <div class="product-meta">
                    <div class="meta-item">
                        <span class="meta-icon">ğŸ“¦</span>
                        <span>Ø¶Ù…Ø§Ù†Øª Ø§ØµÙ„ Ø¨ÙˆØ¯Ù† Ú©Ø§Ù„Ø§</span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-icon">ğŸšš</span>
                        <span>Ø§Ù…Ú©Ø§Ù† ØªØ­ÙˆÛŒÙ„ Ø§Ú©Ø³Ù¾Ø±Ø³</span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-icon">ğŸ”’</span>
                        <span>Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ù…Ù† Ùˆ Ù…Ø·Ù…Ø¦Ù†</span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-icon">ğŸ•’</span>
                        <span>
                            Û²Û´ Ø³Ø§Ø¹ØªÙ‡ØŒ Û· Ø±ÙˆØ² Ù‡ÙØªÙ‡
                        </span>
                    </div>
                </div>
            </div>
        </div>



        <!-- Product Tabs -->
        <div class="product-tabs">
            <div class="tab-buttons">
                <button class="tab-btn active" onclick="showTab('specifications')">Ù…Ø´Ø®ØµØ§Øª</button>
                <button class="tab-btn" onclick="showTab('reviews')">Ù†Ø¸Ø±Ø§Øª (@Model.Comments.Count)</button>
            </div>

            <div class="tab-content">
                <div id="specifications" class="tab-pane active">
                    <table class="specifications-table">
                        @foreach (var attr in Model.Attributes)
                        {
                            <tr>
                                <td>@attr.Key</td>
                                <td>@attr.Value</td>
                            </tr>
                        }
                    </table>
                </div>

                <div id="reviews" class="tab-pane">
                   
                    <ol class="blog-comment__list product-comment__list" aria-label="Ù†Ø¸Ø±Ø§Øª Ù…Ø­ØµÙˆÙ„">
        @foreach (var comment in Model.Comments)
        {
            ViewData["ProductSlug"] = Model.Product.Slug;
            ViewData["ProductId"] = Model.Product.Id;
            @await Html.PartialAsync("_ProductComment", comment)
        }
    </ol>

                    <div class="review-form">
                        <h3>Ù†Ø¸Ø± Ø®ÙˆØ¯ Ø±Ø§ Ø«Ø¨Øª Ú©Ù†ÛŒØ¯</h3>
                        <form asp-action="AddComment" asp-route-slug="@Model.Product.Slug" method="post" class="blog-comment-form" id="commentForm" novalidate>
                            @Html.AntiForgeryToken()
                            <div asp-validation-summary="ModelOnly" class="text-danger" style="display: none;"></div>
                            <input type="hidden" asp-for="NewComment.ProductId" />
                            <input type="hidden" asp-for="NewComment.ParentId" value="" />
                            <div class="form-group blog-comment-form__field">
                                <label asp-for="NewComment.AuthorName">Ù†Ø§Ù…:</label>
                                <input asp-for="NewComment.AuthorName" class="form-control" id="commentAuthorName" required />
                                <span asp-validation-for="NewComment.AuthorName" class="text-danger" style="display: none;"></span>
                            </div>
                            <div class="form-group blog-comment-form__field">
                                <label asp-for="NewComment.Rating">Ø§Ù…ØªÛŒØ§Ø²:</label>
                                <div class="rating-input">
                                    <input type="hidden" asp-for="NewComment.Rating" id="ratingValue" value="5" />
                                    <div class="star-rating" id="starRating">
                                        @for (int i = 5; i >= 1; i--)
                                        {
                                            <span class="star" data-rating="@i">â˜…</span>
                                        }
                                    </div>
                                    <span class="rating-text" id="ratingText">5 Ø³ØªØ§Ø±Ù‡</span>
                                </div>
                                <span asp-validation-for="NewComment.Rating" class="text-danger" style="display: none;"></span>
                            </div>
                            <div class="form-group blog-comment-form__field">
                                <label asp-for="NewComment.Content">Ù†Ø¸Ø± Ø´Ù…Ø§:</label>
                                <textarea asp-for="NewComment.Content" rows="4" class="form-control" id="commentContent" required></textarea>
                                <span asp-validation-for="NewComment.Content" class="text-danger" style="display: none;"></span>
                            </div>
                            <button type="submit" class="btn blog-comment-form__submit">Ø«Ø¨Øª Ù†Ø¸Ø±</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Suggested Products -->
        <div class="suggested-products-section" style="margin-top: 60px; margin-bottom: 40px;">
            <h2 class="section-title" style="font-size: 24px; font-weight: bold; margin-bottom: 30px; color: #333; text-align: center;">ÙØ±ÙˆØ´Ù†Ø¯Ú¯Ø§Ù† Ø¯ÛŒÚ¯Ø± Ø§ÛŒÙ† Ù…Ø­ØµÙˆÙ„</h2>
            @if (Model.SuggestedProductOffers.Any())
            {
                <div class="suggested-products-list">
                    @foreach (var offer in Model.SuggestedProductOffers)
                    {
                        <div class="suggested-product-card">
                            <!-- Product Image -->
                            <div class="suggested-product-image">
                                <img src="@offer.ImageUrl" alt="@offer.ProductName" />
                            </div>

                            <!-- Product Info -->
                            <div class="suggested-product-info">
                                <div class="suggested-product-name">@offer.SellerName</div>
                                <div class="suggested-product-category">ğŸ“¦ @offer.ProductName</div>
                                @if (!string.IsNullOrWhiteSpace(offer.ShopAddress))
                                {
                                    <div class="suggested-product-address">ğŸ“ @offer.ShopAddress</div>
                                }
                            </div>

                            <!-- Price -->
                            <div class="suggested-product-price">
                                <span class="price-value">@offer.GetFormattedPrice()</span>
                                <span class="price-unit">ØªÙˆÙ…Ø§Ù†</span>
                            </div>

                            <!-- Add to Cart Button -->
                            <div class="suggested-product-action">
                                <form asp-controller="Cart" asp-action="Add" method="post" style="margin: 0;">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="productId" value="@Model.Product.Id" />
                                    <input type="hidden" name="quantity" value="1" />
                                    <input type="hidden" name="offerId" value="@offer.Id" />
                                    <button type="submit" class="add-to-cart-btn" @(offer.IsInStock ? "" : "disabled")>
                                        @(offer.IsInStock ? "Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ù‡ Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯" : "Ù†Ø§Ù…ÙˆØ¬ÙˆØ¯")
                                    </button>
                                </form>
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="no-suggested-products" style="text-align: center; padding: 40px 20px; background: #f8f9fa; border-radius: 12px; color: #666;">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin: 0 auto 20px; opacity: 0.5;">
                        <path d="M3 9L12 2L21 9V20C21 20.5304 20.7893 21.0391 20.4142 21.4142C20.0391 21.7893 19.5304 22 19 22H5C4.46957 22 3.96086 21.7893 3.58579 21.4142C3.21071 21.0391 3 20.5304 3 20V9Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        <path d="M9 22V12H15V22" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                    <p style="font-size: 16px; margin: 0; color: #666;">Ù‡Ù†ÙˆØ² Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ Ø§Ø² ÙØ±ÙˆØ´Ù†Ø¯Ú¯Ø§Ù† Ø¯ÛŒÚ¯Ø± Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ù…Ø­ØµÙˆÙ„ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>
                </div>
            }
        </div>

        <!-- Related Products -->
        @if (Model.RelatedProducts.Any())
        {
            <div class="related-products">
                <h2 class="section-title">Ù…Ø­ØµÙˆÙ„Ø§Øª Ù…Ø±ØªØ¨Ø·</h2>
                <div class="products-grid">
                    @foreach (var relatedProduct in Model.RelatedProducts.Take(3))
                    {
                        <div class="product-card">
                            <div class="product-image">
                                <img src="@relatedProduct.ThumbnailUrl" alt="@relatedProduct.Name" style="width: 100%; height: 100%; object-fit: cover;" />
                            </div>
                            <div class="product-info">
                                <h3 class="product-name">
                                    <a asp-controller="Product" asp-action="Details" asp-route-slug="@relatedProduct.Slug" style="text-decoration: none; color: inherit;">@StringHelper.TruncateName(relatedProduct.Name)</a>
                                </h3>
                                <p class="product-description">@StringHelper.TruncateDescription(relatedProduct.ShortDescription)</p>
                                <div class="product-price">@relatedProduct.GetFormattedPrice() ØªÙˆÙ…Ø§Ù†</div>
                                <a asp-controller="Product" asp-action="Details" asp-route-slug="@relatedProduct.Slug" style="text-decoration: none;">
                                    <span class="archive-product-btn">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¬Ø²Ø¦ÛŒØ§Øª</span>
                                </a>
                            </div>
                        </div>
                    }
                </div>
            </div>
        }
    </div>
</section>

<!-- Out-of-stock modal -->
<div id="outOfStockModal" class="product-stock-modal" aria-hidden="true">
    <div class="product-stock-modal__dialog">
        <div class="product-stock-modal__header">
            <h5 class="product-stock-modal__title">Ù†Ø§Ù…ÙˆØ¬ÙˆØ¯</h5>
            <button type="button" class="product-stock-modal__close" data-product-modal-close>&times;</button>
        </div>
        <div class="product-stock-modal__body">
            <div class="stock-modal-icon stock-modal-icon--warning">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="12" cy="12" r="10" stroke="#f59e0b" stroke-width="2"/>
                    <line x1="12" y1="8" x2="12" y2="12" stroke="#f59e0b" stroke-width="2" stroke-linecap="round"/>
                    <circle cx="12" cy="16" r="1" fill="#f59e0b"/>
                </svg>
            </div>
            <p class="stock-modal-desc">Ø§ÛŒÙ† Ù…Ø­ØµÙˆÙ„ Ø¯Ø± Ø­Ø§Ù„ Ø­Ø§Ø¶Ø± Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ù†Ø¯Ø§Ø±Ø¯.</p>
            <button type="button" class="stock-modal-btn stock-modal-btn--secondary" data-product-modal-close>
                Ù…ØªÙˆØ¬Ù‡ Ø´Ø¯Ù…
            </button>
        </div>
    </div>
</div>

<!-- Back in stock - Phone modal -->
<div id="backInStockModal" class="product-stock-modal" aria-hidden="true">
    <div class="product-stock-modal__dialog">
        <div class="product-stock-modal__header">
            <h5 class="product-stock-modal__title">Ø®Ø¨Ø±Ù… Ú©Ù† ÙˆÙ‚ØªÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ø´Ø¯</h5>
            <button type="button" class="product-stock-modal__close" data-product-modal-close>&times;</button>
        </div>
        <div class="product-stock-modal__body">
            <div class="stock-modal-icon">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z" stroke="#3b82f6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </div>
            <p class="stock-modal-desc">Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ø´Ø¯Ù† Ù…Ø­ØµÙˆÙ„ØŒ Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.</p>
            <form id="backInStockPhoneForm" method="post" novalidate>
                <div class="stock-modal-field">
                    <label for="backInStockPhone" class="stock-modal-label">Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„</label>
                    <input type="tel"
                           class="stock-modal-input"
                           id="backInStockPhone"
                           name="phoneNumber"
                           placeholder="Û°Û¹Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹"
                           dir="ltr"
                           required />
                    <div class="stock-modal-error d-none" id="backInStockPhoneError"></div>
                </div>
                <button type="submit" class="stock-modal-btn" id="backInStockPhoneSubmitBtn">
                    Ø§Ø±Ø³Ø§Ù„ Ú©Ø¯ ØªØ§ÛŒÛŒØ¯
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Back in stock - Code verification modal -->
<div id="backInStockCodeModal" class="product-stock-modal" aria-hidden="true">
    <div class="product-stock-modal__dialog">
        <div class="product-stock-modal__header">
            <h5 class="product-stock-modal__title">ØªØ§ÛŒÛŒØ¯ Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„</h5>
            <button type="button" class="product-stock-modal__close" data-product-modal-close>&times;</button>
        </div>
        <div class="product-stock-modal__body">
            <div class="stock-modal-icon stock-modal-icon--code">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2" stroke="#10b981" stroke-width="2"/>
                    <path d="M7 11V7a5 5 0 0 1 10 0v4" stroke="#10b981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </div>
            <p class="stock-modal-desc">Ú©Ø¯ ØªØ§ÛŒÛŒØ¯ Ø¨Ù‡ Ø´Ù…Ø§Ø±Ù‡ <span id="backInStockDisplayPhone" class="fw-bold" dir="ltr"></span> Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯.</p>
            <form id="backInStockCodeForm" method="post" novalidate>
                <div class="stock-modal-field">
                    <label for="backInStockCode" class="stock-modal-label">Ú©Ø¯ ØªØ§ÛŒÛŒØ¯ Û¶ Ø±Ù‚Ù…ÛŒ</label>
                    <input type="text"
                           class="stock-modal-input stock-modal-input--code"
                           id="backInStockCode"
                           maxlength="6"
                           inputmode="numeric"
                           placeholder="- - - - - -"
                           dir="ltr"
                           required />
                    <div class="stock-modal-hint">
                        <span>Ú©Ø¯ ØªØ³Øª:</span>
                        <span id="backInStockDebugCode" class="fw-bold text-primary" dir="ltr"></span>
                    </div>
                    <div class="stock-modal-error d-none" id="backInStockCodeError"></div>
                </div>
                <button type="submit" class="stock-modal-btn stock-modal-btn--success" id="backInStockCodeSubmitBtn">
                    ØªØ§ÛŒÛŒØ¯ Ùˆ Ø«Ø¨Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Back in stock - Success modal -->
<div id="backInStockSuccessModal" class="product-stock-modal" aria-hidden="true">
    <div class="product-stock-modal__dialog">
        <div class="product-stock-modal__header">
            <h5 class="product-stock-modal__title">Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø´Ù…Ø§ Ø«Ø¨Øª Ø´Ø¯</h5>
            <button type="button" class="product-stock-modal__close" data-product-modal-close>&times;</button>
        </div>
        <div class="product-stock-modal__body">
            <div class="stock-modal-icon stock-modal-icon--success">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="12" cy="12" r="10" fill="#ecfdf5" stroke="#10b981" stroke-width="2" />
                    <path d="M8 12.5l2.5 2.5L16 9" stroke="#10b981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
            </div>
            <p class="stock-modal-desc">
                Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ø´Ø¯Ù† Ø§ÛŒÙ† Ù…Ø­ØµÙˆÙ„ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯.
                Ø¨Ù‡ Ù…Ø­Ø¶ Ù…ÙˆØ¬ÙˆØ¯ Ø´Ø¯Ù†ØŒ Ø§Ø² Ø·Ø±ÛŒÙ‚ Ù¾ÛŒØ§Ù…Ú© Ø¨Ù‡ Ø´Ù…Ø§ Ø§Ø·Ù„Ø§Ø¹ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.
            </p>
            <button type="button" class="stock-modal-btn stock-modal-btn--success" data-product-modal-close>
                Ù…ØªÙˆØ¬Ù‡ Ø´Ø¯Ù…
            </button>
        </div>
    </div>
</div>

<!-- Success Modal for Comment -->
@if (commentSuccess == true)
{
    <div id="commentSuccessModal" class="comment-success-modal" style="display: none;">
        <div class="comment-success-modal__backdrop" onclick="closeCommentSuccessModal()"></div>
        <div class="comment-success-modal__dialog">
            <div class="comment-success-modal__content">
                <div class="comment-success-modal__icon">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="12" cy="12" r="10" fill="#28a745" opacity="0.1" />
                        <path d="M9 12l2 2 4-4" stroke="#28a745" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                </div>
                <h3 class="comment-success-modal__title">Ù†Ø¸Ø± Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯</h3>
                <p class="comment-success-modal__message">
                    Ù†Ø¸Ø± Ø´Ù…Ø§ Ù¾Ø³ Ø§Ø² Ø¨Ø±Ø±Ø³ÛŒ Ùˆ ØªØ§ÛŒÛŒØ¯ Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø± Ø³Ø§ÛŒØª Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.
                </p>
                <button type="button" class="comment-success-modal__button" onclick="closeCommentSuccessModal()">
                    Ù…ØªØ´Ú©Ø±Ù…
                </button>
            </div>
        </div>
    </div>
}

<!-- Error Modal for Comment Validation -->
<div id="commentErrorModal" class="comment-error-modal" style="display: none;">
    <div class="comment-error-modal__backdrop" onclick="closeCommentErrorModal()"></div>
    <div class="comment-error-modal__dialog">
        <div class="comment-error-modal__content">
            <div class="comment-error-modal__icon">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="12" cy="12" r="10" fill="#dc3545" opacity="0.1" />
                    <path d="M9 9l6 6M15 9l-6 6" stroke="#dc3545" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
            </div>
            <h3 class="comment-error-modal__title" id="commentErrorTitle">Ù„Ø·ÙØ§Ù‹ Ø®Ø·Ø§Ù‡Ø§ÛŒ Ø²ÛŒØ± Ø±Ø§ Ø¨Ø±Ø·Ø±Ù Ú©Ù†ÛŒØ¯</h3>
            <div class="comment-error-modal__message" id="commentErrorMessage">
                <!-- Error messages will be inserted here -->
            </div>
            <button type="button" class="comment-error-modal__button" onclick="closeCommentErrorModal()">
                Ù…ØªÙˆØ¬Ù‡ Ø´Ø¯Ù…
            </button>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Ù…Ù†Ø·Ù‚ Ø§Ù†ØªØ®Ø§Ø¨ Ú¯Ø²ÛŒÙ†Ù‡
        const variants = @Html.Raw(System.Text.Json.JsonSerializer.Serialize((Model.Variants ?? new List<ProductVariantViewModel>()).Select(v => new {
            id = v.Id,
            price = v.Price,
            compareAtPrice = v.CompareAtPrice,
            stockQuantity = v.StockQuantity,
            options = v.Options.ToDictionary(o => o.VariantAttributeId.ToString(), o => o.Value)
        })));
        
        const basePrice = @(Model.Product.Price?.ToString("0.00") ?? "null");
        const baseOriginalPrice = @(Model.Product.OriginalPrice?.ToString("0.00") ?? "null");
        const baseStockQuantity = @(Model.StockQuantity);
        const trackInventory = @(Model.TrackInventory ? "true" : "false");
        
        let selectedOptions = {};
        
        function updateVariantAttributeHiddenInput(attributeId, optionValue) {
            // Ø§ÛŒØ¬Ø§Ø¯ ÛŒØ§ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ hidden input Ø¨Ø±Ø§ÛŒ variant attribute
            const container = document.getElementById('selectedVariantAttributesContainer');
            if (!container) return;
            
            const inputId = `variantAttribute_${attributeId}`;
            let input = document.getElementById(inputId);
            
            if (!input) {
                // Ø§ÛŒØ¬Ø§Ø¯ hidden input Ø¬Ø¯ÛŒØ¯
                input = document.createElement('input');
                input.type = 'hidden';
                input.id = inputId;
                input.name = `selectedVariantAttributes[${attributeId}]`;
                container.appendChild(input);
            }
            
            // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…Ù‚Ø¯Ø§Ø±
            input.value = optionValue || '__SELECTED__';
        }
        
        function removeVariantAttributeHiddenInput(attributeId) {
            // Ø­Ø°Ù hidden input Ø¨Ø±Ø§ÛŒ variant attribute
            const inputId = `variantAttribute_${attributeId}`;
            const input = document.getElementById(inputId);
            if (input) {
                input.remove();
            }
        }
        
        function selectVariantOption(button, attributeId, optionValue) {
            // attributeId Ø§Ø² Razor Ø¨Ù‡ ØµÙˆØ±Øª string Ù…ÛŒâ€ŒØ¢ÛŒØ¯ (Ù…Ø«Ù„Ø§Ù‹: "550e8400-e29b-41d4-a716-446655440000")
            const attrIdStr = String(attributeId);
            
            // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡
            selectedOptions[attrIdStr] = optionValue;
            
            // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ hidden input Ø¯Ø± ÙØ±Ù… Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† variant attribute
            updateVariantAttributeHiddenInput(attrIdStr, optionValue);
            
            // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§
            const attributeContainer = button.closest('[data-variant-attribute]');
            if (attributeContainer) {
                attributeContainer.querySelectorAll('.variant-option-btn').forEach(btn => {
                    btn.classList.remove('active', 'btn-primary');
                    btn.classList.add('btn-outline-secondary');
                });
                button.classList.remove('btn-outline-secondary');
                button.classList.add('active', 'btn-primary');
            }
            
            // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ú¯Ø²ÛŒÙ†Ù‡ Ù…Ø·Ø§Ø¨Ù‚
            const matchingVariant = findMatchingVariant();
            
            // ÙˆÙ‚ØªÛŒ Ù‡Ø± variant option Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯ØŒ Ø¯Ú©Ù…Ù‡ Ø±Ø§ ÙØ¹Ø§Ù„ Ú©Ù†
            // backend validation Ù†Ù‡Ø§ÛŒÛŒ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
            const addToCartBtnCheck = document.getElementById('addToCartBtn');
            if (addToCartBtnCheck && Object.keys(selectedOptions).length > 0) {
                // Ú©Ø§Ù…Ù„Ø§Ù‹ attribute disabled Ø±Ø§ Ø­Ø°Ù Ú©Ù†
                addToCartBtnCheck.disabled = false;
                addToCartBtnCheck.removeAttribute('disabled');
            }
            
            if (matchingVariant) {
                // Set variantId in the form
                const formVariantIdElement = document.getElementById('formVariantId');
                if (formVariantIdElement) {
                    formVariantIdElement.value = matchingVariant.id;
                }
                
                // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù‚ÛŒÙ…Øª
                const priceElement = document.getElementById('productPrice');
                const originalPriceElement = document.getElementById('productOriginalPrice');
                
                if (matchingVariant.price !== null) {
                    priceElement.textContent = formatPrice(matchingVariant.price) + ' ØªÙˆÙ…Ø§Ù†';
                } else if (basePrice !== null) {
                    priceElement.textContent = formatPrice(basePrice) + ' ØªÙˆÙ…Ø§Ù†';
                }
                
                if (matchingVariant.compareAtPrice !== null) {
                    if (originalPriceElement) {
                        originalPriceElement.textContent = formatPrice(matchingVariant.compareAtPrice) + ' ØªÙˆÙ…Ø§Ù†';
                        originalPriceElement.style.display = 'inline';
                    }
                } else if (baseOriginalPrice !== null) {
                    if (originalPriceElement) {
                        originalPriceElement.textContent = formatPrice(baseOriginalPrice) + ' ØªÙˆÙ…Ø§Ù†';
                        originalPriceElement.style.display = 'inline';
                    }
                } else {
                    if (originalPriceElement) {
                        originalPriceElement.style.display = 'none';
                    }
                }
                
                // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…ÙˆØ¬ÙˆØ¯ÛŒ
                // Ø§Ú¯Ø± variant Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø¯Ø§Ø´Øª (> 0) Ø§Ø² Ø¢Ù† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ØŒ Ø¯Ø± ØºÛŒØ± Ø§ÛŒÙ† ØµÙˆØ±Øª Ø§Ø² Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ù…Ø­ØµÙˆÙ„
                const variantStock = matchingVariant.stockQuantity !== null && matchingVariant.stockQuantity !== undefined 
                    ? matchingVariant.stockQuantity 
                    : 0;
                // Ø§Ú¯Ø± variant Ù…ÙˆØ¬ÙˆØ¯ÛŒ 0 ÛŒØ§ null/undefined Ø¨Ø§Ø´Ø¯ØŒ Ø§Ø² Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ù…Ø­ØµÙˆÙ„ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ (backend Ø§ÛŒÙ† Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ø¯)
                const finalStockQuantity = variantStock > 0 ? variantStock : baseStockQuantity;
                const stockInfo = document.getElementById('variantStockInfo');
                const addToCartBtn = document.getElementById('addToCartBtn');
                
                // Ù†Ù…Ø§ÛŒØ´ Ù…ÙˆØ¬ÙˆØ¯ÛŒ (ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ - backend Ù…ÙˆØ¬ÙˆØ¯ÛŒ ÙˆØ§Ù‚Ø¹ÛŒ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ø¯)
                if (trackInventory) {
                    if (variantStock > 0) {
                        // Variant Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø¯Ø§Ø±Ø¯
                        stockInfo.textContent = `Ù…ÙˆØ¬ÙˆØ¯ÛŒ: ${variantStock} Ø¹Ø¯Ø¯`;
                        stockInfo.className = 'text-success';
                    } else if (baseStockQuantity > 0) {
                        // Variant Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ù†Ø¯Ø§Ø±Ø¯ Ø§Ù…Ø§ Ù…Ø­ØµÙˆÙ„ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø¯Ø§Ø±Ø¯
                        stockInfo.textContent = `Ù…ÙˆØ¬ÙˆØ¯ÛŒ: ${baseStockQuantity} Ø¹Ø¯Ø¯ (Ù…Ø­ØµÙˆÙ„)`;
                        stockInfo.className = 'text-success';
                    } else {
                        stockInfo.textContent = 'Ù†Ø§Ù…ÙˆØ¬ÙˆØ¯';
                        stockInfo.className = 'text-danger';
                    }
                } else {
                    stockInfo.textContent = 'Ù…ÙˆØ¬ÙˆØ¯';
                    stockInfo.className = 'text-success';
                }
                
                // ÙˆØ¶Ø¹ÛŒØª Ø¯Ú©Ù…Ù‡ Ø±Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…ÙˆØ¬ÙˆØ¯ÛŒ variant/Ù…Ø­ØµÙˆÙ„ ØªÙ†Ø¸ÛŒÙ… Ú©Ù†
                if (addToCartBtn) {
                    const isVariantOutOfStock = trackInventory && finalStockQuantity <= 0;
                    addToCartBtn.dataset.variantOutOfStock = isVariantOutOfStock ? 'true' : 'false';

                    if (isVariantOutOfStock) {
                        addToCartBtn.disabled = false; // Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù…ÙˆØ¯Ø§Ù„ Ø¨Ø§ÛŒØ¯ Ú©Ù„ÛŒÚ©â€ŒÙ¾Ø°ÛŒØ± Ø¨Ù…Ø§Ù†Ø¯
                        addToCartBtn.textContent = 'Ù†Ø§Ù…ÙˆØ¬ÙˆØ¯';
                        addToCartBtn.classList.remove('btn-primary');
                        addToCartBtn.classList.add('btn-outline-secondary');
                    } else {
                        addToCartBtn.disabled = false;
                        addToCartBtn.removeAttribute('disabled');
                        addToCartBtn.textContent = 'ğŸ›’ Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ù‡ Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯';
                        addToCartBtn.classList.add('btn-primary');
                        addToCartBtn.classList.remove('btn-outline-secondary');
                    }
                }
            } else {
                // Ù‡Ù†ÙˆØ² Ú¯Ø²ÛŒÙ†Ù‡ Ù…Ø·Ø§Ø¨Ù‚ÛŒ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯Ù‡ (Ù‡Ù…Ù‡ Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯)
                // variantId Ø±Ø§ Ø®Ø§Ù„ÛŒ Ú©Ù† (Ø§Ù…Ø§ hidden inputs Ø¨Ø±Ø§ÛŒ variant attributes Ø±Ø§ Ù†Ú¯Ù‡ Ø¯Ø§Ø±)
                const formVariantIdElement = document.getElementById('formVariantId');
                if (formVariantIdElement) {
                    formVariantIdElement.value = '';
                }
                
                // Ù‚ÛŒÙ…Øª Ù¾Ø§ÛŒÙ‡ Ø±Ø§ Ù†Ú¯Ù‡ Ø¯Ø§Ø±
                const priceElement = document.getElementById('productPrice');
                const originalPriceElement = document.getElementById('productOriginalPrice');
                
                if (basePrice !== null) {
                    priceElement.textContent = formatPrice(basePrice) + ' ØªÙˆÙ…Ø§Ù†';
                }
                
                if (baseOriginalPrice !== null && originalPriceElement) {
                    originalPriceElement.textContent = formatPrice(baseOriginalPrice) + ' ØªÙˆÙ…Ø§Ù†';
                    originalPriceElement.style.display = 'inline';
                }
                
                // Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø±Ø§ Ø§Ø² Ù…Ø­ØµÙˆÙ„ Ù†Ù…Ø§ÛŒØ´ Ø¨Ø¯Ù‡
                const stockInfoElement = document.getElementById('variantStockInfo');
                const addToCartBtnElement = document.getElementById('addToCartBtn');
                if (stockInfoElement) {
                    stockInfoElement.textContent = 'Ù„Ø·ÙØ§Ù‹ ØªÙ…Ø§Ù… Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯';
                    stockInfoElement.className = 'text-muted';
                }
                
                // Ø§Ú¯Ø± option Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯ØŒ Ø¯Ú©Ù…Ù‡ Ø±Ø§ enable Ù†Ú¯Ù‡ Ø¯Ø§Ø± (Ù‚Ø¨Ù„Ø§Ù‹ Ø¯Ø± Ø®Ø· 503-508 enable Ø´Ø¯Ù‡)
                // ÙÙ‚Ø· ÙˆÙ‚ØªÛŒ Ù‡ÛŒÚ† option Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ØŒ disable Ú©Ù†
                if (addToCartBtnElement) {
                    if (Object.keys(selectedOptions).length === 0) {
                        // Ù‡ÛŒÚ† option Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ØŒ disable Ú©Ù†
                        addToCartBtnElement.disabled = true;
                    } else {
                        // option Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡ØŒ enable Ù†Ú¯Ù‡ Ø¯Ø§Ø±
                        addToCartBtnElement.disabled = false;
                        addToCartBtnElement.removeAttribute('disabled');
                    }
                    addToCartBtnElement.textContent = 'ğŸ›’ Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ù‡ Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯';
                    addToCartBtnElement.dataset.variantOutOfStock = 'false';
                }
                // ØªÙˆØ¬Ù‡: hidden inputs Ø¨Ø±Ø§ÛŒ variant attributes Ø±Ø§ Ù†Ú¯Ù‡ Ù…ÛŒâ€ŒØ¯Ø§Ø±ÛŒÙ… ØªØ§ Ù…Ø´Ø®Øµ Ø¨Ø§Ø´Ø¯ Ú©Ø¯Ø§Ù…â€ŒÙ‡Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯
            }
        }
        
        function selectVariantAttributeWithoutOption(button, attributeId) {
            // Ø¨Ø±Ø§ÛŒ ÙˆÛŒÚ˜Ú¯ÛŒ Ø¨Ø¯ÙˆÙ† Ú¯Ø²ÛŒÙ†Ù‡ØŒ ÙÙ‚Ø· attributeId Ø±Ø§ Ø¹Ù„Ø§Ù…Øª Ø¨Ø²Ù†
            const attrIdStr = String(attributeId);
            selectedOptions[attrIdStr] = '__SELECTED__';
            
            // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ hidden input Ø¯Ø± ÙØ±Ù…
            updateVariantAttributeHiddenInput(attrIdStr, '__SELECTED__');
            
            // Ø¨Ù‚ÛŒÙ‡ Ù…Ù†Ø·Ù‚...
            
            // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø¯Ú©Ù…Ù‡
            const attributeContainer = button.closest('[data-variant-attribute]');
            if (attributeContainer) {
                attributeContainer.querySelectorAll('.variant-option-btn').forEach(btn => {
                    btn.classList.remove('active', 'btn-primary');
                    btn.classList.add('btn-outline-secondary');
                });
                button.classList.remove('btn-outline-secondary');
                button.classList.add('active', 'btn-primary');
            }
            
            // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† variant Ù…Ø·Ø§Ø¨Ù‚ - Ø¨Ø±Ø§ÛŒ ÙˆÛŒÚ˜Ú¯ÛŒ Ø¨Ø¯ÙˆÙ† Ú¯Ø²ÛŒÙ†Ù‡ØŒ variant Ø¨Ø§ÛŒØ¯ ÙÙ‚Ø· Ø§ÛŒÙ† attribute Ø±Ø§ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯
            const matchingVariant = findMatchingVariantForAttributeWithoutOption(attributeId);
            
            if (matchingVariant) {
                // Set variantId in the form
                const formVariantIdElement = document.getElementById('formVariantId');
                if (formVariantIdElement) {
                    formVariantIdElement.value = matchingVariant.id;
                }
                
                // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù‚ÛŒÙ…Øª
                const priceElement = document.getElementById('productPrice');
                const originalPriceElement = document.getElementById('productOriginalPrice');
                
                if (matchingVariant.price !== null) {
                    priceElement.textContent = formatPrice(matchingVariant.price) + ' ØªÙˆÙ…Ø§Ù†';
                } else if (basePrice !== null) {
                    priceElement.textContent = formatPrice(basePrice) + ' ØªÙˆÙ…Ø§Ù†';
                }
                
                if (matchingVariant.compareAtPrice !== null) {
                    if (originalPriceElement) {
                        originalPriceElement.textContent = formatPrice(matchingVariant.compareAtPrice) + ' ØªÙˆÙ…Ø§Ù†';
                        originalPriceElement.style.display = 'inline';
                    }
                } else if (baseOriginalPrice !== null) {
                    if (originalPriceElement) {
                        originalPriceElement.textContent = formatPrice(baseOriginalPrice) + ' ØªÙˆÙ…Ø§Ù†';
                        originalPriceElement.style.display = 'inline';
                    }
                } else {
                    if (originalPriceElement) {
                        originalPriceElement.style.display = 'none';
                    }
                }
                
                // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…ÙˆØ¬ÙˆØ¯ÛŒ
                const variantStock = matchingVariant.stockQuantity !== null && matchingVariant.stockQuantity !== undefined 
                    ? matchingVariant.stockQuantity 
                    : 0;
                const stockInfo = document.getElementById('variantStockInfo');
                const addToCartBtn = document.getElementById('addToCartBtn');
                
                // Ù†Ù…Ø§ÛŒØ´ Ù…ÙˆØ¬ÙˆØ¯ÛŒ (ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ - backend Ù…ÙˆØ¬ÙˆØ¯ÛŒ ÙˆØ§Ù‚Ø¹ÛŒ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ø¯)
                if (trackInventory) {
                    if (variantStock > 0) {
                        // Variant Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø¯Ø§Ø±Ø¯
                        stockInfo.textContent = `Ù…ÙˆØ¬ÙˆØ¯ÛŒ: ${variantStock} Ø¹Ø¯Ø¯`;
                        stockInfo.className = 'text-success';
                    } else if (baseStockQuantity > 0) {
                        // Variant Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ù†Ø¯Ø§Ø±Ø¯ Ø§Ù…Ø§ Ù…Ø­ØµÙˆÙ„ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø¯Ø§Ø±Ø¯
                        stockInfo.textContent = `Ù…ÙˆØ¬ÙˆØ¯ÛŒ: ${baseStockQuantity} Ø¹Ø¯Ø¯ (Ù…Ø­ØµÙˆÙ„)`;
                        stockInfo.className = 'text-success';
                    } else {
                        stockInfo.textContent = 'Ù†Ø§Ù…ÙˆØ¬ÙˆØ¯';
                        stockInfo.className = 'text-danger';
                    }
                } else {
                    stockInfo.textContent = 'Ù…ÙˆØ¬ÙˆØ¯';
                    stockInfo.className = 'text-success';
                }
                
                // Ù‡Ù…ÛŒØ´Ù‡ Ø¯Ú©Ù…Ù‡ Ø±Ø§ enable Ú©Ù† Ú†ÙˆÙ† variant Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡ Ø§Ø³Øª
                // backend validation Ù…ÙˆØ¬ÙˆØ¯ÛŒ ÙˆØ§Ù‚Ø¹ÛŒ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ø¯ (variant ÛŒØ§ Ù…Ø­ØµÙˆÙ„)
                if (addToCartBtn) {
                    addToCartBtn.disabled = false;
                    addToCartBtn.removeAttribute('disabled');
                    addToCartBtn.textContent = 'ğŸ›’ Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ù‡ Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯';
                }
            } else {
                // Ø§Ú¯Ø± variant Ù…Ø·Ø§Ø¨Ù‚ÛŒ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯ØŒ Ø§Ø² Ù…Ø´Ø®ØµØ§Øª Ù…Ø­ØµÙˆÙ„ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†
                const formVariantIdElement = document.getElementById('formVariantId');
                if (formVariantIdElement) {
                    // variantId Ø±Ø§ Ø¨Ø§ attributeId ØªÙ†Ø¸ÛŒÙ… Ú©Ù† (ÛŒØ§ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒÙ… Ø§ÙˆÙ„ÛŒÙ† variant Ø±Ø§ Ù¾ÛŒØ¯Ø§ Ú©Ù†ÛŒÙ…)
                    const firstVariantWithAttribute = variants.find(v => {
                        // Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¢ÛŒØ§ variant Ø§ÛŒÙ† attribute Ø±Ø§ Ø¯Ø§Ø±Ø¯
                        return v.options && v.options[attributeId] !== undefined;
                    });
                    if (firstVariantWithAttribute) {
                        formVariantIdElement.value = firstVariantWithAttribute.id;
                    } else {
                        // Ø§Ú¯Ø± variant Ù…Ø·Ø§Ø¨Ù‚ÛŒ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯ØŒ Ø§Ø² Ø§ÙˆÙ„ÛŒÙ† variant Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†
                        if (variants && variants.length > 0) {
                            formVariantIdElement.value = variants[0].id;
                        }
                    }
                }
                
                // Ù‚ÛŒÙ…Øª Ù¾Ø§ÛŒÙ‡ Ø±Ø§ Ù†Ú¯Ù‡ Ø¯Ø§Ø±
                const priceElement = document.getElementById('productPrice');
                const originalPriceElement = document.getElementById('productOriginalPrice');
                
                if (basePrice !== null) {
                    priceElement.textContent = formatPrice(basePrice) + ' ØªÙˆÙ…Ø§Ù†';
                }
                
                if (baseOriginalPrice !== null && originalPriceElement) {
                    originalPriceElement.textContent = formatPrice(baseOriginalPrice) + ' ØªÙˆÙ…Ø§Ù†';
                    originalPriceElement.style.display = 'inline';
                }
                
                // Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø±Ø§ Ø§Ø² Ù…Ø­ØµÙˆÙ„ Ù†Ù…Ø§ÛŒØ´ Ø¨Ø¯Ù‡
                const stockInfo = document.getElementById('variantStockInfo');
                const addToCartBtn = document.getElementById('addToCartBtn');
                
                if (trackInventory) {
                    if (baseStockQuantity > 0) {
                        stockInfo.textContent = `Ù…ÙˆØ¬ÙˆØ¯ÛŒ: ${baseStockQuantity} Ø¹Ø¯Ø¯`;
                        stockInfo.className = 'text-success';
                    } else {
                        stockInfo.textContent = 'Ù†Ø§Ù…ÙˆØ¬ÙˆØ¯';
                        stockInfo.className = 'text-danger';
                    }
                } else {
                    stockInfo.textContent = 'Ù…ÙˆØ¬ÙˆØ¯';
                    stockInfo.className = 'text-success';
                }
                
                // Ø¯Ú©Ù…Ù‡ Ø±Ø§ disable Ú©Ù† Ú†ÙˆÙ† variant Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª
                if (addToCartBtn) {
                    addToCartBtn.disabled = true;
                    addToCartBtn.textContent = 'ğŸ›’ Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ù‡ Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯';
                    // Ø­Ø°Ù attribute Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯ (Ø§Ù…Ø§ disabled = true Ù…ÛŒâ€ŒÙ…Ø§Ù†Ø¯)
                }
            }
        }
        
        function findMatchingVariant() {
            // Ù‡Ù…Ù‡ variant attributes Ø±Ø§ Ø¯Ø± Ù†Ø¸Ø± Ø¨Ú¯ÛŒØ± (Ø¨Ø§ Ú¯Ø²ÛŒÙ†Ù‡ Ùˆ Ø¨Ø¯ÙˆÙ† Ú¯Ø²ÛŒÙ†Ù‡)
            const allVariantAttributes = @Html.Raw(System.Text.Json.JsonSerializer.Serialize((Model.VariantAttributes ?? new List<ProductVariantAttributeViewModel>()).Select(a => a.Id.ToString())));
            const variantAttributesWithOptions = @Html.Raw(System.Text.Json.JsonSerializer.Serialize((Model.VariantAttributes ?? new List<ProductVariantAttributeViewModel>()).Where(a => a.Options != null && a.Options.Any()).Select(a => a.Id.ToString())));
            
            console.log('findMatchingVariant - allVariantAttributes:', allVariantAttributes);
            console.log('findMatchingVariant - variantAttributesWithOptions:', variantAttributesWithOptions);
            console.log('findMatchingVariant - selectedOptions:', selectedOptions);
            console.log('findMatchingVariant - variants:', variants);
            
            // Ø§Ú¯Ø± variant attribute Ø§ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯ØŒ null Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†
            if (!allVariantAttributes || allVariantAttributes.length === 0) {
                console.log('findMatchingVariant - No variant attributes found');
                return null;
            }
            
            // Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¢ÛŒØ§ ØªÙ…Ø§Ù… ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ (Ú©Ù‡ Ú¯Ø²ÛŒÙ†Ù‡ Ø¯Ø§Ø±Ù†Ø¯) Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯
            for (const attrId of variantAttributesWithOptions) {
                // attrId Ø­Ø§Ù„Ø§ string Ø§Ø³Øª (Ø§Ø² ToString() Ø¯Ø± C#)
                const attrIdStr = String(attrId);
                // Ø¨Ø±Ø±Ø³ÛŒ Ù‡Ù… Ø¨Ø§ string Ùˆ Ù‡Ù… Ø¨Ø§ Ù…Ù‚Ø¯Ø§Ø± Ø§ØµÙ„ÛŒ
                const hasSelection = selectedOptions[attrIdStr] || selectedOptions[attrId];
                console.log(`findMatchingVariant - Checking attrId: ${attrIdStr}, hasSelection:`, hasSelection);
                if (!hasSelection) {
                    console.log('findMatchingVariant - Missing selection for:', attrIdStr);
                    return null; // ØªÙ…Ø§Ù… ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ø¯Ø§Ø±Ø§ÛŒ Ú¯Ø²ÛŒÙ†Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯
                }
            }
            
            // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ú¯Ø²ÛŒÙ†Ù‡â€ŒØ§ÛŒ Ú©Ù‡ Ø¨Ø§ ØªÙ…Ø§Ù… Ø§Ù†ØªØ®Ø§Ø¨â€ŒÙ‡Ø§ Ù…Ø·Ø§Ø¨Ù‚Øª Ø¯Ø§Ø±Ø¯
            const matching = variants.find(v => {
                if (!v.options) {
                    console.log('findMatchingVariant - Variant has no options:', v);
                    return false;
                }
                
                console.log('findMatchingVariant - Checking variant:', v.id, 'options:', v.options);
                
                // Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¢ÛŒØ§ variant Ø¨Ø§ ØªÙ…Ø§Ù… Ø§Ù†ØªØ®Ø§Ø¨â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± Ù…Ø·Ø§Ø¨Ù‚Øª Ø¯Ø§Ø±Ø¯
                // Ù†Ú©ØªÙ‡: variant Ø¨Ø§ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ù‡ attribute Ù‡Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡ØŒ Ù…Ù‚Ø¯Ø§Ø± Ù…Ø·Ø§Ø¨Ù‚ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯
                // Ø§Ú¯Ø± variant ÛŒÚ© attribute Ø±Ø§ Ù†Ø¯Ø§Ø±Ø¯ØŒ Ø¨Ø§ÛŒØ¯ variant Ø¯ÛŒÚ¯Ø±ÛŒ Ø±Ø§ Ù¾ÛŒØ¯Ø§ Ú©Ù†ÛŒÙ…
                let allAttributesMatch = true;
                for (const attrId of variantAttributesWithOptions) {
                    // attrId Ø­Ø§Ù„Ø§ string Ø§Ø³Øª (Ø§Ø² ToString() Ø¯Ø± C#)
                    const attrIdStr = String(attrId);
                    // Ø¨Ø±Ø±Ø³ÛŒ Ù‡Ù… Ø¨Ø§ string Ùˆ Ù‡Ù… Ø¨Ø§ Ù…Ù‚Ø¯Ø§Ø± Ø§ØµÙ„ÛŒ
                    const selectedValue = selectedOptions[attrIdStr] || selectedOptions[attrId];
                    if (!selectedValue) {
                        console.log(`findMatchingVariant - No selected value for attrId: ${attrIdStr}`);
                        allAttributesMatch = false;
                        break;
                    }
                    
                    // Ù…Ù‚Ø§ÛŒØ³Ù‡ Ø¨Ø§ Ú©Ù„ÛŒØ¯Ù‡Ø§ÛŒ options (Ú©Ù‡ string Ù‡Ø³ØªÙ†Ø¯)
                    const variantOption = v.options[attrIdStr];
                    console.log(`findMatchingVariant - Comparing attrId: ${attrIdStr}, selectedValue: ${selectedValue}, variantOption: ${variantOption}`);
                    
                    // Ø§Ú¯Ø± variant Ø§ÛŒÙ† attribute Ø±Ø§ Ù†Ø¯Ø§Ø±Ø¯ (undefined)ØŒ Ø§ÛŒÙ† variant Ù…Ù†Ø§Ø³Ø¨ Ù†ÛŒØ³Øª
                    if (variantOption === undefined) {
                        console.log(`findMatchingVariant - Variant doesn't have attribute: ${attrIdStr}`);
                        allAttributesMatch = false;
                        break;
                    }
                    
                    // variant Ø§ÛŒÙ† attribute Ø±Ø§ Ø¯Ø§Ø±Ø¯ØŒ Ù¾Ø³ Ø¨Ø§ÛŒØ¯ Ù…Ø·Ø§Ø¨Ù‚Øª Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯
                    if (String(variantOption).trim() !== String(selectedValue).trim()) {
                        console.log(`findMatchingVariant - Mismatch for attrId: ${attrIdStr}`);
                        allAttributesMatch = false;
                        break;
                    }
                }
                
                if (!allAttributesMatch) {
                    return false;
                }
                
                // Ø¨Ø±Ø§ÛŒ ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ø¨Ø¯ÙˆÙ† Ú¯Ø²ÛŒÙ†Ù‡ØŒ ÙÙ‚Ø· Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù† Ú©Ù‡ variant Ø§ÛŒÙ† attribute Ø±Ø§ Ø¯Ø§Ø±Ø¯
                for (const attrId of allVariantAttributes) {
                    if (!variantAttributesWithOptions.includes(attrId)) {
                        // Ø§ÛŒÙ† ÙˆÛŒÚ˜Ú¯ÛŒ Ø¨Ø¯ÙˆÙ† Ú¯Ø²ÛŒÙ†Ù‡ Ø§Ø³Øª
                        const attrIdStr = String(attrId);
                        if (selectedOptions[attrIdStr] === '__SELECTED__') {
                            // Ú©Ø§Ø±Ø¨Ø± Ø§ÛŒÙ† ÙˆÛŒÚ˜Ú¯ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø±Ø¯Ù‡ØŒ Ù¾Ø³ variant Ø¨Ø§ÛŒØ¯ Ø§ÛŒÙ† attribute Ø±Ø§ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯
                            if (!v.options[attrIdStr]) {
                                return false;
                            }
                        }
                    }
                }
                console.log('findMatchingVariant - Variant matched:', v.id);
                return true;
            });
            
            console.log('findMatchingVariant - Final matching result:', matching);
            return matching;
        }
        
        function findMatchingVariantForAttributeWithoutOption(attributeId) {
            // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† variant Ú©Ù‡ Ø§ÛŒÙ† attribute Ø±Ø§ Ø¯Ø§Ø±Ø¯
            const attrIdStr = String(attributeId);
            return variants.find(v => {
                return v.options && v.options[attrIdStr] !== undefined;
            });
        }
        
        function formatPrice(price) {
            return new Intl.NumberFormat('fa-IR').format(Math.round(price));
        }

        function openProductStockModal(modalId) {
            try {
                const modalElement = document.getElementById(modalId);
                if (!modalElement) return;

                modalElement.classList.add('show');
                modalElement.setAttribute('aria-hidden', 'false');
                document.body.style.overflow = 'hidden';
            } catch (error) {
                console.error('Error while opening stock modal:', error);
            }
        }

        function closeProductStockModal(modalElement) {
            try {
                if (!modalElement) return;

                modalElement.classList.remove('show');
                modalElement.setAttribute('aria-hidden', 'true');

                // Ø§Ú¯Ø± Ù‡ÛŒÚ† Ù…ÙˆØ¯Ø§Ù„ Ø¯ÛŒÚ¯Ø±ÛŒ Ø¨Ø§Ø² Ù†ÛŒØ³ØªØŒ Ø§Ø³Ú©Ø±ÙˆÙ„ Ø±Ø§ Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†
                const anyOpen = document.querySelector('.product-stock-modal.show');
                if (!anyOpen) {
                    document.body.style.overflow = '';
                }
            } catch (error) {
                console.error('Error while closing stock modal:', error);
            }
        }

        function showOutOfStockModal() {
            openProductStockModal('outOfStockModal');
        }
        
        function validateVariantSelection(event) {
            try {
                // Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¢ÛŒØ§ Ù…Ø­ØµÙˆÙ„ variant Ø¯Ø§Ø±Ø¯
                const allVariantAttributes = @Html.Raw(System.Text.Json.JsonSerializer.Serialize((Model.VariantAttributes ?? new List<ProductVariantAttributeViewModel>()).Select(a => a.Id.ToString())));
                const hasVariants = allVariantAttributes && allVariantAttributes.length > 0 && variants && variants.length > 0;
                
                // Ø§Ú¯Ø± Ù…Ø­ØµÙˆÙ„ variant Ù†Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯ØŒ Ø§Ø¬Ø§Ø²Ù‡ Ø§Ø±Ø³Ø§Ù„
                if (!hasVariants) {
                    const formVariantId = document.getElementById('formVariantId');
                    if (formVariantId) {
                        formVariantId.value = ''; // variantId Ø±Ø§ Ø®Ø§Ù„ÛŒ Ø¨Ú¯Ø°Ø§Ø±
                    }
                    return true; // Ø§Ø¬Ø§Ø²Ù‡ Ø§Ø±Ø³Ø§Ù„
                }
                
                // Ø§Ú¯Ø± Ù…Ø­ØµÙˆÙ„ variant Ø¯Ø§Ø±Ø¯ØŒ Ø¨Ø§ÛŒØ¯ variant Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯
                const formVariantIdElement = document.getElementById('formVariantId');
                const variantId = formVariantIdElement ? (formVariantIdElement.value || '') : '';
                // Ù‡Ù…Ù‡ variant attributes Ø±Ø§ Ø¯Ø± Ù†Ø¸Ø± Ø¨Ú¯ÛŒØ±
                const variantAttributes = @Html.Raw(System.Text.Json.JsonSerializer.Serialize((Model.VariantAttributes ?? new List<ProductVariantAttributeViewModel>()).Select(a => a.Id.ToString())));
                const variantAttributesWithOptions = @Html.Raw(System.Text.Json.JsonSerializer.Serialize((Model.VariantAttributes ?? new List<ProductVariantAttributeViewModel>()).Where(a => a.Options != null && a.Options.Any()).Select(a => a.Id.ToString())));
                
                // Ø§Ú¯Ø± variant attribute Ø§ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯ØŒ Ø§Ø¬Ø§Ø²Ù‡ Ø§Ø±Ø³Ø§Ù„
                if (!variantAttributes || variantAttributes.length === 0) {
                    if (formVariantIdElement) {
                        formVariantIdElement.value = '';
                    }
                    return true;
                }
                
                // Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¢ÛŒØ§ ØªÙ…Ø§Ù… ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ø¯Ø§Ø±Ø§ÛŒ Ú¯Ø²ÛŒÙ†Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯
                let allSelected = true;
                for (const attrId of variantAttributesWithOptions) {
                    const attrIdStr = String(attrId);
                    if (!selectedOptions[attrIdStr]) {
                        allSelected = false;
                        break;
                    }
                }
                
                // Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¢ÛŒØ§ ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ø¨Ø¯ÙˆÙ† Ú¯Ø²ÛŒÙ†Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯
                for (const attrId of variantAttributes) {
                    if (!variantAttributesWithOptions.includes(attrId)) {
                        // Ø§ÛŒÙ† ÙˆÛŒÚ˜Ú¯ÛŒ Ø¨Ø¯ÙˆÙ† Ú¯Ø²ÛŒÙ†Ù‡ Ø§Ø³Øª
                        const attrIdStr = String(attrId);
                        if (selectedOptions[attrIdStr] === '__SELECTED__') {
                            // Ø§ÛŒÙ† ÙˆÛŒÚ˜Ú¯ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡ Ø§Ø³Øª
                            allSelected = true; // Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© ÙˆÛŒÚ˜Ú¯ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡ Ø§Ø³Øª
                        }
                    }
                }
                
                const addToCartBtnForValidation = document.getElementById('addToCartBtn');
                const isBaseOutOfStock = addToCartBtnForValidation && addToCartBtnForValidation.dataset.outOfStock === 'true';
                const isVariantOutOfStock = addToCartBtnForValidation && addToCartBtnForValidation.dataset.variantOutOfStock === 'true';

                // Ø§Ú¯Ø± ØªÙ…Ø§Ù… ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ ÛŒØ§ variantId ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯ØŒ Ø®Ø·Ø§
                if (!allSelected || !variantId || variantId.trim() === '') {
                    event.preventDefault();
                    const errorElement = document.getElementById('variantValidationError');
                    if (errorElement) {
                        errorElement.style.display = 'block';
                        errorElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                    return false;
                }

                // Ø§Ú¯Ø± Ù…Ø­ØµÙˆÙ„ ÛŒØ§ variant Ù†Ø§Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ø´Ø¯ØŒ Ø§Ø¬Ø§Ø²Ù‡ Ø§Ø±Ø³Ø§Ù„ Ù†Ø¯Ù‡ Ùˆ Ù…ÙˆØ¯Ø§Ù„ Ø±Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¨Ø¯Ù‡
                if (isBaseOutOfStock || isVariantOutOfStock) {
                    event.preventDefault();
                    showOutOfStockModal();
                    return false;
                }
                
                return true;
            } catch (error) {
                console.error('Error in validateVariantSelection:', error);
                // Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§ØŒ Ø§Ø¬Ø§Ø²Ù‡ Ø§Ø±Ø³Ø§Ù„ Ø¨Ø¯Ù‡ (fallback)
                return true;
            }
        }
        
        // Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ ÙˆØ¶Ø¹ÛŒØª Ø¯Ú©Ù…Ù‡ Ù‡Ù†Ú¯Ø§Ù… Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØµÙØ­Ù‡
        document.addEventListener('DOMContentLoaded', function() {
            // Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¢ÛŒØ§ Ù…Ø­ØµÙˆÙ„ variant Ø¯Ø§Ø±Ø¯
            const allVariantAttributes = @Html.Raw(System.Text.Json.JsonSerializer.Serialize((Model.VariantAttributes ?? new List<ProductVariantAttributeViewModel>()).Select(a => a.Id.ToString())));
            const hasVariants = allVariantAttributes && allVariantAttributes.length > 0 && variants && variants.length > 0;
            const addToCartBtn = document.getElementById('addToCartBtn');
            if (addToCartBtn) {
                const isBaseOutOfStock = addToCartBtn.dataset.outOfStock === 'true';

                if (isBaseOutOfStock) {
                    // Ù…Ø­ØµÙˆÙ„ Ø¨Ø¯ÙˆÙ† variant Ùˆ Ù†Ø§Ù…ÙˆØ¬ÙˆØ¯: Ø¯Ú©Ù…Ù‡ ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù…ÙˆØ¯Ø§Ù„ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
                    addToCartBtn.classList.remove('btn-primary');
                    addToCartBtn.classList.add('btn-outline-secondary');
                } else if (hasVariants) {
                    // Ø§Ú¯Ø± Ù…Ø­ØµÙˆÙ„ variant Ø¯Ø§Ø±Ø¯ØŒ Ø¯Ú©Ù…Ù‡ Ø±Ø§ ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ù† ØªØ§ Ú©Ø§Ø±Ø¨Ø± variant Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†Ø¯
                    addToCartBtn.disabled = true;
                } else {
                    // Ø§Ú¯Ø± Ù…Ø­ØµÙˆÙ„ variant Ù†Ø¯Ø§Ø±Ø¯ Ùˆ Ù†Ø§Ù…ÙˆØ¬ÙˆØ¯ Ù‡Ù… Ù†ÛŒØ³ØªØŒ Ø¯Ú©Ù…Ù‡ Ø±Ø§ ÙØ¹Ø§Ù„ Ú©Ù†
                    addToCartBtn.disabled = false;
                    addToCartBtn.removeAttribute('disabled');
                    // variantId Ø±Ø§ Ø®Ø§Ù„ÛŒ Ø¨Ú¯Ø°Ø§Ø±
                    const formVariantId = document.getElementById('formVariantId');
                    if (formVariantId) {
                        formVariantId.value = '';
                    }
                    
                    // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† hidden inputs Ø¨Ø±Ø§ÛŒ variant attributes (Ú†ÙˆÙ† Ù…Ø­ØµÙˆÙ„ variant Ù†Ø¯Ø§Ø±Ø¯)
                    const container = document.getElementById('selectedVariantAttributesContainer');
                    if (container) {
                        container.innerHTML = '';
                    }
                }

                // Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù…ÙˆØ¯Ø§Ù„ Ø¯Ø± Ø­Ø§Ù„Øª Ù†Ø§Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ù†
                addToCartBtn.addEventListener('click', function (e) {
                    const isBaseOutOfStockClick = addToCartBtn.dataset.outOfStock === 'true';
                    const isVariantOutOfStockClick = addToCartBtn.dataset.variantOutOfStock === 'true';
                    if (isBaseOutOfStockClick || isVariantOutOfStockClick) {
                        e.preventDefault();
                        showOutOfStockModal();
                    }
                });

                // Back-in-stock "Ø®Ø¨Ø±Ù… Ú©Ù†" button
                const backInStockBtn = document.getElementById('backInStockNotifyBtn');

                function getAntiForgeryToken() {
                    const tokenInput = document.querySelector('input[name="__RequestVerificationToken"]');
                    return tokenInput ? tokenInput.value : '';
                }

                // ØªØ¨Ø¯ÛŒÙ„ Ø§Ø±Ù‚Ø§Ù… ÙØ§Ø±Ø³ÛŒ/Ø¹Ø±Ø¨ÛŒ Ø¨Ù‡ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ (Ø¨Ø§ Unicode range Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² ØµØ­Øª)
                function convertPersianToEnglish(str) {
                    return str
                        // Persian digits: Û°-Û¹ (U+06F0 to U+06F9)
                        .replace(/[\u06F0-\u06F9]/g, function(d) { return String.fromCharCode(d.charCodeAt(0) - 0x06F0 + 48); })
                        // Arabic-Indic digits: Ù -Ù© (U+0660 to U+0669)
                        .replace(/[\u0660-\u0669]/g, function(d) { return String.fromCharCode(d.charCodeAt(0) - 0x0660 + 48); });
                }

                let backInStockVerifiedPhone = null;

                function resetBackInStockPhoneForm() {
                    const phoneInput = document.getElementById('backInStockPhone');
                    const phoneError = document.getElementById('backInStockPhoneError');

                    if (phoneInput) {
                        phoneInput.value = '';
                    }
                    if (phoneError) {
                        phoneError.classList.add('d-none');
                        phoneError.textContent = '';
                    }
                    backInStockVerifiedPhone = null;
                }

                function resetBackInStockCodeForm() {
                    const codeInput = document.getElementById('backInStockCode');
                    const codeError = document.getElementById('backInStockCodeError');
                    const debugCode = document.getElementById('backInStockDebugCode');
                    const successMsg = document.getElementById('backInStockSuccessMessage');
                    const displayPhone = document.getElementById('backInStockDisplayPhone');

                    if (codeInput) codeInput.value = '';
                    if (codeError) {
                        codeError.classList.add('d-none');
                        codeError.textContent = '';
                    }
                    if (debugCode) debugCode.textContent = '';
                    if (successMsg) {
                        successMsg.classList.add('d-none');
                        successMsg.textContent = '';
                    }
                    if (displayPhone) displayPhone.textContent = '';
                }

                function openBackInStockModal() {
                    resetBackInStockPhoneForm();
                    openProductStockModal('backInStockModal');
                }

                function openBackInStockCodeModal(phone, code) {
                    resetBackInStockCodeForm();
                    const displayPhone = document.getElementById('backInStockDisplayPhone');
                    const debugCode = document.getElementById('backInStockDebugCode');
                    if (displayPhone) displayPhone.textContent = phone;
                    if (debugCode && code) debugCode.textContent = code;
                    openProductStockModal('backInStockCodeModal');
                }

                if (backInStockBtn) {
                    backInStockBtn.addEventListener('click', function (e) {
                        const isSubscribed = backInStockBtn.dataset.subscribed === 'true';

                        if (isSubscribed) {
                            // Ù„ØºÙˆ Ø®Ø¨Ø±Ù… Ú©Ù†
                            e.preventDefault();

                            const productId = backInStockBtn.dataset.productId;
                            const token = getAntiForgeryToken();

                            if (!productId || !token) {
                                return;
                            }

                            const body = new URLSearchParams();
                            body.append('productId', productId);

                            fetch('@Url.Action("UnsubscribeBackInStock", "Product")', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
                                    'RequestVerificationToken': token
                                },
                                body: body.toString()
                            })
                                .then(response => response.json())
                                .then(data => {
                                    if (data && data.success) {
                                        backInStockBtn.dataset.subscribed = 'false';
                                        backInStockBtn.textContent = 'Ø®Ø¨Ø±Ù… Ú©Ù†';
                                    } else if (data && data.message) {
                                        alert(data.message);
                                    }
                                })
                                .catch(() => {
                                    alert('Ù„ØºÙˆ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ø§ Ø®Ø·Ø§ Ù…ÙˆØ§Ø¬Ù‡ Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.');
                                });
                        } else {
                            // Ø«Ø¨Øª Ø®Ø¨Ø±Ù… Ú©Ù†
                            openBackInStockModal();
                        }
                    });
                }

                // ÙØ±Ù… Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ (Ù…ÙˆØ¯Ø§Ù„ Ø§ÙˆÙ„)
                const backInStockPhoneForm = document.getElementById('backInStockPhoneForm');
                if (backInStockPhoneForm) {
                    backInStockPhoneForm.addEventListener('submit', function (event) {
                        event.preventDefault();

                        const phoneInput = document.getElementById('backInStockPhone');
                        const errorElement = document.getElementById('backInStockPhoneError');

                        if (!phoneInput || !errorElement) return;

                        const token = getAntiForgeryToken();
                        const productId = backInStockBtn ? backInStockBtn.dataset.productId : null;

                        if (!productId || !token) return;

                        // ØªØ¨Ø¯ÛŒÙ„ Ø§Ø±Ù‚Ø§Ù… ÙØ§Ø±Ø³ÛŒ Ø¨Ù‡ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ
                        const rawPhone = convertPersianToEnglish((phoneInput.value || '').trim());

                        // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ø§ÛŒØ±Ø§Ù†ÛŒ
                        const phoneRegex = /(^(0?9)|(\+?989))\d{2}\W?\d{3}\W?\d{4}/;
                        if (!phoneRegex.test(rawPhone)) {
                            errorElement.textContent = 'Ù„Ø·ÙØ§Ù‹ Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ù…Ø¹ØªØ¨Ø± Ø§ÛŒØ±Ø§Ù†ÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ù…Ø«Ø§Ù„: 09123456789).';
                            errorElement.classList.remove('d-none');
                            return;
                        }

                        // Ù†Ø±Ù…Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø´Ù…Ø§Ø±Ù‡ Ø¨Ù‡ ÙØ±Ù…Øª 09xxxxxxxxx
                        const digits = rawPhone.replace(/[^0-9]/g, '');
                        let normalizedPhone = digits;
                        if (digits.startsWith('989')) {
                            normalizedPhone = '0' + digits.substring(2); // 989... -> 09...
                        } else if (digits.startsWith('9') && digits.length === 10) {
                            normalizedPhone = '0' + digits; // 9... -> 09...
                        }

                        errorElement.classList.add('d-none');

                        const body = new URLSearchParams();
                        body.append('productId', productId);
                        body.append('phoneNumber', normalizedPhone);

                        fetch('@Url.Action("StartBackInStockVerification", "Product")', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
                                'RequestVerificationToken': token
                            },
                            body: body.toString()
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data && data.success) {
                                    backInStockVerifiedPhone = normalizedPhone;
                                    // Ø¨Ø³ØªÙ† Ù…ÙˆØ¯Ø§Ù„ Ø´Ù…Ø§Ø±Ù‡
                                    closeProductStockModal(document.getElementById('backInStockModal'));
                                    // Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù…ÙˆØ¯Ø§Ù„ Ú©Ø¯
                                    openBackInStockCodeModal(normalizedPhone, data.code);
                                } else if (data && data.message) {
                                    errorElement.textContent = data.message;
                                    errorElement.classList.remove('d-none');
                                }
                            })
                            .catch(() => {
                                errorElement.textContent = 'Ø§Ø±Ø³Ø§Ù„ Ú©Ø¯ ØªØ§ÛŒÛŒØ¯ Ø¨Ø§ Ø®Ø·Ø§ Ù…ÙˆØ§Ø¬Ù‡ Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.';
                                errorElement.classList.remove('d-none');
                            });
                    });
                }

                // ÙØ±Ù… Ú©Ø¯ ØªØ§ÛŒÛŒØ¯ (Ù…ÙˆØ¯Ø§Ù„ Ø¯ÙˆÙ…)
                const backInStockCodeForm = document.getElementById('backInStockCodeForm');
                if (backInStockCodeForm) {
                    backInStockCodeForm.addEventListener('submit', function (event) {
                        event.preventDefault();

                        const codeInput = document.getElementById('backInStockCode');
                        const codeError = document.getElementById('backInStockCodeError');
                        const successMsg = document.getElementById('backInStockSuccessMessage');

                        if (!codeInput || !codeError) return;

                        const token = getAntiForgeryToken();
                        const productId = backInStockBtn ? backInStockBtn.dataset.productId : null;

                        if (!productId || !token || !backInStockVerifiedPhone) return;

                        // ØªØ¨Ø¯ÛŒÙ„ Ø§Ø±Ù‚Ø§Ù… ÙØ§Ø±Ø³ÛŒ Ø¨Ù‡ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ
                        const code = convertPersianToEnglish((codeInput.value || '').trim());

                        if (!/^\d{6}$/.test(code)) {
                            codeError.textContent = 'Ú©Ø¯ ØªØ§ÛŒÛŒØ¯ Û¶ Ø±Ù‚Ù…ÛŒ Ø±Ø§ Ø¨Ù‡â€ŒØ¯Ø±Ø³ØªÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.';
                            codeError.classList.remove('d-none');
                            return;
                        }

                        codeError.classList.add('d-none');

                        const body = new URLSearchParams();
                        body.append('productId', productId);
                        body.append('phoneNumber', backInStockVerifiedPhone);
                        body.append('code', code);

                        fetch('@Url.Action("ConfirmBackInStock", "Product")', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
                                'RequestVerificationToken': token
                            },
                            body: body.toString()
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data && data.success) {
                                    // Ø¯Ø± ØµÙˆØ±Øª Ù…ÙˆÙÙ‚ÛŒØªØŒ Ù…ÙˆØ¯Ø§Ù„ Ú©Ø¯ Ø±Ø§ Ø¨Ø¨Ù†Ø¯ Ùˆ Ù…ÙˆØ¯Ø§Ù„ Ù…ÙˆÙÙ‚ÛŒØª Ø±Ø§ Ù†Ø´Ø§Ù† Ø¨Ø¯Ù‡
                                    const codeModal = document.getElementById('backInStockCodeModal');
                                    const successModalId = 'backInStockSuccessModal';

                                    if (codeModal) {
                                        closeProductStockModal(codeModal);
                                    }

                                    if (backInStockBtn) {
                                        backInStockBtn.dataset.subscribed = 'true';
                                        backInStockBtn.textContent = 'Ù„ØºÙˆ Ø®Ø¨Ø±Ù… Ú©Ù†';
                                    }

                                    openProductStockModal(successModalId);
                                } else if (data && data.message) {
                                    codeError.textContent = data.message;
                                    codeError.classList.remove('d-none');
                                }
                            })
                            .catch(() => {
                                codeError.textContent = 'Ø«Ø¨Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ø§ Ø®Ø·Ø§ Ù…ÙˆØ§Ø¬Ù‡ Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.';
                                codeError.classList.remove('d-none');
                            });
                    });
                }

                // Ù‡Ù†Ø¯Ù„ Ø¨Ø³ØªÙ† Ù…ÙˆØ¯Ø§Ù„â€ŒÙ‡Ø§ (Ú©Ù„ÛŒØ¯ Ø¶Ø±Ø¨Ø¯Ø±ØŒ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ Ùˆ Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡)
                document.querySelectorAll('.product-stock-modal').forEach(modalElement => {
                    modalElement.addEventListener('click', function (e) {
                        if (e.target === modalElement) {
                            closeProductStockModal(modalElement);
                        }
                    });

                    const closeButtons = modalElement.querySelectorAll('[data-product-modal-close]');
                    closeButtons.forEach(btn => {
                        btn.addEventListener('click', function (e) {
                            e.preventDefault();
                            const parentModal = this.closest('.product-stock-modal') || modalElement;
                            closeProductStockModal(parentModal);

                            if (parentModal.id === 'backInStockModal') {
                                resetBackInStockForm();
                            }
                        });
                    });
                });
            }
        });
        
        function changeMainImage(src) {
            document.getElementById('main-product-image').src = src;
            document.querySelectorAll('.thumbnail').forEach(thumb => {
                thumb.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // Star rating functionality
        document.addEventListener('DOMContentLoaded', function() {
            const starRating = document.getElementById('starRating');
            const ratingValue = document.getElementById('ratingValue');
            const ratingText = document.getElementById('ratingText');

            if (starRating && ratingValue && ratingText) {
                const stars = starRating.querySelectorAll('.star');

                stars.forEach(star => {
                    star.addEventListener('click', function() {
                        const rating = parseInt(this.dataset.rating);
                        ratingValue.value = rating;
                        updateStarDisplay(stars, rating);
                        ratingText.textContent = rating + ' Ø³ØªØ§Ø±Ù‡';
                    });

                    star.addEventListener('mouseenter', function() {
                        const rating = parseInt(this.dataset.rating);
                        updateStarDisplay(stars, rating);
                    });
                });

                starRating.addEventListener('mouseleave', function() {
                    const currentRating = parseInt(ratingValue.value);
                    updateStarDisplay(stars, currentRating);
                });

                // Initialize with default rating
                updateStarDisplay(stars, parseInt(ratingValue.value));
            }

            function updateStarDisplay(stars, rating) {
                stars.forEach((star, index) => {
                    const starValue = parseInt(star.dataset.rating);
                    if (starValue <= rating) {
                        star.style.color = '#ffc107';
                        star.style.cursor = 'pointer';
                    } else {
                        star.style.color = '#ccc';
                        star.style.cursor = 'pointer';
                    }
                });
            }
        });

        // Toggle reply form
        function toggleReplyForm(formId, button) {
            const form = document.getElementById(formId);
            if (form) {
                const isExpanded = button.getAttribute('aria-expanded') === 'true';
                if (isExpanded) {
                    form.style.display = 'none';
                    button.setAttribute('aria-expanded', 'false');
                } else {
                    form.style.display = 'block';
                    button.setAttribute('aria-expanded', 'true');
                }
            }
        }

        // Show comment success modal
        @if (commentSuccess == true)
        {
                <text>
                document.addEventListener('DOMContentLoaded', function() {
                    const modal = document.getElementById('commentSuccessModal');
                    if (modal) {
                        modal.style.display = 'flex';
                        document.body.style.overflow = 'hidden';
                    }
                });
                </text>
        }

        // Close comment success modal
        function closeCommentSuccessModal() {
            const modal = document.getElementById('commentSuccessModal');
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = '';
            }
        }

        // Show comment error modal
        function showCommentErrorModal(errors) {
            const modal = document.getElementById('commentErrorModal');
            const errorMessageDiv = document.getElementById('commentErrorMessage');

            if (!modal || !errorMessageDiv) return;

            // Clear previous errors
            errorMessageDiv.innerHTML = '';

            // Create error list
            if (Array.isArray(errors) && errors.length > 0) {
                const ul = document.createElement('ul');
                errors.forEach(error => {
                    const li = document.createElement('li');
                    li.textContent = error;
                    ul.appendChild(li);
                });
                errorMessageDiv.appendChild(ul);
            } else if (typeof errors === 'string') {
                errorMessageDiv.innerHTML = '<p style="color: #dc3545; margin: 0;">' + errors + '</p>';
            }

            // Show modal
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        // Close comment error modal
        function closeCommentErrorModal() {
            const modal = document.getElementById('commentErrorModal');
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = '';
            }
        }

        // Handle comment form submission
        document.addEventListener('DOMContentLoaded', function() {
            const commentForm = document.getElementById('commentForm');
            if (commentForm) {
                // Check for server-side validation errors on page load first
                const serverErrors = [];

                // Check validation summary (even if hidden)
                const validationSummary = commentForm.querySelector('div.text-danger');
                if (validationSummary) {
                    const summaryText = validationSummary.textContent.trim();
                    if (summaryText) {
                        // Try to parse errors - they might be in a list or separated
                        const errorLines = summaryText.split(/\n|\r/).map(e => e.trim()).filter(e => e && e.length > 0);
                        errorLines.forEach(error => {
                            if (error && !serverErrors.includes(error)) {
                                serverErrors.push(error);
                            }
                        });
                    }
                }

                // Check all error spans (even if hidden)
                const allErrorSpans = commentForm.querySelectorAll('span.text-danger');
                allErrorSpans.forEach(span => {
                    const errorText = span.textContent.trim();
                    if (errorText && !serverErrors.includes(errorText)) {
                        serverErrors.push(errorText);
                    }
                });

                // Show modal if there are server-side errors
                if (serverErrors.length > 0) {
                    showCommentErrorModal(serverErrors);
                }

                // Handle form submission
                commentForm.addEventListener('submit', function(e) {
                    // Validate required fields
                    const authorName = document.getElementById('commentAuthorName');
                    const content = document.getElementById('commentContent');
                    const errors = [];

                    if (!authorName || !authorName.value.trim()) {
                        errors.push('Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.');
                    }

                    if (!content || !content.value.trim()) {
                        errors.push('Ù„Ø·ÙØ§Ù‹ Ù…ØªÙ† Ù†Ø¸Ø± Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯.');
                    }

                    // If there are client-side validation errors, show modal and prevent submission
                    if (errors.length > 0) {
                        e.preventDefault();
                        showCommentErrorModal(errors);
                        return false;
                    }
                });
            }
        });

        // Add to wishlist functionality
        async function addToWishlist(productId) {
            const button = document.getElementById('wishlist-btn');
            if (!button) return;

            // Disable button during request
            const originalText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = 'â³ Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´...';

            try {
                // Get anti-forgery token
                const tokenInput = document.querySelector('input[name="__RequestVerificationToken"]');
                if (!tokenInput) {
                    throw new Error('ØªÙˆÚ©Ù† Ø§Ù…Ù†ÛŒØªÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.');
                }

                const formData = new FormData();
                formData.append('productId', productId);
                formData.append('__RequestVerificationToken', tokenInput.value);

                const response = await fetch('/Wishlist/Toggle', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'RequestVerificationToken': tokenInput.value
                    }
                });

                // Check if response is redirect (unauthorized)
                if (response.redirected || response.status === 401 || response.status === 302) {
                    showNotification('Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø®ÙˆØ¯ Ø´ÙˆÛŒØ¯.', 'error');
                    button.innerHTML = originalText;
                    // Optionally redirect to login
                    if (response.redirected) {
                        window.location.href = response.url;
                    }
                    return;
                }

                const data = await response.json();

                if (data.success) {
                    // Success - update button appearance
                    button.innerHTML = 'â¤ï¸ Ø§ÙØ²ÙˆØ¯Ù‡ Ø´Ø¯ Ø¨Ù‡ Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§';
                    button.classList.remove('btn-secondary');
                    button.classList.add('btn-success');

                    // Show success message
                    showNotification(data.message || 'Ù…Ø­ØµÙˆÙ„ Ø¨Ù‡ Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯.', 'success');
                } else {
                    // Error
                    const errorMessage = data.error || 'Ø®Ø·Ø§ Ø¯Ø± Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ù‡ Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§';
                    showNotification(errorMessage, 'error');
                    button.innerHTML = originalText;
                }
            } catch (error) {
                console.error('Error adding to wishlist:', error);
                showNotification('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.', 'error');
                button.innerHTML = originalText;
            } finally {
                button.disabled = false;
            }
        }

        // Show notification
        function showNotification(message, type) {
            // Remove existing notifications
            const existing = document.querySelector('.wishlist-notification');
            if (existing) {
                existing.remove();
            }

            // Create notification element
            const notification = document.createElement('div');
            notification.className = `wishlist-notification wishlist-notification-${type}`;
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                background: ${type === 'success' ? '#28a745' : '#dc3545'};
                color: white;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                animation: slideIn 0.3s ease-out;
                max-width: 300px;
                font-size: 14px;
            `;

            // Add animation
            const style = document.createElement('style');
            style.textContent = `
                @@keyframes slideIn {
                    from {
                        transform: translateX(100%);
                        opacity: 0;
                    }
                    to {
                        transform: translateX(0);
                        opacity: 1;
                    }
                }
            `;
            if (!document.querySelector('style[data-wishlist-notification]')) {
                style.setAttribute('data-wishlist-notification', 'true');
                document.head.appendChild(style);
            }

            document.body.appendChild(notification);

            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }

    </script>
}

<!-- Violation Report Modal -->
<div class="violation-report-modal" id="violationReportModal">
    <div class="violation-report-modal__dialog">
        <div class="violation-report-modal__content">
            <div class="violation-report-modal__header">
                <h5 class="violation-report-modal__title">Ú¯Ø²Ø§Ø±Ø´ ØªØ®Ù„Ù Ù…Ø­ØµÙˆÙ„</h5>
                <button type="button" class="violation-report-modal__close" onclick="closeViolationReportModal()" aria-label="Ø¨Ø³ØªÙ†">Ã—</button>
            </div>
            <form asp-action="ReportViolation" asp-route-slug="@Model.Product.Slug" method="post" id="violationReportForm">
                @Html.AntiForgeryToken()
                <div class="violation-report-modal__body">
                    @if (TempData["ViolationReportSuccess"] != null)
                    {
                        <div class="alert alert-success" role="alert">
                            @TempData["ViolationReportSuccess"]
                        </div>
                    }
                    @if (TempData["ViolationReportError"] != null)
                    {
                        <div class="alert alert-danger" role="alert">
                            @TempData["ViolationReportError"]
                        </div>
                    }

                    <div class="violation-form-group">
                        <label for="violationSubject" class="violation-form-label">Ù…ÙˆØ¶ÙˆØ¹ ØªØ®Ù„Ù <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="violationSubject" name="Subject" required maxlength="200" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø­ØªÙˆØ§ÛŒ Ù†Ø§Ù…Ù†Ø§Ø³Ø¨ØŒ Ù‚ÛŒÙ…Øª ØºÛŒØ±Ù…Ù†Ø·Ù‚ÛŒØŒ ØªÙˆØ¶ÛŒØ­Ø§Øª Ù†Ø§Ø¯Ø±Ø³Øª">
                        <div class="violation-form-text">Ù„Ø·ÙØ§Ù‹ Ù…ÙˆØ¶ÙˆØ¹ ØªØ®Ù„Ù Ø±Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ø®Ù„Ø§ØµÙ‡ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.</div>
                    </div>

                    <div class="violation-form-group">
                        <label for="violationMessage" class="violation-form-label">Ù¾ÛŒØ§Ù… <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="violationMessage" name="Message" rows="5" required maxlength="2000" placeholder="Ù„Ø·ÙØ§Ù‹ Ø¬Ø²Ø¦ÛŒØ§Øª ØªØ®Ù„Ù Ø±Ø§ Ø´Ø±Ø­ Ø¯Ù‡ÛŒØ¯..."></textarea>
                        <div class="violation-form-text">Ø­Ø¯Ø§Ú©Ø«Ø± Û²Û°Û°Û° Ú©Ø§Ø±Ø§Ú©ØªØ±</div>
                    </div>

                    <div class="violation-form-group">
                        <label for="violationPhone" class="violation-form-label">Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ <span class="text-danger">*</span></label>
                        <input type="tel" class="form-control" id="violationPhone" name="ReporterPhone" required maxlength="20" placeholder="09123456789">
                        <div class="violation-form-text">Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ Ø´Ù…Ø§ Ø¨Ø±Ø§ÛŒ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ Ú¯Ø²Ø§Ø±Ø´</div>
                    </div>

                    @if (Model.IsSiteProduct || Model.Offers.Any() || Model.SuggestedProductOffers.Any())
                    {

                        // Get all unique seller IDs from offers and suggested offers
                        var allSellerIds = Model.Offers.Select(o => o.SellerId)
                        .Concat(Model.SuggestedProductOffers.Select(o => o.SellerId))
                        .Where(id => !string.IsNullOrWhiteSpace(id))
                        .Distinct()
                        .ToList();

                        // Create a dictionary to map seller IDs to their display info
                        var sellerOptions = new Dictionary<string, (string Name, Guid? OfferId, bool IsOffer)>();

                        // Add offers first (they have priority)
                        foreach (var offer in Model.Offers)
                        {
                            if (!string.IsNullOrWhiteSpace(offer.SellerId) && !sellerOptions.ContainsKey(offer.SellerId))
                            {
                                sellerOptions[offer.SellerId] = (offer.SellerName, offer.Id, true);
                            }
                        }

                        // Add suggested offers only if not already added
                        foreach (var offer in Model.SuggestedProductOffers)
                        {
                            if (!string.IsNullOrWhiteSpace(offer.SellerId) && !sellerOptions.ContainsKey(offer.SellerId))
                            {
                                sellerOptions[offer.SellerId] = (offer.SellerName, null, false);
                            }
                        }

                        <div class="violation-form-group">
                            <label for="violationOfferId" class="violation-form-label">ÙØ±ÙˆØ´Ù†Ø¯Ù‡ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
                            <select class="form-select" id="violationOfferId" name="ProductOfferId">
                                <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ (Ø§Ú¯Ø± Ú¯Ø²Ø§Ø±Ø´ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ ÙØ±ÙˆØ´Ù†Ø¯Ù‡ Ø®Ø§ØµÛŒ Ø§Ø³Øª)</option>
                                @if (Model.IsSiteProduct)
                                {
                                    <option value="" data-seller-id="" data-is-offer="false" data-is-site="true">Ø³Ø§ÛŒØª</option>
                                }
                                @foreach (var sellerOption in sellerOptions)
                                {
                                    var (name, offerId, isOffer) = sellerOption.Value;
                                    <option value="@(offerId?.ToString() ?? "")" data-seller-id="@sellerOption.Key" data-is-offer="@(isOffer ? "true" : "false")">
                                        @name
                                    </option>
                                }
                            </select>
                            <div class="violation-form-text">Ø§Ú¯Ø± Ú¯Ø²Ø§Ø±Ø´ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ ÙØ±ÙˆØ´Ù†Ø¯Ù‡ Ø®Ø§ØµÛŒ Ø§Ø³ØªØŒ Ø¢Ù† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.</div>
                        </div>
                    }

                    <input type="hidden" name="SellerId" id="violationSellerId" />
                </div>
                <div class="violation-report-modal__footer">
                    <button type="button" class="violation-modal-btn-cancel" onclick="closeViolationReportModal()">Ø§Ù†ØµØ±Ø§Ù</button>
                    <button type="submit" class="violation-modal-btn-submit">Ø«Ø¨Øª Ú¯Ø²Ø§Ø±Ø´</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function openViolationReportModal() {
        const modal = document.getElementById('violationReportModal');
        if (modal) {
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }
    }

    function closeViolationReportModal() {
        const modal = document.getElementById('violationReportModal');
        if (modal) {
            modal.classList.remove('show');
            document.body.style.overflow = '';
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        const modal = document.getElementById('violationReportModal');
        const offerSelect = document.getElementById('violationOfferId');
        const sellerIdInput = document.getElementById('violationSellerId');

        // Close modal when clicking outside
        if (modal) {
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeViolationReportModal();
                }
            });
        }

        if (offerSelect) {
            offerSelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                if (selectedOption && selectedOption.dataset.isSite === 'true') {
                    // Site product selected - clear both SellerId and ProductOfferId
                    sellerIdInput.value = '';
                    this.value = '';
                } else if (selectedOption && selectedOption.dataset.sellerId) {
                    sellerIdInput.value = selectedOption.dataset.sellerId;
                    // If it's not an offer (SuggestedProductOffer), clear ProductOfferId
                    if (selectedOption.dataset.isOffer === 'false') {
                        this.value = '';
                    }
                } else {
                    sellerIdInput.value = '';
                }
            });
        }

        @if (TempData["ViolationReportSuccess"] != null)
        {
                <text>
                // Show success message and open modal
                openViolationReportModal();
                // Close modal after 3 seconds
                setTimeout(function() {
                    closeViolationReportModal();
                }, 3000);
                </text>
        }

        // Close modal on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && modal && modal.classList.contains('show')) {
                closeViolationReportModal();
            }
        });
    });
</script>


