@model WishlistViewModel
@{
    Layout = "_HomeTemplateLayout";
    ViewData["Title"] = "علاقه‌مندی‌های من";
    ViewData["MetaDescription"] = "لیست محصولات مورد علاقه شما";
}

<style>
    .archive-product-card {
        position: relative;
    }

    .wishlist-remove-btn {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid rgba(0, 0, 0, 0.1);
        border-radius: 50%;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 16px;
        z-index: 10;
        transition: all 0.2s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .wishlist-remove-btn:hover {
        background: rgba(239, 68, 68, 0.9);
        color: white;
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }

    .wishlist-remove-btn:active {
        transform: scale(0.95);
    }

    .wishlist-remove-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
</style>

<!-- Wishlist Section -->
<section class="products-archive-section">
    <div class="container">
        <!-- Breadcrumb -->
        <div class="breadcrumb">
            <a asp-controller="Home" asp-action="Index">خانه</a> / 
            <span>علاقه‌مندی‌های من</span>
        </div>

        <!-- Page Header -->
        <div class="archive-header">
            <h1 class="archive-title">علاقه‌مندی‌های من</h1>
            <p class="archive-subtitle">محصولات مورد علاقه شما</p>
        </div>

        @if (!string.IsNullOrWhiteSpace(ViewBag.SuccessMessage as string))
        {
            <div class="alert alert-success" style="padding: 15px; margin-bottom: 20px; background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; border-radius: 5px;">
                @ViewBag.SuccessMessage
            </div>
        }

        @if (!string.IsNullOrWhiteSpace(ViewBag.ErrorMessage as string))
        {
            <div class="alert alert-danger" style="padding: 15px; margin-bottom: 20px; background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; border-radius: 5px;">
                @ViewBag.ErrorMessage
            </div>
        }

        <!-- Main Content -->
        <main class="archive-main" style="width: 100%;">
            <!-- Products Grid -->
            @if (Model.Products.Any())
            {
                <div class="archive-products-grid">
                    @foreach (var product in Model.Products)
                    {
                        <div class="archive-product-card" data-product-id="@product.Id">
                            @if (!string.IsNullOrWhiteSpace(product.Badge))
                            {
                                <span class="product-badge">@product.Badge</span>
                            }
                            <button type="button" class="wishlist-remove-btn" data-product-id="@product.Id" aria-label="حذف @product.Name از علاقه‌مندی‌ها" title="حذف از علاقه‌مندی‌ها">
                                ❌
                            </button>
                            <a asp-controller="Product" asp-action="Details" asp-route-slug="@product.Slug" style="text-decoration: none; color: inherit;">
                                <div class="archive-product-image">
                                    <img src="@product.ThumbnailUrl" alt="@product.Name" style="width: 100%; height: 100%; object-fit: cover;" />
                                </div>
                                <div class="archive-product-info">
                                    <h3 class="archive-product-name">@StringHelper.TruncateName(product.Name)</h3>
                                    <p class="archive-product-desc">@StringHelper.TruncateDescription(product.ShortDescription)</p>
                                    <div class="archive-product-rating">
                                        @for (int i = 0; i < (int)product.Rating; i++)
                                        {
                                            <span>⭐</span>
                                        }
                                        @product.GetRatingLabel()
                                    </div>
                                    <div class="archive-product-price">@product.GetFormattedPrice() تومان</div>
                                    <span class="archive-product-btn">مشاهده جزئیات</span>
                                </div>
                            </a>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="archive-empty" style="text-align: center; padding: 60px 20px;">
                    <div style="font-size: 64px; margin-bottom: 20px;">❤️</div>
                    <h2 style="margin-bottom: 10px; color: #666;">لیست علاقه‌مندی‌های شما خالی است</h2>
                    <p style="color: #999; margin-bottom: 30px;">محصولات مورد علاقه خود را به این لیست اضافه کنید</p>
                    <a asp-controller="Product" asp-action="Index" class="btn btn-primary" style="display: inline-block; padding: 12px 30px; text-decoration: none; border-radius: 5px;">
                        مشاهده محصولات
                    </a>
                </div>
            }
        </main>
    </div>
</section>

@section Scripts {
    <form style="display: none;" id="anti-forgery-form">
        @Html.AntiForgeryToken()
    </form>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Get anti-forgery token
            const tokenInput = document.querySelector('input[name="__RequestVerificationToken"]');

            // Handle remove button clicks
            document.querySelectorAll('.wishlist-remove-btn').forEach(btn => {
                btn.addEventListener('click', async function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const productId = this.getAttribute('data-product-id');
                    const productCard = this.closest('[data-product-id]');
                    
                    if (!productId || !productCard) {
                        return;
                    }

                    // Show confirmation modal
                    const removeProduct = async () => {
                        // Disable button during request
                        const originalText = this.innerHTML;
                        this.disabled = true;
                        this.innerHTML = '⏳';

                        try {
                            const formData = new FormData();
                            formData.append('productId', productId);
                            
                            const token = document.querySelector('input[name="__RequestVerificationToken"]');
                            if (token) {
                                formData.append('__RequestVerificationToken', token.value);
                            }

                            const response = await fetch('@Url.Action("Remove", "Wishlist")', {
                                method: 'POST',
                                body: formData,
                                headers: {
                                    'X-Requested-With': 'XMLHttpRequest'
                                }
                            });

                            const result = await response.json();

                            if (result.success) {
                                // Reload page after successful deletion
                                location.reload();
                            } else {
                                // Show error message
                                const errorMessage = result.error || 'خطا در حذف از علاقه‌مندی‌ها';
                                if (typeof showToast === 'function') {
                                    showToast(errorMessage, 'danger');
                                } else {
                                    alert(errorMessage);
                                }
                                this.disabled = false;
                                this.innerHTML = originalText;
                            }
                        } catch (error) {
                            console.error('Error:', error);
                            if (typeof showToast === 'function') {
                                showToast('خطا در ارتباط با سرور. لطفا دوباره تلاش کنید.', 'danger');
                            } else {
                                alert('خطا در ارتباط با سرور. لطفا دوباره تلاش کنید.');
                            }
                            this.disabled = false;
                            this.innerHTML = originalText;
                        }
                    };

                    // Show confirmation modal
                    if (window.AppAlert && typeof window.AppAlert.show === 'function') {
                        window.AppAlert.show({
                            title: 'حذف از علاقه‌مندی‌ها',
                            message: 'آیا مطمئن هستید که می‌خواهید این محصول را از لیست علاقه‌مندی‌ها حذف کنید؟',
                            type: 'warning',
                            confirmText: 'بله، حذف شود',
                            cancelText: 'خیر، انصراف',
                            showCancel: true,
                            onConfirm: removeProduct
                        });
                    } else {
                        // Fallback to confirm if AppAlert is not available
                        if (confirm('آیا مطمئن هستید که می‌خواهید این محصول را از لیست علاقه‌مندی‌ها حذف کنید؟')) {
                            removeProduct();
                        }
                    }
                });
            });
        });

        // Toast functions (if not already defined)
        function showToast(message, type = 'info') {
            let toastStack = document.querySelector('[data-app-toast-stack]');
            if (!toastStack) {
                toastStack = document.createElement('div');
                toastStack.className = 'app-toast-stack';
                toastStack.setAttribute('data-app-toast-stack', '');
                document.body.appendChild(toastStack);
            }

            const toastClass = type === 'danger' ? 'app-toast--danger' : 
                              type === 'success' ? 'app-toast--success' : 'app-toast';
            const iconMark = type === 'danger' ? '!' : 
                            type === 'success' ? '✓' : 'i';

            const toast = document.createElement('div');
            toast.className = `app-toast ${toastClass}`;
            toast.setAttribute('role', type === 'danger' ? 'alert' : 'status');
            toast.setAttribute('aria-live', type === 'danger' ? 'assertive' : 'polite');
            toast.setAttribute('data-app-toast', '');
            toast.setAttribute('data-toast-lifetime', type === 'danger' ? '6000' : '3000');

            toast.innerHTML = `
                <span class="app-toast__icon" aria-hidden="true">
                    <span class="app-toast__icon-mark">${iconMark}</span>
                </span>
                <div class="app-toast__body">${message}</div>
                <button type="button" class="app-toast__close" aria-label="بستن اعلان" data-app-toast-dismiss>
                    <span aria-hidden="true">×</span>
                </button>
            `;

            toastStack.appendChild(toast);

            requestAnimationFrame(() => {
                toast.classList.add('is-visible');
            });

            const dismissBtn = toast.querySelector('[data-app-toast-dismiss]');
            if (dismissBtn) {
                dismissBtn.addEventListener('click', () => hideToast(toast));
            }

            const lifetime = parseInt(toast.getAttribute('data-toast-lifetime') || '3000', 10);
            if (lifetime > 0) {
                setTimeout(() => hideToast(toast), lifetime);
            }
        }

        function hideToast(toast) {
            if (!toast || toast.classList.contains('is-hiding')) {
                return;
            }

            toast.classList.remove('is-visible');
            toast.classList.add('is-hiding');
            
            const remove = () => {
                toast.removeEventListener('transitionend', remove);
                toast.remove();
                
                const toastStack = document.querySelector('[data-app-toast-stack]');
                if (toastStack && !toastStack.querySelector('[data-app-toast]')) {
                    toastStack.remove();
                }
            };

            toast.addEventListener('transitionend', remove);
        }
    </script>
}

