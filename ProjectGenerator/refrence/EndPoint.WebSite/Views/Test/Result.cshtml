@using EndPoint.WebSite.Models.Test
@using Arsis.Domain.Enums
@using System.Globalization
@using System.Text.Json
@using System.Linq
@model TestResultViewModel

@{
    ViewData["Title"] = "نتیجه آزمون";
    var attempt = Model.Attempt;
    var culture = new CultureInfo("fa-IR");
}

<style>
    .chart-grid {
        display: grid;
        gap: 1.5rem;
    }

    .chart-grid.grid-2 {
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    }

    .panel {
        border-radius: 16px;
        background: #fff;
        box-shadow: 0 12px 30px rgba(15, 23, 42, 0.08);
        overflow: hidden;
    }

    .panel-header {
        padding: 0.85rem 1.25rem;
        font-weight: 700;
        color: #fff;
        letter-spacing: .4px;
    }

    .panel-header.gold {
        background: linear-gradient(135deg, #f7b733, #fc4a1a);
    }

    .panel-header.blue {
        background: linear-gradient(135deg, #3a7bd5, #00d2ff);
    }

    .panel-header.green {
        background: linear-gradient(135deg, #11998e, #38ef7d);
    }

    .panel-body {
        padding: 1.5rem;
        background: #fff;
    }

    .score-table th,
    .score-table td {
        vertical-align: middle;
    }

    .score-table tbody tr:hover {
        background-color: #f8f9fa;
    }

    .badge-pill {
        border-radius: 999px;
        padding: .25rem .75rem;
        font-size: .8rem;
    }
</style>

<div class="container py-5">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="card shadow">
                <div class="card-header bg-success text-white text-center py-4">
                    <h2>
                        <i class="bi bi-check-circle"></i>
                        آزمون با موفقیت تکمیل شد
                    </h2>
                </div>
                <div class="card-body p-4">
                    <h4 class="mb-4">@attempt.TestTitle</h4>

                    <div class="d-flex justify-content-end mb-3">
                        <a class="btn btn-outline-secondary" href="@Url.Action("ResultPdf", "Test", new { attemptId = attempt.Id })" target="_blank">
                            دانلود نتیجه تست
                        </a>
                    </div>

                    @if (attempt.TotalScore.HasValue && attempt.MaxScore.HasValue)
                    {
                        <div class="text-center mb-4">
                            <div class="display-4 mb-3">
                                <span class="text-primary">@attempt.TotalScore.Value.ToString("F1")</span>
                                <span class="text-muted">/ @attempt.MaxScore.Value.ToString("F1")</span>
                            </div>
                            @if (attempt.ScorePercentage.HasValue)
                            {
                                <div class="h5 text-muted">
                                    درصد: @attempt.ScorePercentage.Value.ToString("F1")%
                                </div>
                            }
                            @if (attempt.IsPassed.HasValue)
                            {
                                <div class="mt-3">
                                    @if (attempt.IsPassed.Value)
                                    {
                                        <span class="badge bg-success fs-5">
                                            <i class="bi bi-trophy"></i> قبول
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-danger fs-5">
                                            <i class="bi bi-x-circle"></i> عدم قبولی
                                        </span>
                                    }
                                </div>
                            }
                        </div>

                        <div class="progress mb-4" style="height: 30px;">
                            <div class="progress-bar @(attempt.IsPassed == true ? "bg-success" : "bg-primary")"
                                 role="progressbar"
                                 style="width: @(attempt.ScorePercentage ?? 0)%"
                                 aria-valuenow="@(attempt.ScorePercentage ?? 0)"
                                 aria-valuemin="0"
                                 aria-valuemax="100">
                                @(attempt.ScorePercentage?.ToString("F1") ?? "0")%
                            </div>
                        </div>
                    }

                    @if (Model.ErrorResult is not null)
                    {
                        <div class="alert alert-danger mt-4" role="alert">
                            <h5 class="alert-heading">
                                <i class="bi bi-exclamation-triangle"></i> @Model.ErrorResult.Title
                            </h5>
                            <p>@Model.ErrorResult.Description</p>
                            <hr>
                            <p class="mb-0 small">
                                لطفاً با پشتیبانی تماس بگیرید یا اطمینان حاصل کنید که تمام سوالات را پاسخ داده‌اید.
                            </p>
                        </div>
                    }
                    else if (Model.PvqScores.Any() || Model.CliftonScores.Any() || Model.JobGroups.Any())
                    {
                        <div class="mt-4">
                            <h5 class="fw-bold mb-3">تحلیل ترکیبی Clifton + Schwartz</h5>

                            @if (Model.PvqScores.Any() || Model.CliftonScores.Any())
                            {
                                <div class="chart-grid grid-2 mb-4">
                                    @if (Model.PvqScores.Any())
                                    {
                                        <div class="panel">
                                            <div class="panel-header gold">ارزش‌ها (PVQ)</div>
                                            <div class="panel-body">
                                                <canvas id="pvqPie"></canvas>
                                            </div>
                                        </div>
                                    }
                                    @if (Model.CliftonScores.Any())
                                    {
                                        <div class="panel">
                                            <div class="panel-header blue">میانگین استعدادها (Clifton)</div>
                                            <div class="panel-body">
                                                <canvas id="cliftonBar"></canvas>
                                            </div>
                                        </div>
                                    }
                                </div>
                            }

                            @if (Model.JobGroups.Any())
                            {
                                <div class="panel mb-4">
                                    <div class="panel-header green">امتیاز گروه‌های شغلی</div>
                                    <div class="panel-body">
                                        <canvas id="jobsBar"></canvas>
                                    </div>
                                </div>

                                <div class="table-responsive mt-4">
                                    <table class="table table-sm table-hover score-table">
                                        <thead class="table-light">
                                            <tr>
                                                <th>گروه شغلی</th>
                                                <th class="text-end">امتیاز</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var group in Model.JobGroups.OrderByDescending(g => g.Score))
                                            {
                                                <tr>
                                                    <td>@group.Label</td>
                                                    <td class="text-end">@group.Score.ToString("0.000", culture)</td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }

                            @if (Model.CliftonScores.Any())
                            {
                                <div class="mt-5">
                                    <h5 class="fw-bold mb-3">جزئیات استعدادها (Clifton)</h5>
                                    <div class="table-responsive">
                                        <table class="table table-sm table-striped score-table">
                                            <thead>
                                                <tr>
                                                    <th>کد</th>
                                                    <th class="text-end">امتیاز نرمال‌شده</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var item in Model.CliftonScores.OrderByDescending(s => s.Score))
                                                {
                                                    <tr>
                                                        <td>@item.Label</td>
                                                        <td class="text-end">@item.Score.ToString("0.000", culture)</td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            }

                            @if (Model.PvqScores.Any())
                            {
                                <div class="mt-5">
                                    <h5 class="fw-bold mb-3">ارزش‌های Schwartz (PVQ)</h5>
                                    <div class="table-responsive">
                                        <table class="table table-sm table-striped score-table">
                                            <thead>
                                                <tr>
                                                    <th>کد</th>
                                                    <th class="text-end">امتیاز نرمال‌شده</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var item in Model.PvqScores.OrderByDescending(s => s.Score))
                                                {
                                                    <tr>
                                                        <td>@item.Label</td>
                                                        <td class="text-end">@item.Score.ToString("0.000", culture)</td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            }

                            @if (Model.TopPlans.Any())
                            {
                                <div class="mt-5">
                                    <h5 class="fw-bold mb-3">برنامه مهارتی چهار سطحی</h5>
                                    <div class="row g-3">
                                        @foreach (var plan in Model.TopPlans)
                                        {
                                            <div class="col-xl-4 col-lg-6">
                                                <div class="card h-100 border-primary">
                                                    <div class="card-header bg-primary text-white">@plan.JobGroup</div>
                                                    <div class="card-body">
                                                        <div class="mb-3">
                                                            <h6>Self Awareness</h6>
                                                            <p class="mb-0">@string.Join("، ", plan.SG1)</p>
                                                        </div>
                                                        <div class="mb-3">
                                                            <h6>Self Building</h6>
                                                            <p class="mb-0">@string.Join("، ", plan.SG2)</p>
                                                        </div>
                                                        <div class="mb-3">
                                                            <h6>Self Development</h6>
                                                            <p class="mb-0">@string.Join("، ", plan.SG3)</p>
                                                        </div>
                                                        <div>
                                                            <h6>Self Actualization</h6>
                                                            <p class="mb-0">@string.Join("، ", plan.SG4)</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                        </div>

                        <div class="alert alert-info mt-4" role="alert">
                            <i class="bi bi-info-circle"></i>
                            مقادیر نمایش داده‌شده بر اساس نرمال‌سازی داده‌ها هستند و برای مقایسه نسبی بین شاخص‌ها به کار می‌روند.
                        </div>
                    }
                    else if (attempt.Results.Any())
                    {
                        <div class="mt-4">
                            <h5 class="mb-3">تحلیل نتایج</h5>
                            @foreach (var result in attempt.Results.OrderBy(r => r.Rank ?? int.MaxValue))
                            {
                                <div class="card mb-3">
                                    <div class="card-body">
                                        <h6 class="card-title">
                                            @result.Title
                                            @if (result.Rank.HasValue)
                                            {
                                                <span class="badge bg-primary">رتبه @result.Rank</span>
                                            }
                                        </h6>
                                        <p class="card-text">@result.Description</p>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="text-muted">امتیاز: @result.Score.ToString("F1")</span>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else if (attempt.TestType == TestType.CliftonSchwartz)
                    {
                        if (Model.ErrorResult is not null)
                        {
                            <div class="alert alert-danger mt-4" role="alert">
                                <h5 class="alert-heading">
                                    <i class="bi bi-exclamation-triangle"></i> @Model.ErrorResult.Title
                                </h5>
                                <p>@Model.ErrorResult.Description</p>
                                <hr>
                                <p class="mb-0 small">
                                    لطفاً با پشتیبانی تماس بگیرید یا اطمینان حاصل کنید که تمام سوالات را پاسخ داده‌اید.
                                </p>
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-warning mt-4" role="alert">
                                متأسفانه امکان نمایش جزئیات تحلیل این آزمون فراهم نشد. لطفاً با پشتیبانی تماس بگیرید.
                            </div>
                        }
                    }

                    <div class="row mt-4">
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <i class="bi bi-clock h1 text-primary"></i>
                                    <h6 class="mt-2">زمان شروع</h6>
                                    <p class="mb-0">@attempt.StartedAt.ToString("yyyy/MM/dd HH:mm")</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <i class="bi bi-check-circle h1 text-success"></i>
                                    <h6 class="mt-2">زمان اتمام</h6>
                                    <p class="mb-0">@(attempt.CompletedAt?.ToString("yyyy/MM/dd HH:mm") ?? "-")</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4 text-center">
                        <a asp-action="MyTests" class="btn btn-primary btn-lg">
                            <i class="bi bi-clipboard-check"></i> مشاهده همه آزمون‌های من
                        </a>
                        <a asp-action="Index" class="btn btn-outline-secondary btn-lg">
                            <i class="bi bi-arrow-right"></i> بازگشت به لیست آزمون‌ها
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @if (Model.PvqScores.Any() || Model.CliftonScores.Any() || Model.JobGroups.Any())
    {
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
            const pvqData = @Html.Raw(JsonSerializer.Serialize(
                Model.PvqScores
                    .OrderByDescending(x => x.Score)
                    .Select(x => new { label = x.Label, code = x.Code, score = Math.Round(x.Score, 3) })
            ));

            const cliftonData = @Html.Raw(JsonSerializer.Serialize(
                Model.CliftonScores
                    .OrderByDescending(x => x.Score)
                    .Select(x => new { label = x.Label, code = x.Code, score = Math.Round(x.Score, 3) })
            ));

            const jobsData = @Html.Raw(JsonSerializer.Serialize(
                Model.JobGroups
                    .OrderByDescending(x => x.Score)
                    .Select(x => new { label = x.Label, code = x.Code, score = x.Score })
            ));

            function genColors(n) {
                const arr = [];
                for (let i = 0; i < n; i++) {
                    const h = Math.floor((360 / (n || 1)) * i);
                    arr.push(`hsl(${h} 70% 55%)`);
                }
                return arr;
            }

            if (pvqData.length) {
                new Chart(document.getElementById('pvqPie'), {
                    type: 'pie',
                    data: {
                        labels: pvqData.map(x => x.label),
                        datasets: [{
                            data: pvqData.map(x => x.score),
                            backgroundColor: genColors(pvqData.length)
                        }]
                    },
                    options: {
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: { font: { family: 'IRANSans, system-ui' } }
                            },
                            tooltip: { rtl: true }
                        }
                    }
                });
            }

            if (cliftonData.length) {
                new Chart(document.getElementById('cliftonBar'), {
                    type: 'bar',
                    data: {
                        labels: cliftonData.map(x => x.label),
                        datasets: [{
                            label: 'Score',
                            data: cliftonData.map(x => x.score),
                            backgroundColor: genColors(cliftonData.length)
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: { beginAtZero: true, suggestedMax: 1 }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: { rtl: true }
                        }
                    }
                });
            }

            if (jobsData.length) {
                new Chart(document.getElementById('jobsBar'), {
                    type: 'bar',
                    data: {
                        labels: jobsData.map(x => x.label),
                        datasets: [{
                            label: 'امتیاز',
                            data: jobsData.map(x => Math.round((x.score + Number.EPSILON) * 1000) / 1000),
                            backgroundColor: genColors(jobsData.length)
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        scales: {
                            x: { beginAtZero: true }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: { rtl: true }
                        }
                    }
                });
            }
        </script>
    }
}
