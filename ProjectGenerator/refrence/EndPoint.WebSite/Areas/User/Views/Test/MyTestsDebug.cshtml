@using EndPoint.WebSite.Models.Test
@using Arsis.Domain.Enums
@model MyTestsViewModel

@{
    ViewData["Title"] = "Debug: ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ù†";
}

<div class="container py-4">
    <h1 class="mb-4">ğŸ” Debug: ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ù†</h1>

    <div class="alert alert-warning">
        <strong>âš ï¸ Ø§ÛŒÙ† ØµÙØ­Ù‡ ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ debug Ø§Ø³Øª</strong>
        <p class="mb-0">Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ú†Ø±Ø§ Ù‡Ù…Ù‡ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù†Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.</p>
    </div>

    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h3 class="mb-0">ğŸ“Š Ø®Ù„Ø§ØµÙ‡</h3>
        </div>
        <div class="card-body">
            <ul class="list-unstyled mb-0">
                <li><strong>ØªØ¹Ø¯Ø§Ø¯ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø®Ø±ÛŒØ¯Ø§Ø±ÛŒ Ø´Ø¯Ù‡:</strong> @Model.PurchasedTests.Count</li>
                <li><strong>ØªØ¹Ø¯Ø§Ø¯ attempt Ù‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±:</strong> @Model.Attempts.Count</li>
                <li><strong>ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„:</strong> @(Model.PurchasedTests.Count + Model.Attempts.Count)</li>
            </ul>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header bg-success text-white">
            <h3 class="mb-0">âœ… ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø®Ø±ÛŒØ¯Ø§Ø±ÛŒ Ø´Ø¯Ù‡ (@Model.PurchasedTests.Count)</h3>
        </div>
        <div class="card-body">
            @if (Model.PurchasedTests.Any())
            {
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Ø¹Ù†ÙˆØ§Ù† ØªØ³Øª</th>
                                <th>Ù†ÙˆØ¹</th>
                                <th>Ø´Ù…Ø§Ø±Ù‡ ÙØ§Ú©ØªÙˆØ±</th>
                                <th>InvoiceId</th>
                                <th>TestId</th>
                                <th>ØªØ§Ø±ÛŒØ® Ø®Ø±ÛŒØ¯</th>
                                <th>ÙˆØ¶Ø¹ÛŒØª Attempt</th>
                                <th>AttemptId</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var (test, index) in Model.PurchasedTests.Select((t, i) => (t, i + 1)))
                            {
                                <tr>
                                    <td>@index</td>
                                    <td>@test.TestTitle</td>
                                    <td>@test.TestType</td>
                                    <td>@test.InvoiceNumber</td>
                                    <td><code>@test.InvoiceId.ToString().Substring(0, 8)...</code></td>
                                    <td><code>@test.TestId.ToString().Substring(0, 8)...</code></td>
                                    <td>@test.PurchaseDate.ToString("yyyy/MM/dd HH:mm")</td>
                                    <td>
                                        @if (test.Attempt != null)
                                        {
                                            <span class="badge bg-@(test.Attempt.Status == TestAttemptStatus.Completed ? "success" : test.Attempt.Status == TestAttemptStatus.InProgress ? "warning" : "secondary")">
                                                @test.Attempt.Status
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-light text-dark">Ø¨Ø¯ÙˆÙ† Attempt</span>
                                        }
                                    </td>
                                    <td>
                                        @if (test.Attempt != null)
                                        {
                                            <code>@test.Attempt.Id.ToString().Substring(0, 8)...</code>
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <p class="text-muted mb-0">Ù‡ÛŒÚ† ØªØ³Øª Ø®Ø±ÛŒØ¯Ø§Ø±ÛŒ Ø´Ø¯Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</p>
            }
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header bg-info text-white">
            <h3 class="mb-0">ğŸ“ Attempt Ù‡Ø§ÛŒ Ø¨Ø¯ÙˆÙ† ÙØ§Ú©ØªÙˆØ± (@Model.Attempts.Count)</h3>
        </div>
        <div class="card-body">
            @if (Model.Attempts.Any())
            {
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Ø¹Ù†ÙˆØ§Ù† ØªØ³Øª</th>
                                <th>Ù†ÙˆØ¹</th>
                                <th>AttemptId</th>
                                <th>TestId</th>
                                <th>InvoiceId</th>
                                <th>ÙˆØ¶Ø¹ÛŒØª</th>
                                <th>ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var (attempt, index) in Model.Attempts.Select((a, i) => (a, i + 1)))
                            {
                                <tr>
                                    <td>@index</td>
                                    <td>@attempt.TestTitle</td>
                                    <td>@attempt.TestType</td>
                                    <td><code>@attempt.Id.ToString().Substring(0, 8)...</code></td>
                                    <td><code>@attempt.TestId.ToString().Substring(0, 8)...</code></td>
                                    <td>
                                        @if (attempt.InvoiceId.HasValue)
                                        {
                                            <code>@attempt.InvoiceId.Value.ToString().Substring(0, 8)...</code>
                                        }
                                        else
                                        {
                                            <span class="text-muted">Ø¨Ø¯ÙˆÙ† ÙØ§Ú©ØªÙˆØ±</span>
                                        }
                                    </td>
                                    <td>
                                        <span class="badge bg-@(attempt.Status == TestAttemptStatus.Completed ? "success" : attempt.Status == TestAttemptStatus.InProgress ? "warning" : "secondary")">
                                            @attempt.Status
                                        </span>
                                    </td>
                                    <td>@attempt.StartedAt.ToString("yyyy/MM/dd HH:mm")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <p class="text-muted mb-0">Ù‡ÛŒÚ† attempt Ø¨Ø¯ÙˆÙ† ÙØ§Ú©ØªÙˆØ±ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</p>
            }
        </div>
    </div>

    <div class="text-center mt-4">
        <a asp-action="MyTests" class="btn btn-primary">
            <i class="bi bi-arrow-right"></i> Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ ØµÙØ­Ù‡ Ø¹Ø§Ø¯ÛŒ
        </a>
    </div>
</div>
