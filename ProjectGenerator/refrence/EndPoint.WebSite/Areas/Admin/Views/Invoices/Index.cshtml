@using System.Globalization
@using System.Linq
@using Arsis.Domain.Enums
@using Arsis.SharedKernel.Extensions
@model InvoiceIndexViewModel
@{
    ViewData["Title"] ??= "فاکتورها";
    ViewData["Subtitle"] ??= "مدیریت فاکتورهای مالی و وضعیت تراکنش‌ها";

    var summary = Model.Summary ?? new InvoiceSummaryViewModel();
    var invoices = Model.Invoices?.ToList() ?? new List<InvoiceListItemViewModel>();
    var hasInvoices = invoices.Count > 0;
    var filter = Model.Filter ?? new InvoiceFilterViewModel();
    var hasActiveFilters = !string.IsNullOrWhiteSpace(filter.SearchTerm)
        || filter.Status.HasValue
        || !string.IsNullOrWhiteSpace(filter.UserId)
        || !string.IsNullOrWhiteSpace(filter.IssueDateFromDisplay)
        || !string.IsNullOrWhiteSpace(filter.IssueDateToDisplay);
    var culture = new CultureInfo("fa-IR");

    string FormatMoney(decimal value) => string.Format(culture, "{0:N0} تومان", value);

    string FormatDate(DateTimeOffset value) => value.ToPersianDateString();

    string? FormatNullableDate(DateTimeOffset? value) => value is null ? null : FormatDate(value.Value);

    string StatusBadge(InvoiceStatus status) => status switch
    {
        InvoiceStatus.Paid => "badge bg-success-subtle text-success-emphasis",
        InvoiceStatus.PartiallyPaid => "badge bg-warning-subtle text-warning-emphasis",
        InvoiceStatus.Overdue => "badge bg-danger-subtle text-danger-emphasis",
        InvoiceStatus.Cancelled => "badge bg-secondary-subtle text-secondary-emphasis",
        InvoiceStatus.Draft => "badge bg-info-subtle text-info-emphasis",
        _ => "badge bg-primary-subtle text-primary-emphasis"
    };

    string StatusText(InvoiceStatus status) => status switch
    {
        InvoiceStatus.Paid => "تسویه شده",
        InvoiceStatus.PartiallyPaid => "تسویه جزئی",
        InvoiceStatus.Overdue => "سررسید گذشته",
        InvoiceStatus.Cancelled => "لغو شده",
        InvoiceStatus.Draft => "پیش‌نویس",
        _ => "در انتظار پرداخت"
    };
}

@section Breadcrumb {
    <li class="breadcrumb-item"><a asp-area="Admin" asp-controller="Dashboard" asp-action="Index">داشبورد</a></li>
    <li class="breadcrumb-item active" aria-current="page">@ViewData["Title"]</li>
}

@section Head {
    <link rel="stylesheet" href="~/Plugins/JalaliDatePicker/css/jalalidatepicker.min.css" />
    <link rel="stylesheet" href="~/css/admin/invoices.css" asp-append-version="true" />
}

@await Html.PartialAsync("_StatusMessage")

<div class="invoice-page" data-invoice-index>
    <div class="invoice-page__header">
        <div>
            <h1 class="invoice-page__title">@ViewData["Title"]</h1>
            <p class="invoice-page__subtitle">@ViewData["Subtitle"]</p>
        </div>
        <div class="invoice-page__actions">
            <button type="button"
                    class="btn btn-outline-secondary"
                    data-bs-toggle="modal"
                    data-bs-target="#invoice-filter-modal">
                <i class="bi bi-funnel"></i>
                فیلترها
            </button>
            <a asp-area="Admin" asp-controller="Invoices" asp-action="Create" class="btn btn-primary">
                <i class="bi bi-plus-lg"></i>
                فاکتور جدید
            </a>
        </div>
    </div>

    <div class="invoice-filter-container" data-invoice-filter>
        @if (hasActiveFilters)
        {
            <div class="invoice-filter-summary">
                <span class="invoice-filter-summary__label">
                    <i class="bi bi-funnel"></i>
                    فیلترهای فعال:
                </span>
                <div class="invoice-filter-summary__chips">
                    @if (!string.IsNullOrWhiteSpace(filter.SearchTerm))
                    {
                        <span class="badge rounded-pill text-bg-light">جستجو: @filter.SearchTerm</span>
                    }
                    @if (filter.Status.HasValue)
                    {
                        <span class="badge rounded-pill text-bg-light">وضعیت: @StatusText(filter.Status.Value)</span>
                    }
                    @if (!string.IsNullOrWhiteSpace(filter.UserId))
                    {
                        var userLabel = !string.IsNullOrWhiteSpace(filter.UserDisplayName)
                            ? filter.UserDisplayName
                            : "کاربر انتخاب شده";
                        <span class="badge rounded-pill text-bg-light">کاربر: @userLabel</span>
                    }
                    @if (!string.IsNullOrWhiteSpace(filter.IssueDateFromDisplay ?? filter.IssueDateFrom))
                    {
                        var fromDisplay = filter.IssueDateFromDisplay ?? filter.IssueDateFrom?.Replace("-", "/");
                        <span class="badge rounded-pill text-bg-light">از تاریخ: @fromDisplay</span>
                    }
                    @if (!string.IsNullOrWhiteSpace(filter.IssueDateToDisplay ?? filter.IssueDateTo))
                    {
                        var toDisplay = filter.IssueDateToDisplay ?? filter.IssueDateTo?.Replace("-", "/");
                        <span class="badge rounded-pill text-bg-light">تا تاریخ: @toDisplay</span>
                    }
                </div>
                <a class="invoice-filter-summary__reset btn btn-sm btn-link text-danger"
                   href="@Url.Action("Index", "Invoices", new { area = "Admin" })">
                    حذف فیلترها
                </a>
    </div>
}

@section Scripts {
    <script src="~/Plugins/JalaliDatePicker/js/jalalidatepicker.min.js"></script>
    <script src="~/js/admin/invoices.js" asp-append-version="true"></script>
}

        <div class="modal fade" id="invoiceConfirmModal" tabindex="-1" aria-hidden="true" data-invoice-confirm-modal>
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">تایید عملیات</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="بستن"></button>
                    </div>
                    <div class="modal-body">
                        <p class="mb-0" data-invoice-confirm-message>آیا از انجام این عملیات اطمینان دارید؟</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">انصراف</button>
                        <button type="button" class="btn btn-danger" data-invoice-confirm-approve>تایید</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="invoice-filter-modal" tabindex="-1" aria-labelledby="invoice-filter-modal-label" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="invoice-filter-modal-label">فیلتر فاکتورها</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="بستن"></button>
                    </div>
                    <form method="get" asp-area="Admin" asp-controller="Invoices" asp-action="Index">
                        <div class="modal-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label" for="InvoiceFilter_SearchTerm">جستجو</label>
                                    <input type="text"
                                           class="form-control"
                                           id="InvoiceFilter_SearchTerm"
                                           name="SearchTerm"
                                           value="@filter.SearchTerm"
                                           placeholder="شماره، عنوان یا ارجاع" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label" for="InvoiceFilter_Status">وضعیت فاکتور</label>
                                    <select class="form-select"
                                            id="InvoiceFilter_Status"
                                            name="Status"
                                            data-control="select2"
                                            data-placeholder="همه وضعیت‌ها"
                                            data-allow-clear="true"
                                            data-dropdown-parent="#invoice-filter-modal">
                                        <option value="">همه وضعیت‌ها</option>
                                        @foreach (InvoiceStatus status in Enum.GetValues(typeof(InvoiceStatus)))
                                        {
                                            var selected = filter.Status.HasValue && filter.Status.Value == status;
                                            <option value="@status" selected="@(selected ? "selected" : null)">@status.GetDisplayName()</option>
                                        }
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label" for="InvoiceFilter_UserId">کاربر سیستم</label>
                                    <select class="form-select"
                                            id="InvoiceFilter_UserId"
                                            name="UserId"
                                            data-control="select2"
                                            data-placeholder="همه کاربران"
                                            data-allow-clear="true"
                                            data-dropdown-parent="#invoice-filter-modal"
                                            data-invoice-user-select>
                                        <option value="">همه کاربران</option>
                                        @foreach (var option in Model.UserOptions ?? Enumerable.Empty<SelectListItem>())
                                        {
                                            <option value="@option.Value" selected="@(option.Selected ? "selected" : null)">@option.Text</option>
                                        }
                                    </select>
                                </div>
                                <div class="col-md-6" data-invoice-date>
                                    <label class="form-label" for="InvoiceFilter_IssueDateFromDisplay">تاریخ صدور از</label>
                                    <div class="jalali-picker" data-jalali-picker>
                                        <div class="jalali-picker__controls">
                                            <button type="button" class="btn btn-light" data-jalali-open>
                                                <i class="bi bi-calendar-event"></i>
                                                <span class="visually-hidden">انتخاب تاریخ</span>
                                            </button>
                                            <input type="text"
                                                   class="form-control"
                                                   id="InvoiceFilter_IssueDateFromDisplay"
                                                   placeholder="انتخاب تاریخ"
                                                   value="@(filter.IssueDateFromDisplay ?? filter.IssueDateFrom?.Replace("-", "/") ?? string.Empty)"
                                                   data-jalali-input
                                                   data-jdp
                                                   data-jdp-only-date
                                                   data-jdp-init-date="@(filter.IssueDateFromDisplay ?? filter.IssueDateFrom?.Replace("-", "/") ?? string.Empty)"
                                                   autocomplete="off"
                                                   dir="ltr" />
                                            <button type="button" class="btn btn-outline-secondary" data-jalali-clear>حذف</button>
                                        </div>
                                        <input type="hidden"
                                               id="InvoiceFilter_IssueDateFrom"
                                               name="IssueDateFrom"
                                               value="@filter.IssueDateFrom"
                                               data-jalali-target />
                                    </div>
                                </div>
                                <div class="col-md-6" data-invoice-date data-optional="true">
                                    <label class="form-label" for="InvoiceFilter_IssueDateToDisplay">تاریخ صدور تا</label>
                                    <div class="jalali-picker" data-jalali-picker>
                                        <div class="jalali-picker__controls">
                                            <button type="button" class="btn btn-light" data-jalali-open>
                                                <i class="bi bi-calendar-event"></i>
                                                <span class="visually-hidden">انتخاب تاریخ</span>
                                            </button>
                                            <input type="text"
                                                   class="form-control"
                                                   id="InvoiceFilter_IssueDateToDisplay"
                                                   placeholder="انتخاب تاریخ"
                                                   value="@(filter.IssueDateToDisplay ?? filter.IssueDateTo?.Replace("-", "/") ?? string.Empty)"
                                                   data-jalali-input
                                                   data-jdp
                                                   data-jdp-only-date
                                                   data-jdp-init-date="@(filter.IssueDateToDisplay ?? filter.IssueDateTo?.Replace("-", "/") ?? string.Empty)"
                                                   autocomplete="off"
                                                   dir="ltr" />
                                            <button type="button" class="btn btn-outline-secondary" data-jalali-clear>حذف</button>
                                        </div>
                                        <input type="hidden"
                                               id="InvoiceFilter_IssueDateTo"
                                               name="IssueDateTo"
                                               value="@filter.IssueDateTo"
                                               data-jalali-target />
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-funnel-fill"></i>
                                اعمال فیلترها
                            </button>
                            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">انصراف</button>
                            <button type="button"
                                    class="btn btn-link text-danger ms-auto"
                                    data-invoice-filter-reset
                                    data-reset-url="@Url.Action("Index", "Invoices", new { area = "Admin" })">
                                حذف فیلترها
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="invoice-metrics">
        <article class="invoice-metric-card">
            <h2 class="invoice-metric-card__value">@summary.TotalInvoices</h2>
            <p class="invoice-metric-card__label">کل فاکتورها</p>
            <div class="invoice-metric-card__details">
                <span class="badge bg-primary-subtle text-primary-emphasis">در انتظار: @summary.PendingInvoices</span>
                <span class="badge bg-info-subtle text-info-emphasis">پیش‌نویس: @summary.DraftInvoices</span>
            </div>
        </article>
        <article class="invoice-metric-card">
            <h2 class="invoice-metric-card__value">@FormatMoney(summary.TotalBilledAmount)</h2>
            <p class="invoice-metric-card__label">مجموع صورتحساب</p>
            <div class="invoice-metric-card__details">
                <span class="badge bg-success-subtle text-success-emphasis">تسویه شده: @FormatMoney(summary.TotalCollectedAmount)</span>
                <span class="badge bg-warning-subtle text-warning-emphasis">مانده: @FormatMoney(summary.TotalOutstandingAmount)</span>
            </div>
        </article>
        <article class="invoice-metric-card">
            <h2 class="invoice-metric-card__value">@summary.PaidInvoices</h2>
            <p class="invoice-metric-card__label">فاکتورهای تسویه شده</p>
            <div class="invoice-metric-card__details">
                <span class="badge bg-warning-subtle text-warning-emphasis">جزئی: @summary.PartiallyPaidInvoices</span>
                <span class="badge bg-danger-subtle text-danger-emphasis">سررسید گذشته: @summary.OverdueInvoices</span>
            </div>
        </article>
        <article class="invoice-metric-card">
            <h2 class="invoice-metric-card__value">@summary.CancelledInvoices</h2>
            <p class="invoice-metric-card__label">فاکتورهای لغو شده</p>
            <div class="invoice-metric-card__details">
                <span class="badge bg-secondary-subtle text-secondary-emphasis">آخرین بروزرسانی: @Model.GeneratedAt.ToPersianDateTimeString()</span>
            </div>
        </article>
    </div>

    @if (!hasInvoices)
    {
        <div class="invoice-empty">
            <div class="invoice-empty__icon"><i class="bi bi-receipt"></i></div>
            <h3 class="invoice-empty__title">هیچ فاکتوری ثبت نشده است</h3>
            <p class="invoice-empty__text">برای پیگیری پرداخت‌ها و تراکنش‌ها، اولین فاکتور خود را ایجاد کنید.</p>
            <a asp-area="Admin" asp-controller="Invoices" asp-action="Create" class="btn btn-primary">
                <i class="bi bi-plus-lg"></i>
                ایجاد فاکتور
            </a>
        </div>
    }
    else
    {
        <div class="table-responsive mt-4">
            <table class="table table-hover align-middle">
                <thead>
                    <tr>
                        <th>شماره فاکتور</th>
                        <th>عنوان</th>
                        <th>وضعیت</th>
                        <th>مبالغ</th>
                        <th>تاریخ‌ها</th>
                        <th>کاربر</th>
                        <th class="text-end">عملیات</th>
                    </tr>
                </thead>
                <tbody>
                @foreach (var invoice in invoices)
                {
                    <tr class="@(invoice.IsOverdue ? "table-danger" : string.Empty)">
                        <td>
                            <div class="fw-semibold">@invoice.InvoiceNumber</div>
                            @if (!string.IsNullOrWhiteSpace(invoice.ExternalReference))
                            {
                                <small class="text-muted">ارجاع: @invoice.ExternalReference</small>
                            }
                        </td>
                        <td>
                            <div class="fw-semibold">@invoice.Title</div>
                            <small class="text-muted">@FormatMoney(invoice.GrandTotal)</small>
                        </td>
                        <td>
                            <span class="@StatusBadge(invoice.Status)">@StatusText(invoice.Status)</span>
                        </td>
                        <td>
                            <div class="d-flex flex-column gap-1">
                                <span class="text-success">دریافتی: @FormatMoney(invoice.PaidAmount)</span>
                                <span class="text-warning">مانده: @FormatMoney(invoice.OutstandingAmount)</span>
                            </div>
                        </td>
                        <td>
                            <div class="d-flex flex-column gap-1">
                                <span>صدور: @FormatDate(invoice.IssueDate)</span>
                                <span>سررسید: @(FormatNullableDate(invoice.DueDate) ?? "-" )</span>
                            </div>
                        </td>
                        <td>
                            @if (!string.IsNullOrWhiteSpace(invoice.UserDisplayName))
                            {
                                <span class="badge bg-light text-dark">@invoice.UserDisplayName</span>
                            }
                            else if (!string.IsNullOrWhiteSpace(invoice.UserId))
                            {
                                <span class="text-muted">کاربر نامشخص</span>
                            }
                            else
                            {
                                <span class="text-muted">مهمان</span>
                            }
                        </td>
                        <td class="text-end">
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="bi bi-three-dots-vertical"></i>
                                    عملیات
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li>
                                        <a class="dropdown-item" asp-area="Admin" asp-controller="Invoices" asp-action="Details" asp-route-id="@invoice.Id">
                                            <i class="bi bi-eye text-secondary"></i>
                                            مشاهده جزئیات
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" asp-area="Admin" asp-controller="Invoices" asp-action="Edit" asp-route-id="@invoice.Id">
                                            <i class="bi bi-pencil text-primary"></i>
                                            ویرایش فاکتور
                                        </a>
                                    </li>
                                    <li><hr class="dropdown-divider"></li>
                                    @if (invoice.Status == InvoiceStatus.Cancelled)
                                    {
                                        <li>
                                            <form method="post" asp-area="Admin" asp-controller="Invoices" asp-action="Reopen" asp-route-id="@invoice.Id" class="d-inline w-100">
                                                <button type="submit" class="dropdown-item" data-invoice-confirm="آیا از فعال‌سازی مجدد فاکتور اطمینان دارید؟" data-invoice-confirm-style="success">
                                                    <i class="bi bi-arrow-counterclockwise text-success"></i>
                                                    فعال‌سازی مجدد
                                                </button>
                                            </form>
                                        </li>
                                    }
                                    else
                                    {
                                        <li>
                                            <form method="post" asp-area="Admin" asp-controller="Invoices" asp-action="Cancel" asp-route-id="@invoice.Id" class="d-inline w-100">
                                                <button type="submit" class="dropdown-item" data-invoice-confirm="آیا از لغو این فاکتور اطمینان دارید؟" data-invoice-confirm-style="danger">
                                                    <i class="bi bi-x-circle text-danger"></i>
                                                    لغو فاکتور
                                                </button>
                                            </form>
                                        </li>
                                    }
                                </ul>
                            </div>
                        </td>
                    </tr>
                }
                </tbody>
            </table>
        </div>
    }
</div>
