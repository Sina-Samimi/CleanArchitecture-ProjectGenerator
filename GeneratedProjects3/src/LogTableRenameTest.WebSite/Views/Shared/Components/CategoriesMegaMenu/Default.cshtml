@model IReadOnlyCollection<LogTableRenameTest.Application.DTOs.Catalog.SiteCategoryDto>
@using System.Linq

@{
    var mainCategories = Model?.Where(c => c.ParentId == null).OrderBy(c => c.Name).ToList() ?? new List<LogTableRenameTest.Application.DTOs.Catalog.SiteCategoryDto>();
}

@if (mainCategories.Any())
{
    <div class="categories-mega-menu" id="categoriesMegaMenu">
        <button class="categories-mega-menu__trigger btn btn-outline-light d-flex align-items-center gap-2" type="button" id="categoriesMenuTrigger" aria-expanded="false" aria-controls="categoriesMenuPanel">
            <i class="bi bi-list fs-5"></i>
            <span>دسته‌بندی کالاها</span>
        </button>
        
        <div class="categories-mega-menu__panel" id="categoriesMenuPanel" aria-labelledby="categoriesMenuTrigger">
            <div class="categories-mega-menu__container">
                <!-- Right Panel: Main Categories -->
                <div class="categories-mega-menu__sidebar">
                    <ul class="categories-mega-menu__list" role="list">
                        @foreach (var category in mainCategories)
                        {
                            var hasChildren = category.Children?.Any() ?? false;
                            <li class="categories-mega-menu__item @(hasChildren ? "has-children" : "")" 
                                data-category-id="@category.Id"
                                data-category-slug="@category.Slug">
                                <a href="@Url.Action("Index", "Product", new { category = category.Slug })" 
                                   class="categories-mega-menu__link @(hasChildren ? "categories-mega-menu__link--parent" : "")">
                                    @if (!string.IsNullOrWhiteSpace(category.Name))
                                    {
                                        @if (!string.IsNullOrWhiteSpace(category.ImageUrl))
                                        {
                                            <span class="categories-mega-menu__icon categories-mega-menu__icon--image">
                                                <img src="@category.ImageUrl" alt="@category.Name" />
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="categories-mega-menu__icon">
                                                <i class="bi bi-folder"></i>
                                            </span>
                                        }
                                        <span class="categories-mega-menu__text">@category.Name</span>
                                    }
                                </a>
                            </li>
                        }
                    </ul>
                </div>

                <!-- Left Panel: Subcategories and Content -->
                <div class="categories-mega-menu__content">
                    @foreach (var category in mainCategories.Where(c => c.Children?.Any() ?? false))
                    {
                        <div class="categories-mega-menu__content-panel" 
                             data-category-panel="@category.Id" 
                             style="display: none;">
                            
                            <!-- Header: View All Products Link -->
                            <div class="categories-mega-menu__header">
                                <a href="@Url.Action("Index", "Product", new { category = category.Slug })" class="categories-mega-menu__view-all">
                                    <span>همه محصولات @category.Name</span>
                                    <i class="bi bi-arrow-left"></i>
                                </a>
                            </div>

                            <!-- Subcategories Grid -->
                            <div class="categories-mega-menu__grid">
                                @if (category.Children?.Any() ?? false)
                                {
                                    var subcategories = category.Children.OrderBy(c => c.Name).ToList();
                                    
                                    @foreach (var subcategory in subcategories)
                                    {
                                        <div class="categories-mega-menu__column">
                                            <div class="categories-mega-menu__section">
                                                <h4 class="categories-mega-menu__section-title">
                                                    <span class="categories-mega-menu__section-indicator"></span>
                                                    <a href="@Url.Action("Index", "Product", new { category = subcategory.Slug })">@subcategory.Name</a>
                                                </h4>
                                                @if (subcategory.Children?.Any() ?? false)
                                                {
                                                    <ul class="categories-mega-menu__section-list">
                                                        @foreach (var child in subcategory.Children.OrderBy(c => c.Name).Take(12))
                                                        {
                                                            <li>
                                                                <a href="@Url.Action("Index", "Product", new { category = child.Slug })">@child.Name</a>
                                                            </li>
                                                        }
                                                    </ul>
                                                }
                                            </div>
                                        </div>
                                    }
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
}
