@model BlogFormViewModel
@using LogTableRenameTest.Domain.Enums
@using LogTableRenameTest.SharedKernel.Extensions
@using System.Globalization
@{ 
    var isEdit = Model.Id.HasValue;
    var categoryOptions = Model.Selections?.CategoryOptions?.ToList() ?? new List<SelectListItem>();
    var authorOptions = Model.Selections?.AuthorOptions?.ToList() ?? new List<SelectListItem>();
    var statusOptions = Model.Selections?.StatusOptions?.ToList() ?? new List<SelectListItem>();
    var formAction = isEdit ? "Edit" : "Create";
    var publishedLocal = Model.PublishedAt?.ToLocalTime();
    var calendar = new PersianCalendar();
    var publishedPersian = string.IsNullOrWhiteSpace(Model.PublishedAtPersian) && publishedLocal is not null
        ? string.Format(
            CultureInfo.InvariantCulture,
            "{0:0000}-{1:00}-{2:00}",
            calendar.GetYear(publishedLocal.Value.DateTime),
            calendar.GetMonth(publishedLocal.Value.DateTime),
            calendar.GetDayOfMonth(publishedLocal.Value.DateTime))
        : (Model.PublishedAtPersian ?? string.Empty);
    var publishedJalaliInit = string.IsNullOrWhiteSpace(publishedPersian)
        ? string.Empty
        : publishedPersian.Replace('-', '/');
    var publishedDisplay = publishedLocal.HasValue
        ? publishedLocal.Value.DateTime.ToPersianDateString()
        : string.Empty;
    var publishedTimeValue = string.IsNullOrWhiteSpace(Model.PublishedAtTime)
        ? (publishedLocal?.ToString("HH:mm", CultureInfo.InvariantCulture) ?? string.Empty)
        : Model.PublishedAtTime;
    var publishedIsoValue = publishedLocal?.ToString("yyyy-MM-ddTHH:mm", CultureInfo.InvariantCulture) ?? string.Empty;
}

@section Head {
    <link rel="stylesheet" href="~/css/admin/blog-form.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/plugins/jalalidatepicker/css/jalalidatepicker.min.css" />
}

@await Html.PartialAsync("_StatusMessage")

<form asp-action="@formAction" asp-route-id="@(isEdit ? Model.Id : null)" method="post" enctype="multipart/form-data" class="card" data-blog-form>
    @Html.AntiForgeryToken()
    <div class="card-body">
        <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>
        <div class="row g-4">
            <div class="col-lg-8">
                <div class="mb-3">
                    <label asp-for="Title" class="form-label"></label>
                    <input asp-for="Title" class="form-control" placeholder="عنوان بلاگ" />
                    <span asp-validation-for="Title" class="text-danger"></span>
                </div>
                <div class="mb-3">
                    <label asp-for="Summary" class="form-label"></label>
                    <textarea asp-for="Summary" class="form-control" rows="3" placeholder="چکیده‌ای کوتاه برای نمایش در لیست‌ها"></textarea>
                    <span asp-validation-for="Summary" class="text-danger"></span>
                </div>
                <div class="mb-3" data-editor-field>
                    <label class="form-label">محتوای بلاگ</label>
                    <div id="blogEditor"
                         class="blog-editor"
                         data-editor-wrapper
                         data-upload-url="@Url.Action("UploadContentImage")"></div>
                    <textarea asp-for="Content"
                              class="form-control d-none"
                              rows="8"
                              placeholder="محتوای بلاگ را اینجا وارد کنید..."
                              data-content-input
                              data-editor-textarea></textarea>
                    <div class="form-text d-none text-warning" data-editor-fallback>
                        در صورت بروز مشکل در بارگذاری ویرایشگر پیشرفته، متن را در این بخش وارد کنید.
                    </div>
                    <span asp-validation-for="Content" class="text-danger"></span>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="mb-4">
                    <label class="form-label">عکس شاخص</label>
                    <div class="featured-upload" data-featured-uploader>
                        <div class="featured-upload__preview @(string.IsNullOrWhiteSpace(Model.FeaturedImagePath) ? "featured-upload__preview--empty" : string.Empty)"
                             data-featured-preview
                             style="@(string.IsNullOrWhiteSpace(Model.FeaturedImagePath) ? string.Empty : $"background-image: url('{Url.Content(Model.FeaturedImagePath)}')")">
                            <span class="featured-upload__placeholder" data-featured-placeholder>
                                <i class="bi bi-image"></i>
                                <span>تصویر شاخص را انتخاب کنید</span>
                            </span>
                        </div>
                        <div class="featured-upload__controls">
                            <label class="btn btn-outline-secondary featured-upload__button">
                                <i class="bi bi-upload"></i>
                                انتخاب تصویر
                                <input asp-for="FeaturedImage" class="d-none" accept="image/*" data-featured-input />
                            </label>
                            <div class="featured-upload__meta">
                                <span data-featured-filename>
                                    @(string.IsNullOrWhiteSpace(Model.FeaturedImagePath) ? "تصویر انتخاب نشده است" : "تصویر فعلی انتخاب شده")
                                </span>
                                <div class="form-check form-switch mt-2">
                                    <input asp-for="RemoveFeaturedImage" class="form-check-input" data-featured-remove />
                                    <label class="form-check-label" asp-for="RemoveFeaturedImage"></label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <input asp-for="FeaturedImagePath" type="hidden" data-featured-path />
                    <span asp-validation-for="FeaturedImage" class="text-danger"></span>
                </div>
                <div class="mb-3">
                    <label asp-for="CategoryId" class="form-label"></label>
                    <select asp-for="CategoryId" class="form-select" asp-items="categoryOptions">
                        <option value="" selected="@(Model.CategoryId is null ? "selected" : null)">یک دسته‌بندی انتخاب کنید</option>
                    </select>
                    <span asp-validation-for="CategoryId" class="text-danger"></span>
                </div>
                <div class="mb-3">
                    <label asp-for="AuthorId" class="form-label"></label>
                    <select asp-for="AuthorId"
                            class="form-select"
                            asp-items="authorOptions"
                            data-author-select
                            data-author-source="@Url.Action("AuthorOptions")">
                        <option value=""
                                data-placeholder="true"
                                selected="@(Model.AuthorId is null ? "selected" : null)">یک نویسنده انتخاب کنید</option>
                    </select>
                    <div class="form-text text-warning d-none" data-author-empty>
                        هنوز نویسنده فعالی ثبت نشده است. از بخش مدیریت نویسندگان یک نویسنده فعال ایجاد کنید.
                    </div>
                    <div class="form-text text-danger d-none" data-author-error>
                        امکان بارگذاری فهرست نویسندگان وجود ندارد. لطفاً صفحه را بازآوری یا بعداً تلاش کنید.
                    </div>
                    <span asp-validation-for="AuthorId" class="text-danger"></span>
                </div>
                <div class="mb-3">
                    <label asp-for="ReadingTimeMinutes" class="form-label"></label>
                    <input asp-for="ReadingTimeMinutes" class="form-control" type="number" min="1" max="600" />
                    <span asp-validation-for="ReadingTimeMinutes" class="text-danger"></span>
                </div>
                <div class="mb-3">
                    <label asp-for="Status" class="form-label"></label>
                    <select asp-for="Status" class="form-select" asp-items="statusOptions"></select>
                </div>
                <div class="mb-3" data-publish-picker>
                    <label class="form-label" for="publishDateInput">تاریخ انتشار</label>
                    <div class="publish-scheduler">
                        <div class="jalali-picker publish-scheduler__date" data-jalali-picker>
                            <div class="jalali-picker__controls">
                                <input type="text"
                                       id="publishDateInput"
                                       class="form-control"
                                       placeholder="انتخاب تاریخ"
                                       value="@publishedDisplay"
                                       data-jalali-input
                                       data-jdp
                                       data-jdp-only-date
                                       data-jdp-init-date="@publishedJalaliInit"
                                       autocomplete="off"
                                       dir="ltr" />
                            </div>
                            <input asp-for="PublishedAtPersian" type="hidden" data-jalali-target />
                        </div>
                        <div class="publish-scheduler__time">
                            <input type="time"
                                   class="form-control"
                                   placeholder="ساعت"
                                   aria-label="ساعت انتشار"
                                   value="@publishedTimeValue"
                                   data-publish-time
                                   dir="ltr"
                                   step="60" />
                        </div>
                    </div>
                    <input asp-for="PublishedAtTime" type="hidden" data-publish-time-hidden />
                    <input asp-for="PublishedAt"
                           type="hidden"
                           value="@publishedIsoValue"
                           data-publish-iso />
                    <div class="form-text">تاریخ را به‌صورت شمسی انتخاب کنید تا هنگام ثبت، به میلادی تبدیل شود. برای انتشار فوری فیلدها را خالی بگذارید.</div>
                    <span asp-validation-for="PublishedAt" class="text-danger"></span>
                </div>
                <div class="mb-3">
                    <label asp-for="SeoTitle" class="form-label"></label>
                    <input asp-for="SeoTitle" class="form-control" placeholder="عنوان سئو" />
                    <span asp-validation-for="SeoTitle" class="text-danger"></span>
                </div>
                <div class="mb-3">
                    <label asp-for="SeoDescription" class="form-label"></label>
                    <textarea asp-for="SeoDescription" class="form-control" rows="2" placeholder="توضیحات متا"></textarea>
                    <span asp-validation-for="SeoDescription" class="text-danger"></span>
                </div>
                <div class="mb-3">
                    <label asp-for="SeoKeywords" class="form-label"></label>
                    <input asp-for="SeoKeywords" class="form-control" placeholder="کلمات کلیدی با ویرگول" />
                    <span asp-validation-for="SeoKeywords" class="text-danger"></span>
                </div>
                <div class="mb-3">
                    <label asp-for="SeoSlug" class="form-label"></label>
                    <input asp-for="SeoSlug" class="form-control" placeholder="/blog/your-slug" />
                    <span asp-validation-for="SeoSlug" class="text-danger"></span>
                </div>
                <div class="mb-3">
                    <label asp-for="Robots" class="form-label"></label>
                    <select asp-for="Robots" class="form-select" asp-items="Model.Selections?.RobotsOptions"></select>
                    <span asp-validation-for="Robots" class="text-danger"></span>
                </div>
                <div class="mb-3">
                    <label asp-for="Tags" class="form-label"></label>
                    <input asp-for="Tags" class="form-control" placeholder="برچسب‌ها را با ویرگول یا اینتر جدا کنید" data-tag-input />
                    <div class="form-text">حداکثر ۵۰ کاراکتر برای هر برچسب. برای افزودن چند برچسب از ویرگول (,) یا اینتر استفاده کنید.</div>
                    <div class="blog-tag-preview @(Model.TagItems?.Count > 0 ? string.Empty : "blog-tag-preview--empty")" data-tag-preview>
                        @foreach (var tag in Model.TagItems ?? Array.Empty<string>())
                        {
                            <span class="blog-tag-preview__item">@tag</span>
                        }
                    </div>
                    <span asp-validation-for="Tags" class="text-danger"></span>
                </div>
            </div>
        </div>
    </div>
    <div class="card-footer d-flex justify-content-between">
        <a class="btn btn-outline-secondary" asp-area="Admin" asp-controller="Blog" asp-action="Index">بازگشت</a>
        <button type="submit" class="btn btn-primary">
            @if (isEdit)
            {
                <span><i class="bi bi-save me-1"></i>ذخیره تغییرات</span>
            }
            else
            {
                <span><i class="bi bi-check2-circle me-1"></i>ایجاد بلاگ</span>
            }
        </button>
    </div>
</form>

@section Scripts {
    @{ await Html.RenderPartialAsync("_ValidationScriptsPartial"); }
    <script src="~/plugins/jalalidatepicker/js/jalalidatepicker.min.js"></script>
    <script src="~/js/admin/rich-editor.js" asp-append-version="true"></script>
    <script src="~/js/admin/blog-form.js" asp-append-version="true"></script>
}
