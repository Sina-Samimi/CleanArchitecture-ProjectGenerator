@using LogTableRenameTest.WebSite.Areas.Admin.Models
@using LogTableRenameTest.SharedKernel.Extensions
@model FinancialReportsViewModel
@{
    var summary = Model.Summary;
    var dailySales = Model.DailySales?.ToList() ?? new List<DailySalesViewModel>();
    var transactionStatusSummary = Model.TransactionStatusSummary?.ToList() ?? new List<TransactionStatusSummaryViewModel>();
    var paymentMethodSummary = Model.PaymentMethodSummary?.ToList() ?? new List<PaymentMethodSummaryViewModel>();
    var invoiceStatusSummary = Model.InvoiceStatusSummary?.ToList() ?? new List<InvoiceStatusSummaryViewModel>();
    var monthlyRevenue = Model.MonthlyRevenue?.ToList() ?? new List<MonthlyRevenueViewModel>();
    
    string FormatCurrency(decimal amount) => amount.ToString("N0");
    string FormatDate(DateOnly date) => date.ToDateTime(TimeOnly.MinValue).ToPersianDateString();
}

@section Head {
    <link rel="stylesheet" href="~/css/admin/financial-reports.css" asp-append-version="true" />
}

@section Breadcrumb {
    <li class="breadcrumb-item"><a asp-area="Admin" asp-controller="Dashboard" asp-action="Index">داشبورد</a></li>
    <li class="breadcrumb-item active" aria-current="page">@ViewData["Title"]</li>
}

@await Html.PartialAsync("_StatusMessage")

<!-- Summary Cards -->
<div class="row g-4 mb-4">
    <div class="col-md-3">
        <div class="card shadow-sm border-0">
            <div class="card-body text-center">
                <div class="display-4 text-primary mb-2">@summary.TotalInvoices.ToString("N0")</div>
                <div class="text-muted">کل فاکتورها</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card shadow-sm border-0">
            <div class="card-body text-center">
                <div class="display-4 text-success mb-2">@FormatCurrency(summary.TotalRevenue)</div>
                <div class="text-muted">کل درآمد</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card shadow-sm border-0">
            <div class="card-body text-center">
                <div class="display-4 text-info mb-2">@FormatCurrency(summary.TotalPaidAmount)</div>
                <div class="text-muted">مبلغ پرداخت شده</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card shadow-sm border-0">
            <div class="card-body text-center">
                <div class="display-4 text-warning mb-2">@FormatCurrency(summary.TotalOutstandingAmount)</div>
                <div class="text-muted">مبلغ باقیمانده</div>
            </div>
        </div>
    </div>
</div>

<!-- Transaction Statistics -->
<div class="row g-4 mb-4">
    <div class="col-md-4">
        <div class="card shadow-sm border-0">
            <div class="card-body text-center">
                <div class="display-5 text-success mb-2">@summary.SuccessfulTransactions.ToString("N0")</div>
                <div class="text-muted">تراکنش‌های موفق</div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card shadow-sm border-0">
            <div class="card-body text-center">
                <div class="display-5 text-danger mb-2">@summary.FailedTransactions.ToString("N0")</div>
                <div class="text-muted">تراکنش‌های ناموفق</div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card shadow-sm border-0">
            <div class="card-body text-center">
                <div class="display-5 text-warning mb-2">@summary.PendingTransactions.ToString("N0")</div>
                <div class="text-muted">تراکنش‌های در انتظار</div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row g-4 mb-4">
    <!-- Daily Sales Chart -->
    <div class="col-lg-6">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-white">
                <h5 class="mb-0">فروش روزانه</h5>
            </div>
            <div class="card-body">
                <canvas id="dailySalesChart" height="300"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Monthly Revenue Chart -->
    <div class="col-lg-6">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-white">
                <h5 class="mb-0">درآمد ماهانه</h5>
            </div>
            <div class="card-body">
                <canvas id="monthlyRevenueChart" height="300"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Transaction Status Chart -->
<div class="row g-4 mb-4">
    <div class="col-lg-6">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-white">
                <h5 class="mb-0">وضعیت تراکنش‌ها</h5>
            </div>
            <div class="card-body">
                <canvas id="transactionStatusChart" height="300"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Payment Method Chart -->
    <div class="col-lg-6">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-white">
                <h5 class="mb-0">روش‌های پرداخت</h5>
            </div>
            <div class="card-body">
                <canvas id="paymentMethodChart" height="300"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Tables Row -->
<div class="row g-4 mb-4">
    <!-- Transaction Status Summary Table -->
    <div class="col-lg-6">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-white">
                <h5 class="mb-0">خلاصه وضعیت تراکنش‌ها</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>وضعیت</th>
                                <th>تعداد</th>
                                <th>مبلغ کل</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in transactionStatusSummary)
                            {
                                <tr>
                                    <td>@item.StatusDisplay</td>
                                    <td>@item.Count.ToString("N0")</td>
                                    <td>@FormatCurrency(item.TotalAmount)</td>
                                </tr>
                            }
                            @if (!transactionStatusSummary.Any())
                            {
                                <tr>
                                    <td colspan="3" class="text-center text-muted">داده‌ای وجود ندارد</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Invoice Status Summary Table -->
    <div class="col-lg-6">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-white">
                <h5 class="mb-0">خلاصه وضعیت فاکتورها</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>وضعیت</th>
                                <th>تعداد</th>
                                <th>مبلغ کل</th>
                                <th>میانگین</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in invoiceStatusSummary)
                            {
                                <tr>
                                    <td>@item.StatusDisplay</td>
                                    <td>@item.Count.ToString("N0")</td>
                                    <td>@FormatCurrency(item.TotalAmount)</td>
                                    <td>@FormatCurrency(item.AverageAmount)</td>
                                </tr>
                            }
                            @if (!invoiceStatusSummary.Any())
                            {
                                <tr>
                                    <td colspan="4" class="text-center text-muted">داده‌ای وجود ندارد</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Payment Method Summary Table -->
<div class="row g-4 mb-4">
    <div class="col-12">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-white">
                <h5 class="mb-0">خلاصه روش‌های پرداخت</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>روش پرداخت</th>
                                <th>تعداد تراکنش</th>
                                <th>موفق</th>
                                <th>ناموفق</th>
                                <th>نرخ موفقیت</th>
                                <th>مبلغ کل</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in paymentMethodSummary)
                            {
                                <tr>
                                    <td>@item.MethodDisplay</td>
                                    <td>@item.TransactionCount.ToString("N0")</td>
                                    <td><span class="badge bg-success">@item.SuccessfulCount.ToString("N0")</span></td>
                                    <td><span class="badge bg-danger">@item.FailedCount.ToString("N0")</span></td>
                                    <td>@item.SuccessRate.ToString("F1")%</td>
                                    <td>@FormatCurrency(item.TotalAmount)</td>
                                </tr>
                            }
                            @if (!paymentMethodSummary.Any())
                            {
                                <tr>
                                    <td colspan="6" class="text-center text-muted">داده‌ای وجود ندارد</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js" crossorigin="anonymous"></script>
    <script>
        // Daily Sales Chart
        const dailySalesData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(dailySales.Select(d => new { Date = FormatDate(d.Date), Revenue = d.TotalRevenue, Paid = d.TotalPaidAmount })));
        const dailySalesCtx = document.getElementById('dailySalesChart');
        if (dailySalesCtx) {
            new Chart(dailySalesCtx, {
                type: 'line',
                data: {
                    labels: dailySalesData.map(d => d.Date),
                    datasets: [{
                        label: 'کل درآمد',
                        data: dailySalesData.map(d => d.Revenue),
                        borderColor: 'rgb(54, 84, 255)',
                        backgroundColor: 'rgba(54, 84, 255, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'پرداخت شده',
                        data: dailySalesData.map(d => d.Paid),
                        borderColor: 'rgb(32, 214, 188)',
                        backgroundColor: 'rgba(32, 214, 188, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Monthly Revenue Chart
        const monthlyRevenueData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(monthlyRevenue.Select(m => new { Label = $"{m.MonthDisplay} {m.Year}", Revenue = m.TotalRevenue, Paid = m.TotalPaidAmount })));
        const monthlyRevenueCtx = document.getElementById('monthlyRevenueChart');
        if (monthlyRevenueCtx) {
            new Chart(monthlyRevenueCtx, {
                type: 'bar',
                data: {
                    labels: monthlyRevenueData.map(m => m.Label),
                    datasets: [{
                        label: 'کل درآمد',
                        data: monthlyRevenueData.map(m => m.Revenue),
                        backgroundColor: 'rgba(54, 84, 255, 0.8)'
                    }, {
                        label: 'پرداخت شده',
                        data: monthlyRevenueData.map(m => m.Paid),
                        backgroundColor: 'rgba(32, 214, 188, 0.8)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Transaction Status Chart
        const transactionStatusData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(transactionStatusSummary.Select(t => new { Label = t.StatusDisplay, Count = t.Count })));
        const transactionStatusCtx = document.getElementById('transactionStatusChart');
        if (transactionStatusCtx) {
            new Chart(transactionStatusCtx, {
                type: 'doughnut',
                data: {
                    labels: transactionStatusData.map(t => t.Label),
                    datasets: [{
                        data: transactionStatusData.map(t => t.Count),
                        backgroundColor: [
                            'rgba(54, 84, 255, 0.8)',
                            'rgba(32, 214, 188, 0.8)',
                            'rgba(255, 99, 132, 0.8)',
                            'rgba(255, 206, 86, 0.8)',
                            'rgba(153, 102, 255, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        }
                    }
                }
            });
        }

        // Payment Method Chart
        const paymentMethodData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(paymentMethodSummary.Select(p => new { Label = p.MethodDisplay, Amount = p.TotalAmount })));
        const paymentMethodCtx = document.getElementById('paymentMethodChart');
        if (paymentMethodCtx) {
            new Chart(paymentMethodCtx, {
                type: 'pie',
                data: {
                    labels: paymentMethodData.map(p => p.Label),
                    datasets: [{
                        data: paymentMethodData.map(p => p.Amount),
                        backgroundColor: [
                            'rgba(54, 84, 255, 0.8)',
                            'rgba(32, 214, 188, 0.8)',
                            'rgba(255, 99, 132, 0.8)',
                            'rgba(255, 206, 86, 0.8)',
                            'rgba(153, 102, 255, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        }
                    }
                }
            });
        }
    </script>
}

